<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="ohmysummer">
    <meta name="description" content="ohmysummer&#39;s personal website">
    <meta name="keywords" content="Perl6,Rakudo">

    <base href="http://ohmysummer.github.io/">
    <title>
  使用 Perl 6 连接 Kafka · 焉知非鱼
</title>

    <link rel="canonical" href="http://ohmysummer.github.io/post/2018-07-20-%E4%BD%BF%E7%94%A8perl6%E8%BF%9E%E6%8E%A5kafka/">

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Merriweather:300,700|Source+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.cd087ace86754b082dec94545567f8361cba42e84f8e15edbc4a9f6e52bd1f6a.css" integrity="sha256-zQh6zoZ1Swgt7JRUVWf4Nhy6QuhPjhXtvEqfblK9H2o=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://ohmysummer.github.io/css/style.css">
    

    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.49" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://ohmysummer.github.io/">
      焉知非鱼
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/post">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/categories">归档</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/page/about/">关于</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/tags">标签</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>使用 Perl 6 连接 Kafka</h1>
    </header>

    <p>有这样一个场景, 数据发送方将压缩文件读成字节数组后发往 Kafka, 然后第三方的 Kafka Client 从中读取字节数组解压缩, 每条 message 对应一个压缩文件, 每个压缩文件中包含 <code>_log.txt</code> 和 <code>_result.txt</code>。</p>

<p>Perl 6 可以从 Kafka 中读取消息并完成解析。</p>

<p>首先安装相关模块: <a href="https://github.com/mempko/PKafka">Pkafka</a> 用于和 Kafka 交互； <a href="https://github.com/frithnanth/perl6-Archive-Libarchive">Archive::Libarchive</a> 用于解压缩字节数组。 <a href="https://cro.services">Cro</a> 用于 HTTP 请求，<a href="https://github.com/perl6/DBIish">DBiish</a> 用于数据库读写。</p>

<pre><code>zef install Pkafka
zef install Archive::Libarchive
zef install Cro
zef install DBIish
</code></pre>

<p>代码片段如下:</p>

<pre><code class="language-perl6">use PKafka::Consumer;
use PKafka::Message;
use PKafka::Producer;
use Archive::Libarchive; 
use Archive::Libarchive::Constants;
use Cro::HTTP::Client;
use JSON::Fast;
use JSON::Path;
use DBIish;

sub MAIN ()
{
    my $brokers = &quot;127.0.0.1&quot;;
    my $test = PKafka::Consumer.new( topic=&gt;&quot;dc-diagnostic-report&quot;, brokers=&gt;$brokers);


    $test.messages.tap(-&gt; $msg
    {
        given $msg
        {
            when PKafka::Message
            {
                say &quot;got offset: {$msg.offset}&quot;;
                my $log = get-log($msg.payload);                  # 获取 log
                my ($taskid, $result) = get-result($msg.payload); # 获取 taskid 和 result
                my $json = request_ads($taskid,$log, $result);    # 获取 json
                my @values =  parse-json($json);                  # 解析 json, 提取出 sql value
                write2db(@values);                                # 写数据库
            }
            when PKafka::EOF
            {
                say &quot;Messages Consumed { $msg.total-consumed}&quot;;
            }
            when PKafka::Error
            {
                say &quot;Error {$msg.what}&quot;;
                $test.stop;
            }
        }
    });

    my $t1 = $test.consume-from-beginning(partition=&gt;0);

    await $t1;
}

#| 获取 log
sub get-log($payload) {
    my $a = Archive::Libarchive.new: operation =&gt; LibarchiveRead, file =&gt; $payload;
    my $log-content = $a.read-file-content(sub (Archive::Libarchive::Entry $e --&gt; Bool) { $e.pathname.ends-with('_log.txt')    });
    my $log = $log-content.decode('UTF8-C8'); # encoding: https://stackoverflow.com/questions/50674498/perl6-malformed-utf-8-causes-program-crash
    $a.close;
    return $log;
}

#| 获取 taskid 和 result
sub get-result($payload) {
    my $a = Archive::Libarchive.new: operation =&gt; LibarchiveRead, file =&gt; $payload;
    my $res-content = $a.read-file-content(sub (Archive::Libarchive::Entry $e --&gt; Bool) { $e.pathname.ends-with('_result.txt') });
    my $log-result = $res-content.decode('UTF8-C8');

    my $taskid = $log-result.lines[0].split(&quot;:&quot;)[1];  # 获取 taskid
    my $result = $log-result.lines[1].split(&quot;:&quot;)[1];  # 获取 result 的内容
    $a.close;
    return ($taskid, $result);
}

#| 请求 ADS
sub request_ads($taskid, $log, $result) {
    my $client = Cro::HTTP::Client.new: content-type =&gt; 'application/json';
    my %rds = taskId =&gt; $taskid, :$log, :$result;
    my $resp = await $client.post: 'http://10.0.201.46/bls_ads/diagResultReq', body =&gt; %rds;
    my $json = to-json await $resp.body-text;
    return $json;
}

#| 解析 JSON
sub parse-json($json) {
    my $oj     = from-json($json);
    my $path   = JSON::Path.new('$.data.dtcs.ecu[0]');
    my $ecuid  = $path.values($oj)[0].{'ecuid'};
    my $dtcnum = $path.values($oj)[0].{'dtcnum'};
    my $dtc    = $path.values($oj)[0].{'dtc'};
    
    my $taskid  = JSON::Path.new('$.taskId').values($oj)[0];
    my $vtype   = JSON::Path.new('$.vtype').values($oj)[0];
    my $ecunum  = JSON::Path.new('$.ecunum').values($oj)[0];
    my $funid   = JSON::Path.new('$.funid').values($oj)[0];

    return ($taskid, $vtype, $funid, $ecuid, $dtcnum, $dtc);
}

#| 写数据库
sub write2db(@values) {
    my $dbh = DBIish.connect(&quot;mysql&quot;, :database&lt;wmdtc&gt;, :host&lt;127.0.0.1&gt;, :user&lt;root&gt;, :password&lt;000608&gt;, :port&lt;6606&gt;, :RaiseError);
    my ($taskid, $vtype, $funid, $ecuid, $dtcnum, $dtc) = @values;
    my $sth = $dbh.prepare(q:to/STATEMENT/);
        insert into wm_ads_result (taskid, vtype, funid, ecuid, dtcnum, dtc)
        values (?,?,?,?,?,?) 
        ON DUPLICATE KEY 
        UPDATE vtype=?, funid=?, ecuid=?, dtcnum=?, dtc=?
    STATEMENT

    $sth.execute($taskid, $vtype, $funid, $ecuid, $dtcnum, $dtc,$vtype, $funid, $ecuid, $dtcnum, $dtc);

    $sth.finish;
    $dbh.dispose;
}
</code></pre>

<p>其中遇到的困难是如何在不将字节数组保存到本地磁盘的情况下，在内存中完成压缩包中各文件内容的读取。</p>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
      <p>ohmysummer ❤ Perl 6</p>
    
    
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
