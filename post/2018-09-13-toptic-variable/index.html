<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="ohmysummer">
    <meta name="description" content="ohmysummer&#39;s personal website">
    <meta name="keywords" content="Perl6,Rakudo">

    <base href="http://ohmysummer.github.io/">
    <title>
  Toptic Variable · 焉知非鱼
</title>

    <link rel="canonical" href="http://ohmysummer.github.io/post/2018-09-13-toptic-variable/">

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Merriweather:300,700|Source+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.cd087ace86754b082dec94545567f8361cba42e84f8e15edbc4a9f6e52bd1f6a.css" integrity="sha256-zQh6zoZ1Swgt7JRUVWf4Nhy6QuhPjhXtvEqfblK9H2o=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://ohmysummer.github.io/css/style.css">
    

    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.49" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://ohmysummer.github.io/">
      焉知非鱼
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/post">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/categories">归档</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/page/about/">关于</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/tags">标签</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>Toptic Variable</h1>
    </header>

    

<h1 id="变量">$_ 变量</h1>

<p><code>$_</code> 是主题变量。它是<strong>没有显式签名</strong>的块的默认参数，因此 <code>for @array {...}</code> 和 <code>given $var {...}</code> 这样的构造通过调用块绑定到 <code>$_</code>。</p>

<h2 id="for">for</h2>

<pre><code class="language-perl6">for &lt;a b c&gt; { say $_ }  # sets $_ to 'a', 'b' and 'c' in turn
say $_ for &lt;a b c&gt;;     # same, even though it's not a block
</code></pre>

<h2 id="given">given</h2>

<pre><code class="language-perl6">given 'a'   { say $_ }  # sets $_ to 'a'
say $_ given 'a';       # same, even though it's not a block
</code></pre>

<p>设置默认的主题变量可以省去很多打字：</p>

<pre><code class="language-perl6">for Date.new('2018-01-01') .. Date.new('2018-01-07') {
  printf(&quot;%04d%02d%02d%02d%02d%02d\n&quot;, .year, .month, .day, .hour, .minute, .second) given .DateTime
}

# 20180101000000
# 20180102000000
# 20180103000000
# 20180104000000
# 20180105000000
# 20180106000000
# 20180107000000
</code></pre>

<p>对象初始化：</p>

<pre><code class="language-perl6">class Employee {
    subset Salary         of Real where * &gt; 0;
    subset NonEmptyString of Str  where * ~~ /\S/; 

    has NonEmptyString $.name    is rw;
    has NonEmptyString $.surname is rw;
    has Salary         $.salary  is rw;

    method gist {
        return qq:to[END];
        Name:    {$.name}
        Surname: {$.surname}
        Salary:  {$.salary}
        END
    }
}
my $employee = Employee.new();

given $employee {
    .name    = 'Sally';
    .surname = 'Ride';
    .salary  = 200;
}

say $employee;
</code></pre>

<h2 id="regex">regex</h2>

<p>在方法上调用 <code>$_</code> 可以通过省略变量名来缩的更短：</p>

<pre><code class="language-perl6">.say;                   # same as $_.say
</code></pre>

<p><code>m/regex/</code> 和 <code>/regex/</code> 正则匹配 <code>$_</code> 而 <code>s/regex/subst/</code> 替换作用于 <code>$_</code>：</p>

<pre><code class="language-perl6">say &quot;Looking for strings with non-alphabetic characters...&quot;;
for &lt;ab:c d$e fgh ij*&gt; {
    .say if m/&lt;-alpha&gt;/;
}

# OUTPUT: «Looking for strings with non-alphabetic characters...
#          ab:c
#          d$e
#          ij*␤»
</code></pre>

<h2 id="with-without">with/without</h2>

<p>with 不引入块时也能设置 <code>$_</code> 主题变量：</p>

<pre><code class="language-perl6">say $_ with 42; # 42
.say with 42;   # 42
</code></pre>

<p>with/without 会把条件设置为 <code>$_</code>：</p>

<pre><code class="language-perl6"># The below code says &quot;Found a at 0&quot;
my $s = &quot;abc&quot;;
with   $s.index(&quot;a&quot;) { say &quot;Found a at $_&quot; }
orwith $s.index(&quot;b&quot;) { say &quot;Found b at $_&quot; }
orwith $s.index(&quot;c&quot;) { say &quot;Found c at $_&quot; }
else                 { say &quot;Didn't find a, b or c&quot; }
</code></pre>

<h2 id="when">when</h2>

<p><code>when</code> 语句使主题变量 <code>$_</code> 和所提供的表达式进行智能匹配，以使在指定匹配的时候能检查值、正则表达式和类型：</p>

<pre><code class="language-perl6">for 42, 43, &quot;foo&quot;, 44, &quot;bar&quot; {
    when Int { .say }
    when /:i ^Bar/ { .say }
    default  { say &quot;Not an Int or a Bar&quot; }
}
# OUTPUT: «42␤43␤Not an Int or a Bar␤44␤Bar␤»
</code></pre>

<pre><code class="language-shell">&gt; for ('Swift', 'PHP', 'Python', 'Perl')  { .say if  Str }
Nil
&gt; for ('Swift', 'PHP', 'Python', 'Perl')  { .say if  $_ ~~ Str }
Swift
PHP
Python
Perl

for ('Swift', 'PHP', 'Python', 'Perl')  { .say when Str }
Swift
PHP
Python
Perl
</code></pre>

<p>列表解析：</p>

<pre><code class="language-perl6">(.ord when /7$/ for 1..99)
</code></pre>

<h2 id="when-和-if">when 和 if</h2>

<p><code>when</code> 块类似于 <code>if</code> 块，并且其中一个或两个都可以在外部块中使用，它们也都具有“语句修饰符”形式。但是如何处理相同的外部块中的代码是有区别的：当执行 <code>when</code> 块时，控制被传递到封闭块并忽略后面的语句; 但是当执行 <code>if</code> 块时，执行以下语句。 （注意，还有其他方法可以修改其他部分中讨论的每个的默认行为。）以下示例应说明 <code>if</code> 或 <code>when</code> 块的默认行为，假设 <code>if</code> 或 <code>when</code> 块中不包含特殊退出或其他副作用语句：</p>

<pre><code class="language-perl6">{
    if X {...} # if X is true in boolean context, block is executed
    # following statements are executed regardless
}
{
    when X {...} # if X is true in boolean context, block is executed
                 # and control passes to the outer block
    # following statements are NOT executed
}
</code></pre>

<p>如果上面的 <code>if</code> 和 <code>when</code> 块出现在文件范围内，则在每种情况下都会执行以下语句。</p>

<p>有一个 <code>when</code> 有而 <code>if</code> 没有的功能：<code>when</code> 的布尔上下文测试默认为 <code>$_ ~~</code> 而 <code>if</code> 不是。这影响人们怎么在不带 <code>$_</code> 值的 <code>when</code> 块中使用 <code>X</code>
（在那种情况下， 它是 <code>Any</code>，并且 <code>Any</code> 和 <code>True</code> 智能匹配：<code>Any ~~ True</code> 产生 <code>True</code> ）。请看下面的例子：</p>

<pre><code class="language-perl6">{
    my $a = 1;
    my $b = True;
    when $a    { say 'a' }; # no output
    when so $a { say 'a' }  # a (in &quot;so $a&quot; 'so' coerces $a to Boolean context True
                            # which matches with Any)
    when $b    { say 'b' }; # no output (this statement won't be run)
}
</code></pre>

<p>最后，<code>when</code> 的语句修饰符形式不影响如下语句在另一个块内部或外部的执行：</p>

<pre><code class="language-perl6">say &quot;foo&quot; when X; # if X is true statement is executed
                  # following statements are not affected
</code></pre>

<h2 id="签名">签名</h2>

<p>块的<strong>默认签名</strong>是一个名为 <code>$_</code> 的位置参数：</p>

<pre><code class="language-perl6">my &amp;block =  { 'oi' };
&amp;block.signature.say; # (;; $_? is raw)
</code></pre>

<pre><code class="language-perl6">my class Employee {
   has Str $.name;
   has Rat $.wage;
}

my $boss     = Employee.new( name =&gt; &quot;Frank Myers&quot;     , wage =&gt; 6755.85 );
my $driver   = Employee.new( name =&gt; &quot;Aaron Fast&quot;      , wage =&gt; 2530.40 );
my $worker   = Employee.new( name =&gt; &quot;John Dude&quot;       , wage =&gt; 2200.00 );
my $salesman = Employee.new( name =&gt; &quot;Frank Mileeater&quot; , wage =&gt; 4590.12 );

my @team = $boss, $driver, $worker, $salesman;

say @team.sort({.wage} )».name;
.name.say for @team.sort: {.wage};
</code></pre>

<p>块里面会默认有一个 <code>$_</code>：</p>

<pre><code class="language-perl6">my $tiles := (&lt; T S R E A N D &gt;).Bag;
my $total := $tiles.total;

my @results = lazy '/usr/share/dict/SOWPODS'.IO.lines.grep: {
    .chars ≤ $total &amp;&amp;
    .substr(0, 1) ∈ $tiles &amp;&amp;
    .comb.Bag ⊆ $tiles
}

for @results -&gt; $word {
    say $word;
}

say &quot;\n&quot; ~ &quot;Found {@results.elems} words in {now - INIT now} seconds&quot;;
</code></pre>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
      <p>ohmysummer ❤ Perl 6</p>
    
    
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
