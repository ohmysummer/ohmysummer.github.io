<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº</title>
  <meta property="og:title" content="ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº" />
  <meta name="twitter:title" content="ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº" />
  <meta name="description" content="Building a Single Page Application with Cro">
  <meta property="og:description" content="Building a Single Page Application with Cro">
  <meta name="twitter:description" content="Building a Single Page Application with Cro">
  <meta name="author" content="ç„‰çŸ¥éé±¼"/>
  <link href='https://ohmysummer.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://ohmysummer.github.io/img/avatar-icon.jpg" />
  <meta name="twitter:image" content="https://ohmysummer.github.io/img/avatar-icon.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://ohmysummer.github.io/post/2018-08-02-%E4%BD%BF%E7%94%A8cro%E5%88%9B%E5%BB%BA%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Young For Perl 6" />

  <meta name="generator" content="Hugo 0.41" />
  <link rel="canonical" href="https://ohmysummer.github.io/post/2018-08-02-%E4%BD%BF%E7%94%A8cro%E5%88%9B%E5%BB%BA%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" />
  <link rel="alternate" href="https://ohmysummer.github.io/index.xml" type="application/rss+xml" title="Young For Perl 6">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://ohmysummer.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://ohmysummer.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://ohmysummer.github.io/css/codeblock.css" />



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'ohmycloudy', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://ohmysummer.github.io/">Young For Perl 6</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="åšå®¢" href="/">åšå®¢</a>
            </li>
          
        
          
            <li>
              <a title="å½’æ¡£" href="/categories">å½’æ¡£</a>
            </li>
          
        
          
            <li>
              <a title="å…³äº" href="/page/about/">å…³äº</a>
            </li>
          
        
          
            <li>
              <a title="æ ‡ç­¾" href="/tags">æ ‡ç­¾</a>
            </li>
          
        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">Search</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Young For Perl 6" href="https://ohmysummer.github.io/">
            <img class="avatar-img" src="https://ohmysummer.github.io/img/avatar-icon.jpg" alt="Young For Perl 6" />
          </a>
        
      </div>
    </div>

  </div>
</nav>



  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search Young For Perl 6</h4>
        </div>
        <div class="modal-body">
          <gcse:search></gcse:search>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº</h1>
                
                  
                    <h2 class="post-subheading">Building a Single Page Application with Cro</h2>
                  
                
                
                  <span class="post-meta">
  
  
  <i class="fa fa-calendar-o"></i>&nbsp; Posted on August 2, 2018
  
  
  &nbsp;|&nbsp;
  <i class="fa fa-clock-o"></i> 23 minutes (4749 words)
  
  
</span>

                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<h1 id="ä½¿ç”¨-cro-åˆ›å»ºå•é¡µåº”ç”¨-http-mi-cro-services-docs-intro-spa-with-cro"><a href="http://mi.cro.services/docs/intro/spa-with-cro">ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨</a></h1>

<p>æœ¬æ•™ç¨‹å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cro ä½œä¸ºåç«¯æ„å»ºç®€å•çš„å•é¡µåº”ç”¨ç¨‹åºã€‚å¯¹äºå‰ç«¯ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ webpackï¼ŒES6ï¼ŒReact å’Œ Reduxã€‚ä½ ä¸éœ€è¦äº‹å…ˆäº†è§£è¿™äº›ä¿¡æ¯ï¼Œä½†å¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­å¾ˆå¥½åœ°ä½¿ç”¨å®ƒä»¬ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥é˜…è¯»ã€‚</p>

<p><a href="https://github.com/croservices/sample-app-spa-react">ä»£ç </a>å¯ä»¥åœ¨è¿™é‡Œè·å–ã€‚åœ¨æ•™ç¨‹çš„å„ä¸ªé˜¶æ®µï¼Œæäº¤äº†å½“å‰çš„çŠ¶æ€ã€‚ä»“åº“å†å²è®°å½•ä¸æ•™ç¨‹å®Œå…¨åŒ¹é…ï¼Œå› æ­¤ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥è·å–å„æ­¥éª¤å˜æ›´çš„æ¦‚è¿°ï¼Œæˆ–è€…å¦‚æœä½ è¯•å›¾é€šè¿‡ä»å¤´å¼€å§‹æ„å»ºè¿™äº›ä¸œè¥¿ï¼Œå¯ä»¥çŸ¥é“ä½ é”™è¿‡äº†ä»€ä¹ˆã€‚</p>

<h2 id="ä½ éœ€è¦ä»€ä¹ˆ">ä½ éœ€è¦ä»€ä¹ˆ</h2>

<ul>
<li>è¦å®‰è£… Cro (è¯·å‚é˜…<a href="http://mi.cro.services/docs/intro/getstarted">æœ¬æŒ‡å—</a>è·å–ç›¸å…³å¸®åŠ©)<br /></li>
<li>è¦å®‰è£… <code>npm</code> (å³ Node.js çš„åŒ…ç®¡ç†å™¨, æˆ‘ä»¬è¦ç”¨å®ƒæ¥è·å–éœ€è¦çš„åŒ…æ¥æ„å»ºå‰ç«¯); åœ¨åŸºäº Debian çš„ Linux å‘è¡Œç‰ˆä¸Šï¼Œåªéœ€ <code>sudo apt install npm</code>ã€‚<br /></li>
</ul>

<h2 id="æˆ‘ä»¬è¦æ„å»ºä»€ä¹ˆ">æˆ‘ä»¬è¦æ„å»ºä»€ä¹ˆ</h2>

<p>æ‰€ä»¥æˆ‘ä»¬æ­£åœ¨ä¸¾åŠç¾é£ŸèŠ‚æˆ–è€…å•¤é…’èŠ‚ã€‚æˆ–è€…ä»»ä½•å¸¦æœ‰ä¸€å †æˆ‘ä»¬å¯ä»¥å°è¯•çš„ä¸œè¥¿çš„æ´»åŠ¨ã€‚ä½†æ˜¯&hellip;å°è¯•ä»€ä¹ˆï¼Ÿå¦‚æœæœ‰è¿™æ ·ä¸€äº›åº”ç”¨ç¨‹åºå°±å¥½äº†ï¼Œäººä»¬å¯ä»¥ç•™ä¸‹ä»–ä»¬å…³äºä»€ä¹ˆç«å’Œä»€ä¹ˆä¸ç«çš„æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å®æ—¶çœ‹åˆ°ä»–ä»¬ã€‚å¦‚æœåœ¨å»è¿‡çš„ä¸Šä¸€å±Šå•¤é…’èŠ‚ä¸Šæœ‰è¿‡è¿™æ ·çš„ä¸œè¥¿ï¼Œæˆ‘å¯èƒ½ä¼šå¹¸å…äºé‚£æ¯ç»¿èŒ¶å•¤é…’&hellip;&hellip;</p>

<p>æ‰€ä»¥, æˆ‘ä»¬ä¼šåˆ¶ä½œä¸€ä¸ªå•é¡µåº”ç”¨ç¨‹åºä»¥æ”¯æŒ:</p>

<ul>
<li>æäº¤æ–°çš„æç¤º (POST åˆ°åç«¯)<br /></li>
<li>ç°åœºå‘å¸ƒæœ€æ–°æç¤º (é€šè¿‡ç½‘ç»œå¥—æ¥å­—æä¾›)<br /></li>
<li>èƒ½å¤ŸåŒæ„æˆ–ä¸åŒæ„æŸæç¤º (ä¹Ÿæ˜¯ POST)</li>
<li>èƒ½å¤Ÿçœ‹åˆ°æŒ‰ç…§æœ€æ„‰å¿«åˆ°æœ€ä¸æ„‰å¿« (é€šè¿‡ GE Tè·å–) æ’åºçš„æç¤ºåˆ—è¡¨</li>
</ul>

<h2 id="stubbing-åç«¯">Stubbing åç«¯</h2>

<p>ç»™åº”ç”¨ç¨‹åºæƒ³ä¸€ä¸ªæœ‰åˆ›æ„çš„åç§°ã€‚æˆ‘å«å®ƒ &ldquo;tipsy&rdquo;ã€‚ç„¶åä½¿ç”¨ <code>cro stub</code> æ¥å­˜æ ¹ HTTP åº”ç”¨ç¨‹åºã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†è·³è¿‡ HTTPSï¼ˆä¹Ÿå°±æ˜¯HTTP/2.0ï¼‰ï¼Œä½†ä¼šåŒ…å« Web å¥—æ¥å­—æ”¯æŒã€‚</p>

<pre><code>$ cro stub http tipsy tipsy
Stubbing a HTTP Service 'tipsy' in 'tipsy'...

First, please provide a little more information.

Secure (HTTPS) (yes/no) [no]: n
Support HTTP/1.1 (yes/no) [yes]: y
Support HTTP/2.0 (yes/no) [no]: n
Support Web Sockets (yes/no) [no]: y
</code></pre>

<p>è¿™åˆ›å»ºäº†ä¸€ä¸ªå« <code>tipsy</code> çš„ç›®å½•ã€‚ç°åœ¨è®©æˆ‘ä»¬è¿›åˆ°è¿™ä¸ªç›®å½•ä¸­å¹¶æ£€æŸ¥å­˜æ ¹åç«¯è¿è¡Œ, ä½¿ç”¨ <code>cro run</code>:</p>

<pre><code>$ cro run
â–¶ Starting tipsy (tipsy)
ğŸ”Œ Endpoint HTTP will be at http://localhost:20000/
ğŸ““ tipsy Listening at http://localhost:20000
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>curl</code> æˆ–é€šè¿‡åœ¨æµè§ˆå™¨ä¸­è®¿é—®å®ƒæ¥æ£€æŸ¥å®ƒï¼š</p>

<pre><code>$ curl http://localhost:20000
&lt;h1&gt; tipsy &lt;/h1&gt;
</code></pre>

<p>æˆ‘å–œæ¬¢åœ¨å·¥ä½œæ—¶å®šæœŸæäº¤ã€‚å› æ­¤ï¼Œæˆ‘å°†åˆ›å»ºä¸€ä¸ª git ä»“åº“ï¼Œæ·»åŠ ä¸€ä¸ª <code>.gitignore</code> æ–‡ä»¶ (å¿½ç•¥ Perl 6 é¢„ç¼–è¯‘è¾“å‡º) å¹¶æäº¤ stubã€‚</p>

<pre><code>$ git init .
Initialized empty Git repository in /home/jnthn/dev/cro/tipsy/.git/
jnthn@lviv:~/dev/cro/tipsy$ echo '.precomp/' &gt; .gitignore
jnthn@lviv:~/dev/cro/tipsy$ git add .
jnthn@lviv:~/dev/cro/tipsy$ git commit -m &quot;Stub tipsy backend&quot;
[master (root-commit) ff1043a] Stub tipsy backend
 5 files changed, 99 insertions(+)
 create mode 100644 .cro.yml
 create mode 100644 .gitignore
 create mode 100644 META6.json
 create mode 100644 lib/Routes.pm6
 create mode 100644 service.p6
</code></pre>

<h2 id="æœåŠ¡é™æ€é¡µé¢">æœåŠ¡é™æ€é¡µé¢</h2>

<p>æˆ‘ä»¬ç°åœ¨å°†è°ƒæ•´æˆ‘ä»¬çš„ Cro stub åº”ç”¨ç¨‹åºä»¥æœåŠ¡ HTML é¡µé¢ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª <code>static</code> ç›®å½•ï¼Œå…¶ä¸­æ˜¯è¦æœåŠ¡çš„é™æ€å†…å®¹ã€‚</p>

<pre><code>mkdir static
</code></pre>

<p>åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬å°†æŠŠ <code>index.html</code> æ”¾åœ¨ä¸‹é¢çš„ä¸Šä¸‹æ–‡ä¸­ï¼š</p>

<pre><code class="language-html">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Tipsy&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Tipsy&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>ç„¶åï¼Œæˆ‘ä»¬ç¼–è¾‘ <code>lib/Routes.pm6</code> ä»¥ä½¿ <code>/</code> è·¯ç”±æœåŠ¡æ­¤æ–‡ä»¶ï¼š</p>

<pre><code class="language-perl6">get -&gt; {
    static 'static/index.html'
}
</code></pre>

<p>æˆ‘ä»¬ä¹‹å‰è¿è¡Œçš„ <code>cro run</code> åº”è¯¥ä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨æœåŠ¡ã€‚åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦è¢«æ­£è¢«æœåŠ¡ã€‚</p>

<h2 id="è®¾ç½®å‰ç«¯æ„å»ºå·¥å…·é“¾">è®¾ç½®å‰ç«¯æ„å»ºå·¥å…·é“¾</h2>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¾ç½®å‰ç«¯ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†å­˜å‚¨ä¸€ä¸ª <code>package.json</code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åŒ…å«æˆ‘ä»¬çš„å¼€å‘å’Œå‰ç«¯ JavaScript ä¾èµ–å…³ç³»ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>npm init</code> å¹¶æä¾›ä¸€äº›ç­”æ¡ˆï¼š</p>

<pre><code>$ npm init .
This utility will walk you through creating a package.json file.
It only covers the most common items, and tries to guess sensible defaults.

See `npm help json` for definitive documentation on these fields
and exactly what they do.

Use `npm install &lt;pkg&gt; --save` afterwards to install a package and
save it as a dependency in the package.json file.

Press ^C at any time to quit.
name: (tipsy) 
version: (1.0.0) 
description: Tipsy gives you tips at festivals
entry point: (index.js) 
test command: 
git repository: 
keywords: 
author: 
license: (ISC) 
About to write to /home/jnthn/dev/cro/tipsy/package.json:

{
  &quot;name&quot;: &quot;tipsy&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;Tipsy gives you tips at festivals&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;
}


Is this ok? (yes)
</code></pre>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å®‰è£… webpack å·¥å…·ä½œä¸ºå¼€å‘ä¾èµ–ï¼š</p>

<pre><code>npm install --save-dev webpack webpack-cli
</code></pre>

<p>åœ¨è¿è¡Œçš„æ—¶å€™ï¼šæˆ‘ä»¬æ¥è¯´è¯´ webpack æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿå®ƒä»¥å„ç§æ–¹å¼æä¾›å¸®åŠ©ï¼š</p>

<ul>
<li>å®ƒä¸ºæˆ‘ä»¬ä»ç°ä»£ JavaScriptï¼ˆå…·æœ‰è¯¸å¦‚æ¨¡å—å¯¼å…¥ï¼Œlambda è¡¨è¾¾å¼å’Œ <code>let</code> å˜é‡å£°æ˜ä¹‹ç±»çš„ä¾¿åˆ©åŠŸèƒ½ï¼‰ç¼–è¯‘æˆé€‚ç”¨äº Web æµè§ˆå™¨çš„ JavaScript ç‰ˆæœ¬<br /></li>
<li>å®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨ JavaScript æ¨¡å—ï¼Œä½¿ç”¨ <code>npm</code> åŒ…ç®¡ç†å™¨è¿›è¡Œç®¡ç†ï¼Œå¹¶å°†å®ƒä»¬è¿æ¥æˆä¸€ä¸ª JavaScript æ–‡ä»¶<br /></li>
<li>å®ƒä¹Ÿå¯ä»¥å¸®åŠ© CSS å’Œå›¾åƒèµ„äº§<br /></li>
</ul>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨ä»“åº“çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª <code>webpack.config.js</code>ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>

<pre><code class="language-js">const path = require('path');

module.exports = {
    entry: './frontend/index.js',
    output: {
        filename: 'bundle.js',
        path: path.resolve(__dirname, 'static/js')
    }
};
</code></pre>

<p>è¿™æ„å‘³ç€å®ƒå°†é‡‡ç”¨ <code>frontend/index.js</code> ä½œä¸ºæˆ‘ä»¬åº”ç”¨ç¨‹åºçš„ JavaScript å‰ç«¯éƒ¨åˆ†çš„æ ¹ï¼Œå¹¶éµå¾ªå®ƒçš„æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Œå¹¶å°†å®ƒä»¬æ„å»ºåˆ°ä¸€ä¸ªå°†å†™å…¥ <code>static/js/bundle.js</code> çš„åŒ…ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºè¿™äº›ä½ç½®ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¯¹è¾“å‡ºä½ç½®è¿›è¡Œå­˜æ ¹(stub); <code>.gitignore</code> æ—¢ä¼šå¿½ç•¥ç”Ÿæˆçš„è¾“å‡ºåˆä¼šç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆå› ä¸º git ä¸ä¼šè·Ÿè¸ªç©ºç›®å½•ï¼‰ã€‚</p>

<pre><code>$ mkdir static/js
$ echo '*' &gt; static/js/.gitignore
</code></pre>

<p>ä¸‹é¢, ç»™ <code>frontend/index.js</code> å ä¸ªå‘:</p>

<pre><code>$ mkdir frontend
$ echo 'document.write(&quot;Hello from JS&quot;)' &gt; frontend/index.js
</code></pre>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ–¹ä¾¿åœ°ä»æˆ‘ä»¬çš„æœ¬åœ°å®‰è£…ä¸­è¿è¡Œ webpackã€‚ä¸€ç§æ–¹æ³•æ˜¯ç¼–è¾‘ <code>package.json</code> å¹¶å‘ <code>scripts</code> éƒ¨åˆ†æ·»åŠ ä¸€é¡¹ï¼š</p>

<pre><code>&quot;scripts&quot;: {
    &quot;build&quot;: &quot;webpack&quot;,
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
</code></pre>

<p>ç°åœ¨å¯ä»¥ä½¿ç”¨ <code>npm run build</code> è¿è¡Œï¼š</p>

<pre><code>$ npm run build

&gt; tipsy@1.0.0 build /home/jnthn/dev/cro/tipsy
&gt; webpack

Hash: 142d15221600d8f7960f
Version: webpack 3.6.0
Time: 125ms
    Asset    Size  Chunks             Chunk Names
bundle.js  2.5 kB       0  [emitted]  main
   [0] ./frontend/index.js 32 bytes {0} [built]
</code></pre>

<h2 id="æœåŠ¡å’Œä½¿ç”¨-bundle">æœåŠ¡å’Œä½¿ç”¨ bundle</h2>

<p>æ¥ä¸‹æ¥ï¼Œç¼–è¾‘ <code>static/index.html</code>ï¼Œå¹¶åœ¨ <code>&lt;/body&gt;</code> é—­åˆæ ‡è®°ä¹‹å‰æ·»åŠ ï¼š</p>

<pre><code class="language-html">&lt;script src=&quot;js/bundle.js&quot;&gt;&lt;/script&gt;
</code></pre>

<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸º JavaScript æä¾›æœåŠ¡ã€‚ç¼–è¾‘ <code>lib/Routes.pm6</code> å¹¶æ·»åŠ ä¸€ä¸ªåƒè¿™æ ·çš„æ–°è·¯ç”±ï¼ˆè¿™å°†æœåŠ¡ <code>static/js</code> ä¸‹çš„ä»»ä½•ä¸œè¥¿ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦ï¼Œå¯ä»¥ä¸ºå°†æ¥çš„å¤šä¸ªåŒ…åšå¥½å‡†å¤‡ï¼‰ï¼š</p>

<pre><code class="language-perl6">get -&gt; 'js', *@path {
    static 'static/js', @path
}
</code></pre>

<p>åœ¨æµè§ˆå™¨ä¸­åˆ·æ–°ï¼Œé‚£ä¹ˆ <code>Hello from JS</code> åº”è¯¥å‡ºç°åœ¨é¡µé¢ä¸Šã€‚</p>

<p>æœ€åä½†å¹¶éæœ€ä¸é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å¿½ç•¥ <code>node_modules</code>ï¼Œç„¶åå¯ä»¥æäº¤å‰ç«¯å­˜æ ¹ï¼š</p>

<pre><code>$ echo 'node_modules/' &gt;&gt; .gitignore
$ git add .
$ git commit -m &quot;Stub JavaScript application&quot;
[master 199866c] Stub JavaScript application
 6 files changed, 40 insertions(+), 1 deletion(-)
 create mode 100644 frontend/index.js
 create mode 100644 package.json
 create mode 100644 static/index.html
 create mode 100644 webpack.config.js
</code></pre>

<h2 id="å¼€å§‹æ„å»ºåç«¯">å¼€å§‹æ„å»ºåç«¯</h2>

<p>ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå†…å­˜æ¨¡å‹ã€‚æœ‰å„ç§å„æ ·çš„æ–¹æ³•å¯ä»¥å°†å®ƒè€ƒè™‘åœ¨å†…ï¼Œä½†è¦è®°ä½çš„å…³é”®æ˜¯ Web åº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªå¹¶å‘ç³»ç»Ÿï¼Œè€Œ Cro è¯·æ±‚åœ¨çº¿ç¨‹æ± ä¸­å¤„ç†ã€‚è¿™æ„å‘³ç€å¯ä»¥åŒæ—¶å¤„ç†ä¸¤ä¸ªè¯·æ±‚ï¼</p>

<p>ä¸ºäº†å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ <code>OO::Monitors</code> æ¨¡å—ã€‚ç›‘è§†å™¨å°±åƒä¸€ä¸ªç±»ï¼Œä½†å®ƒå¼ºåˆ¶å®ƒçš„æ–¹æ³•äº’ç›¸æ’æ–¥ - ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯èƒ½åœ¨ç‰¹å®šå®ä¾‹çš„æ–¹æ³•å†…ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ³„éœ²æˆ‘ä»¬çš„å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚æœæˆ‘ä»¬å¿…é¡»è¿”å›å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™åˆ¶ä½œé˜²å¾¡å‰¯æœ¬ï¼‰ï¼Œç›‘è§†å¯¹è±¡å†…éƒ¨çš„çŠ¶æ€å°†å—åˆ°ä¿æŠ¤ã€‚</p>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°† <code>OO::Monitors</code> æ·»åŠ åˆ°æˆ‘ä»¬çš„ <code>META6.json</code> depends éƒ¨åˆ†ï¼Œä»¥è‡³äºæ–‡ä»¶çš„ä¸€éƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<pre><code>&quot;depends&quot;: [
    &quot;Cro::HTTP&quot;,
    &quot;Cro::WebSocket&quot;,
    &quot;OO::Monitors&quot;
  ],
</code></pre>

<p>ä¸ºäº†ç¡®ä¿ä½ çœŸçš„æœ‰è¿™ä¸ªæ¨¡å—å¯ç”¨ï¼Œå¦‚æœç¼ºå¤±, è¯·ä½¿ç”¨ <code>zef</code> å®‰è£…å®ƒ:</p>

<pre><code>$ zef install --deps-only .
</code></pre>

<p>æˆ‘ä»¬å°†æŠŠä¸šåŠ¡é€»è¾‘æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ¨¡å— <code>lib/Tipsy.pm6</code> ä¸­ï¼Œå¹¶åœ¨ <code>t/tipsy.t</code> ä¸­ä¸ºå®ƒå†™ä¸€äº›æµ‹è¯•ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡/åŸŸé€»è¾‘å­˜å‚¨ APIï¼š</p>

<pre><code class="language-perl6">use OO::Monitors;

class Tip {
    has Int $.id;
    has Str $.tip;
    has Int $.agreed;
    has Int $.disagreed;
}

monitor Tipsy {
    method add-tip(Str $tip --&gt; Nil) { ... }
    method agree(Int $tip-id --&gt; Nil) { ... }
    method disagree(Int $tip-id --&gt; Nil) { ... }
    method latest-tips(--&gt; Supply) { ... }
    method top-tips(--&gt; Supply) { ... }
}
</code></pre>

<p>åœ¨è¿™é‡Œï¼Œ<code>Tip</code> æ˜¯ä¸€ä¸ªä¸å˜çš„å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªæç¤ºä»¥åŠåŒæ„å’Œä¸åŒæ„çš„æ•°é‡ã€‚ <code>Tipsy</code> ç±»æœ‰å¾ˆå¤šæ–¹æ³•æ¥å®ç°å„ç§æ“ä½œã€‚å‰ä¸‰ä¸ªæ˜¯å¯å˜æ“ä½œã€‚æ¥ä¸‹æ¥çš„ <code>atest-tips</code> å°†æ˜¯ Tip å¯¹è±¡çš„ <code>Supply</code>ï¼Œæ¯æ¬¡æ·»åŠ æ–°æç¤ºæ—¶éƒ½ä¼šå‘å‡ºæç¤ºå¯¹è±¡ã€‚ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ï¼Œæˆ‘ä»¬å°†å§‹ç»ˆå‘å‡ºæœ€æ–°çš„ 50 ä¸ªæç¤ºã€‚ <code>top-tips</code> æ–¹æ³•è¿”å›ä¸€ä¸ª Supplyï¼Œæ¯å½“æ’åå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒå°†å‘å‡ºå‰ 50 ä¸ªæç¤ºçš„æ’åºåˆ—è¡¨ã€‚ä¸è¦è¯•å›¾è®°ä½æ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬ä¼šä¸€æ¬¡ä¸€ä¸ªåœ°å›åˆ°ä»–ä»¬èº«ä¸Šã€‚</p>

<p>æ¥ä¸‹æ¥æ˜¯è®©æˆ‘ä»¬çš„è·¯ç”±å¯ç”¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>Routes.pm6</code> ä¸­åˆ›å»ºå®ä¾‹ï¼Œä½†è¿™ä¼šè®©æˆ‘ä»¬å¾ˆéš¾åœ¨ç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘çš„æƒ…å†µä¸‹æµ‹è¯•æˆ‘ä»¬çš„è·¯ç”±ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ <code>Routes.pm6</code> ä¸­çš„ stub ä½œä¸ºå‚æ•°æ¥ä½¿ç”¨ä¸šåŠ¡é€»è¾‘å¯¹è±¡çš„å®ä¾‹ï¼š</p>

<pre><code class="language-perl6">use Cro::HTTP::Router;
use Cro::HTTP::Router::WebSocket;
use Tipsy;

sub routes(Tipsy $tipsy) is export {
    route {
        get -&gt; {
            static 'static/index.html'
        }
    ...
}
</code></pre>

<p>ç„¶åé€šè¿‡ä»¥ä¸‹æ–¹å¼å°†å…¶è®¾ç½®åœ¨ <code>service.p6</code> å…¥å£ç‚¹ï¼š</p>

<p>1.ä½¿ç”¨æ¨¡å— 2.åˆ¶ä½œä¸€ä¸ªå®ä¾‹</p>

<p><code>service.p6</code> æ–‡ä»¶æœ€ç»ˆä¼šçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>

<pre><code class="language-perl6">use Cro::HTTP::Log::File;
use Cro::HTTP::Server;
use Routes;
use Tipsy;

my $tipsy = Tipsy.new;
my $application = routes($tipsy);

my Cro::Service $http = Cro::HTTP::Server.new(
    http =&gt; &lt;1.1&gt;,
    host =&gt; %*ENV&lt;TIPSY_HOST&gt; ||
        die(&quot;Missing TIPSY_HOST in environment&quot;),
    port =&gt; %*ENV&lt;TIPSY_PORT&gt; ||
        die(&quot;Missing TIPSY_PORT in environment&quot;),
    :$application,
    after =&gt; [
        Cro::HTTP::Log::File.new(logs =&gt; $*OUT, errors =&gt; $*ERR)
    ]
);
$http.start;
say &quot;Listening at http://%*ENV&lt;TIPSY_HOST&gt;:%*ENV&lt;TIPSY_PORT&gt;&quot;;
react {
    whenever signal(SIGINT) {
        say &quot;Shutting down...&quot;;
        $http.stop;
        done;
    }
}
</code></pre>

<h2 id="æ·»åŠ æç¤ºå’Œæœ€è¿‘çš„æç¤º">æ·»åŠ æç¤ºå’Œæœ€è¿‘çš„æç¤º</h2>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç¼–å†™æµ‹è¯•ä»¥æ·»åŠ æç¤ºï¼Œå¹¶åœ¨æœ€æ–°æç¤ºä¸­çœ‹åˆ°å®ƒã€‚è¿™é‡Œæœ‰ <code>t/tipsy.t</code>ï¼š</p>

<pre><code class="language-perl6">use Tipsy;
use Test;

my $tipsy = Tipsy.new;
lives-ok { $tipsy.add-tip('The lamb kebabs are good!') },
    'Can add a tip';
lives-ok { $tipsy.add-tip('Not so keen on the fish burrito!') },
    'Can add another tip';
given $tipsy.latest-tips.head(2).list -&gt; @tips {
    is @tips[0].tip, 'Not so keen on the fish burrito!',
        'Correct first tip retrieved on initial tap of latest-tips';
    is @tips[1].tip, 'The lamb kebabs are good!',
        'Correct second tip retrieved on initial tap of latest-tips';
}

react {
    whenever $tipsy.latest-tips.skip(2).head(1) {
        is .tip, 'Try the vanilla stout for sure',
            'Get new tips emitted live';
    }
    $tipsy.add-tip('Try the vanilla stout for sure');
}

done-testing;
</code></pre>

<p>ç¬¬ä¸€éƒ¨åˆ†æµ‹è¯•æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸¤ä¸ªæç¤ºï¼Œå¦‚æœæˆ‘ä»¬ç‚¹å‡»æä¾›æœ€æ–°çš„æç¤ºï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šç«‹å³ç»™å‡ºè¿™ä¸¤ä¸ªæç¤ºã€‚ç¬¬äºŒéƒ¨åˆ†æ¶‰åŠæ›´å¤šï¼šå®ƒæ£€æŸ¥å¦‚æœæˆ‘ä»¬ç‚¹å‡»æœ€æ–°çš„æç¤ºSupplyï¼Œç„¶åæ·»åŠ ä¸€ä¸ªæ–°çš„æç¤ºï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿä¼šè¢«å‘ŠçŸ¥è¿™ä¸ªæ–°æç¤ºã€‚</p>

<p>ç°åœ¨è®©ä»–ä»¬é€šè¿‡ï¼è¿™æ˜¯ <code>monitor</code> ä¸­çš„å®ç°ï¼š</p>

<pre><code class="language-perl6">monitor Tipsy {
    has Int $!next-id = 1;
    has Tip %!tips-by-id{Int};
    has Supplier $!latest-tips = Supplier.new;

    method add-tip(Str $tip --&gt; Nil) {
        my $id = $!next-id++;
        my $new-tip = Tip.new(:$id, :$tip);
        %!tips-by-id{$id} = $new-tip;
        start $!latest-tips.emit($new-tip);
    }

    method latest-tips(--&gt; Supply) {
        my @latest-existing = %!tips-by-id.values.sort(-*.id).head(50);
        supply {
            whenever $!latest-tips {
                .emit;
            }
            .emit for @latest-existing;
        }
    }
    
    # The other unimplemented methods go here
}
</code></pre>

<p>æˆ‘ä»¬ä¿ç•™ä¸€ä¸ªIDçš„è®¡æ•°å™¨ï¼Œä¸ºæ¯ä¸ªæç¤ºåˆ†é…è‡ªå·±çš„å”¯ä¸€IDã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå“ˆå¸Œæ˜ å°„åˆ°Tipå¯¹è±¡çš„IDã€‚ç„¶åæˆ‘ä»¬æœ‰ä¸€ä¸ªä¾›åº”å•†ï¼Œå½“æœ‰æ–°çš„æç¤ºæ—¶ï¼Œæˆ‘ä»¬å°†ç”¨å®ƒæ¥é€šçŸ¥ä»»ä½•æ„Ÿå…´è¶£çš„å›¢ä½“ã€‚</p>

<p>æ·»åŠ æç¤ºæ–¹æ³•çš„å‰3è¡Œå¾ˆç®€å•ï¼Œæœ€åä¸€è¡Œæœ‰ç‚¹å¥½å¥‡ï¼šä¸ºä»€ä¹ˆè¦å¼€å§‹ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œä½¿ç”¨è€—ææ—¶ï¼Œå‘ä»¶äººæ”¯ä»˜åˆ†å‘æ¶ˆæ¯çš„è´¹ç”¨ï¼Œä½†æˆ‘ä»¬ä¸å¸Œæœ›å°†æ˜¾ç¤ºå™¨ - è¿™ä¼šäº’ç›¸æ’æ–¥ - ä¸æ‰€æœ‰è¿™äº›å·¥ä½œæŒ‚é’©ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¼€å§‹å¼‚æ­¥åˆ†æ´¾é€šçŸ¥ã€‚</p>

<p>æœ€æ–°æŠ€å·§çš„æ–¹æ³•ä¹Ÿéœ€è¦å°å¿ƒã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬ä»ç›‘è§†å™¨è¿”å›çš„å†…å®¹ä¸å—äº’æ–¥æ’é™¤çš„ä¿æŠ¤ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ä¾›åº”æ¨¡å—ä¹‹å¤–å¤åˆ¶æœ€æ–°çš„ç°æœ‰æŠ€å·§ï¼Œè€Œæ˜¾ç¤ºå™¨æ­£åœ¨ä¿æŠ¤ï¼…ï¼tips-by-idã€‚ç„¶åï¼Œå½“è¿”å›çš„ä¾›åº”å—è¢«æŒ–æ˜æ—¶ï¼Œæˆ‘ä»¬è®¢é˜…æœ€æ–°çš„æŠ€å·§ï¼Œç„¶åå‘å‡ºæ¯ä¸ªæœ€æ–°çš„ç°æœ‰æŠ€å·§ã€‚</p>

<p>éšç€è¿™äº›ï¼Œæˆ‘ä»¬çš„æµ‹è¯•é€šè¿‡ã€‚è¿›å±•ï¼</p>

<pre><code>$ git add .
$ git commit -m &quot;Implement first part of business logic&quot;
[master 6e352c6] Implement first part of business logic
 6 files changed, 70 insertions(+), 4 deletions(-)
 create mode 100644 lib/Tipsy.pm6
 create mode 100644 t/tipsy.t
</code></pre>

<h2 id="è®¾ç½®-reacts">è®¾ç½® Reacts</h2>

<p>ç°åœ¨æ˜¯æ—¶å€™å›åˆ°å‰ç«¯äº†ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Reactã€‚ React ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè™šæ‹Ÿçš„DOMï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡æ”¹å˜æ—¶é‡å»ºå®ƒã€‚ç„¶åå°†å…¶ä¸å½“å‰çœŸå®çš„ DOM è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶åº”ç”¨æ›´æ”¹ã€‚è¿™è®©æˆ‘ä»¬ä»¥æ›´å®ç”¨çš„é£æ ¼å·¥ä½œã€‚ React ç»„ä»¶æ˜¯ä½¿ç”¨ JSX ç¼–å†™çš„ï¼Œä¸€ç§åµŒå…¥åˆ° JavaScript ä¸­çš„ç±» XML è¯­æ³•ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç¼–è¯‘ã€‚ä»¥ä¸‹æ˜¯æ–°çš„å¼€å‘ä¾èµ–å…³ç³»ï¼š</p>

<pre><code>$ npm install --save-dev babel-loader babel-core babel-preset-es2015 babel-preset-react
</code></pre>

<p>æ¥ä¸‹æ¥, æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª <code>.babelrc</code> æ–‡ä»¶, å‡è®¾è¦ä½¿ç”¨è¿™ä¸ª react é¢„å…ˆè£…ç½® (Babel æ˜¯ç”¨äºå°†ç°ä»£ JavaScript è½¬æ¢æˆæµè§ˆå™¨å…¼å®¹çš„ Javascript çš„ä¸œè¥¿)ã€‚å®ƒåº”è¯¥åªåŒ…å«:</p>

<pre><code>{
  &quot;presets&quot; : [&quot;es2015&quot;,&quot;react&quot;]
}
</code></pre>

<p>æœ€å, <code>webpack.config.js</code> éœ€è¦æ›´æ–°æ‰èƒ½ä½¿ç”¨å®ƒã€‚æ›´æ”¹å, å®ƒçœ‹èµ·æ¥åº”è¯¥åƒä¸‹é¢è¿™æ ·:</p>

<pre><code>const path = require('path');

module.exports = {
    entry: './frontend/index.js',
    output: {
        filename: 'bundle.js',
        path: path.resolve(__dirname, 'static/js')
    },
    module : {
        rules : [
            {
                test: /\.js/,
                include: path.resolve(__dirname, 'frontend'),
                loader: 'babel-loader'
            }
        ]
    }
};
</code></pre>

<p>å°è¯• <code>npm run build</code>ã€‚å®ƒåº”è¯¥å­˜æ´»ä¸‹æ¥ï¼Œå°½ç®¡æˆ‘ä»¬è¿˜æ²¡æœ‰ä½¿ç”¨ä»»ä½•æ–°çš„ React æ”¯æŒã€‚</p>

<p>æ¥ä¸‹æ¥æ„å»ºå·¥å…·é“¾ï¼Œæ˜¯æ—¶å€™å®‰è£…æˆ‘ä»¬å°†ç”¨äºå‰ç«¯çš„ React æ¨¡å—ã€‚å¼€å§‹ï¼š</p>

<pre><code>$ npm install --save react react-dom
</code></pre>

<p>é€šè¿‡è¿™äº›ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–è¾‘æˆ‘ä»¬çš„ <code>index.js</code> æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<pre><code>import React from 'react';
import {render} from 'react-dom';

var App = () =&gt; &lt;p&gt;Hello React!&lt;/p&gt;;
render(&lt;App /&gt;, document.getElementById('app'));
And add a div tag with the ID app to our index.html:

&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Tipsy&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Tipsy&lt;/h1&gt;
    &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;
    &lt;script src=&quot;js/bundle.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>å†æ¬¡è¿è¡Œ <code>npm run build</code>, åˆ·æ–°, å®ƒåº”è¯¥ä¼šæ‰“å°å‡º Hello React!.</p>

<pre><code>$ git add .
$ git commit -m &quot;Setup react&quot;
[master 0ffa260] Setup react
 5 files changed, 27 insertions(+), 1 deletion(-)
 create mode 100644 .babelrc
</code></pre>

<h2 id="æ·»åŠ ä¸€äº›ç»„ä»¶">æ·»åŠ ä¸€äº›ç»„ä»¶</h2>

<p>Next, let&rsquo;s sketch out the UI a little more. Replace the existing App component with this:</p>

<pre><code>var SubmitTip = () =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Got a tip?&lt;/h2&gt;
        &lt;div&gt;
            &lt;textarea rows=&quot;2&quot; cols=&quot;100&quot; maxlength=&quot;200&quot; /&gt;
        &lt;/div&gt;
        &lt;input type=&quot;button&quot; value=&quot;Add Tip&quot; /&gt;
    &lt;/div&gt;
);

var LatestTips = () =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Latest Tips&lt;/h2&gt;
        TODO
    &lt;/div&gt;
);

var App = () =&gt; (
    &lt;div&gt;
        &lt;SubmitTip /&gt;
        &lt;LatestTips /&gt;
    &lt;/div&gt;
);
</code></pre>

<p>Another npm run build, refresh, and it should show something that looks a lot like one would expect from the UI. But how do we get data to populate the UI? And how do we do stuff when the button is clicked? For that, we&rsquo;ll bring in the final piece of the client side puzzle: Redux.</p>

<p>ReduxÂ§</p>

<p>There&rsquo;s a good tutorial on Redux on its site, and I won&rsquo;t try and repeat it all here, but I&rsquo;ll try to summarize what Redux does. React gives us a way to render a virtual DOM each time something changes. To make that useful, we need some kind of object containing the current state that should be rendered onto the UI. Redux is a container for that state, and gets us to organize changes to it using reducers. That is to say, we never really update state, we just produce a new one derived from the current one, plus an action.</p>

<p>First, let&rsquo;s add the redux and related dependencies.</p>

<pre><code>$ npm install --save redux redux-thunk react-redux
</code></pre>

<p>Next up, we need to define some actions. Actions correspond to state changes on the page. We&rsquo;ll create just two for now:</p>

<p>CHANGE_TIP_TEXT - when the text of the tip the user is typing changes
ADD_TIP - when the Add Tip button is pressed
In a frontend/actions.js file, we do this:</p>

<pre><code>export const CHANGE_TIP_TEXT = 'CHANGE_TIP_TEXT';
export const ADD_TIP = 'ADD_TIP';

export function changeTipText(text) {
    return { type: CHANGE_TIP_TEXT, text };
}
export function addTip() {
    return { type: ADD_TIP };
}
</code></pre>

<p>The constants are names of actions, and the functions are known as &ldquo;action creators&rdquo;: they create an object with a type property and, optionally, some data.</p>

<p>Next, we need a reducer. Reducers take current state, and calculate and return a new state. They never mutate the state and never do any side-effects (such as network I/O). They are pure calculation. Our state will, for now, be very simple: just the content of the text box.</p>

<p>Writing reducers is much more convenient when we have the upcoming spread operator in JavaScript; it&rsquo;s a prefix &hellip;, and works much like Perl 6&rsquo;s prefix | operator for flattening. Since we already have a build toolchain, we can add it by installing another syntax transform:</p>

<pre><code>npm install --save-dev babel-plugin-transform-object-rest-spread
</code></pre>

<p>And adding it to our .babelrc:</p>

<pre><code>{
    &quot;presets&quot; : [&quot;es2015&quot;,&quot;react&quot;],
    &quot;plugins&quot; : [&quot;transform-object-rest-spread&quot;]
}
</code></pre>

<p>With that done, here&rsquo;s our reducer, placed in frontend/reducer.js:</p>

<pre><code>import * as ActionTypes from './actions';

const initialState = {
    tipText: ''
};
export function tipsyReducer(state = initialState, action) {
    switch (action.type) {
        case ActionTypes.CHANGE_TIP_TEXT:
            return { ...state, tipText: action.text };
        case ActionTypes.ADD_TIP:
            return { ...state, tipText: '' };
        default:
            return state;
    }
}
</code></pre>

<p>Now it&rsquo;s time to wire it up to React. The overall flow will be:</p>

<ol>
<li>Something happens on the UI (text changed, add tip button pressed) 2. An action object is created 3. It&rsquo;s passed into the reducer, which produces a new state 4. The new state is turned into properties, which are then used to build up a React virtual DOM 5. React takes care of applying any updates to the real DOM, thus reflecting our changes</li>
</ol>

<p>Back in frontend/index.js, we&rsquo;ll import our actions and reducer, together with some bits from the redux and react-redux libraries:</p>

<pre><code>import { createStore } from 'redux';
import { Provider, connect } from 'react-redux';
import * as Actions from './actions';
import { tipsyReducer } from './reducer';
</code></pre>

<p>Next up, we&rsquo;ll create a Redux store, which is the thing that holds the latest version of the state produced by the reducer. We create it simply by passing our reducer to createStore:</p>

<pre><code>let store = createStore(tipsyReducer);
</code></pre>

<p>Next up, we need to map the state from the store into properties that will be available in our React components, and also produce some functions that will also be made available in those properties, and will dispatch actions.</p>

<pre><code>function mapProps(state) {
    return state;
}
function mapDispatch(dispatch) {
    return {
        onChangeTipText: text =&gt; dispatch(Actions.changeTipText(text)),
        onAddTip: text =&gt; dispatch(Actions.addTip())
    };
}
</code></pre>

<p>With those ready, we can complete the integration of Redux with React, which looks like this:</p>

<pre><code>let ConnectedApp = connect(mapProps, mapDispatch)(App);
render(
    &lt;Provider store={store}&gt;
        &lt;ConnectedApp /&gt;
    &lt;/Provider&gt;,
    document.getElementById('app'));
</code></pre>

<p>The connect function makes the properties from the state in the store available to the App React component, and wrapping it in Provider makes the state from the store available in order for that to happen.</p>

<p>Last but not least, we can update our components:</p>

<pre><code>var SubmitTip = props =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Got a tip?&lt;/h2&gt;
        &lt;div&gt;
            &lt;textarea rows=&quot;2&quot; cols=&quot;100&quot; maxLength=&quot;200&quot;
                value={props.tipText}
                onChange={e =&gt; props.onChangeTipText(e.target.value)} /&gt;
        &lt;/div&gt;
        &lt;input type=&quot;button&quot; value=&quot;Add Tip&quot; onClick={props.onAddTip} /&gt;
    &lt;/div&gt;
);

var App = props =&gt; (
    &lt;div&gt;
        &lt;SubmitTip tipText={props.tipText}
            onChangeTipText={props.onChangeTipText}
            onAddTip={props.onAddTip} /&gt;
        &lt;LatestTips /&gt;
    &lt;/div&gt;
);
</code></pre>

<p>After npm run build, and a refresh in the browser, we should notice that hitting the Add Tip button after typing will clear the text box. Our actions and reducer are running. Phew!</p>

<p>For completeness, here is the entire frontend/index.js at this stage:</p>

<pre><code>import React from 'react';
import { render } from 'react-dom';
import { createStore } from 'redux';
import { Provider, connect } from 'react-redux';
import * as Actions from './actions';
import { tipsyReducer } from './reducer';

var SubmitTip = props =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Got a tip?&lt;/h2&gt;
        &lt;div&gt;
            &lt;textarea rows=&quot;2&quot; cols=&quot;100&quot; maxLength=&quot;200&quot;
                value={props.tipText}
                onChange={e =&gt; props.onChangeTipText(e.target.value)} /&gt;
        &lt;/div&gt;
        &lt;input type=&quot;button&quot; value=&quot;Add Tip&quot; onClick={props.onAddTip} /&gt;
    &lt;/div&gt;
);

var LatestTips = () =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Latest Tips&lt;/h2&gt;
        TODO
    &lt;/div&gt;
);

var App = props =&gt; (
    &lt;div&gt;
        &lt;SubmitTip tipText={props.tipText}
            onChangeTipText={props.onChangeTipText}
            onAddTip={props.onAddTip} /&gt;
        &lt;LatestTips /&gt;
    &lt;/div&gt;
);

function mapProps(state) {
    return state;
}
function mapDispatch(dispatch) {
    return {
        onChangeTipText: text =&gt; dispatch(Actions.changeTipText(text)),
        onAddTip: text =&gt; dispatch(Actions.addTip())
    };
}

let store = createStore(tipsyReducer);
let ConnectedApp = connect(mapProps, mapDispatch)(App);
render(
    &lt;Provider store={store}&gt;
        &lt;ConnectedApp /&gt;
    &lt;/Provider&gt;,
    document.getElementById('app'));
</code></pre>

<p>It&rsquo;s commit time again.</p>

<pre><code>$ git add .
$ git commit -m &quot;Wire up Redux&quot;
[master 3478433] Wire up Redux
 5 files changed, 83 insertions(+), 7 deletions(-)
 create mode 100644 frontend/actions.js
 rewrite frontend/index.js (81%)
 create mode 100644 frontend/reducer.js
</code></pre>

<p>POSTing to the backendÂ§
Finally, it&rsquo;s time to get adding a tip in the frontend calling the backend! We&rsquo;ll need to do two things:</p>

<ol>
<li>Write a POST handler in the Cro backend 2. Find a way to have our Redux action result in a POST</li>
</ol>

<p>First for the Cro part. In lib/Routes.pm6 we add the following route implementation:</p>

<pre><code>post -&gt; 'tips' {
    request-body -&gt; (:$text) {
        $tipsy.add-tip($text);
        response.status = 204;
    }
}
</code></pre>

<p>Next up, the JavaScript part. The question is where to put the network bit? Our reducer should be pure. The answer is the redux-thunk module that we installed earlier, but didn&rsquo;t yet use. This allows us to write action creators that return a function. This function will be passed the dispatcher, and it can call it to dispatch actions. Typically, we will dispatch one action when an asynchronous operation starts, which we can use to indicate that on the UI, and a further one once it has completed, so we can again indicate that the operation completed in the UI.</p>

<p>First, let&rsquo;s setup redux-thunk, which is a piece of middleware. Back in frontend/index.js, add:</p>

<pre><code>import thunkMiddleware from 'redux-thunk';
</code></pre>

<p>And then change:</p>

<pre><code>import { createStore } from 'redux';
</code></pre>

<p>To also import applyMiddleware:</p>

<pre><code>import { createStore, applyMiddleware } from 'redux';
</code></pre>

<p>Finally, change:</p>

<pre><code>let store = createStore(tipsyReducer);
</code></pre>

<p>To apply the middleware also:</p>

<pre><code>let store = createStore(tipsyReducer, applyMiddleware(thunkMiddleware));
</code></pre>

<p>Next, in frontend/actions.js, we&rsquo;ll refactor the add tip action creator function to be a thunk action:</p>

<pre><code>export function addTip() {
    return dispatch =&gt; {
        dispatch({ type: ADD_TIP });
    };
}
</code></pre>

<p>Note that this doesn&rsquo;t yet change anything; build it and the behavior should be just the same. Now that we&rsquo;ve done this, however, we can see that it will be possible to do this dispatch in a callback after the network operation.</p>

<p>There&rsquo;s of course dozens of good ways to deal with asynchronous operations in JavaScript, and if you are seriously building single page applications I strongly recommend looking into using a promise library. There&rsquo;s also Redux middleware that will integrate with that. For now, we&rsquo;ll do the simplest possible thing: use jQuery and a callback. First, let&rsquo;s add jQuery as a dependency:</p>

<pre><code>$ npm install --save jquery
</code></pre>

<p>Then we&rsquo;ll import it in frontend/actions.js:</p>

<pre><code>import $ from 'jquery';
</code></pre>

<p>And do the POST to the backend:</p>

<pre><code>export function addTip() {
    return (dispatch, getState) =&gt; {
        $.ajax({
            url: '/tips',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ text: getState().tipText }),
            success: () =&gt; dispatch({ type: ADD_TIP })
        });
    };
}
</code></pre>

<p>Reload it, maybe open your browser&rsquo;s development tools (F12 usually), flip to the Network tab, and click Add Tip. All being well, you&rsquo;ll observe the request was made and it produced a 204 response. Alternatively, you may like to stop the cro run and instead do cro trace; type a message, click Add Tip again, and you should see the request body dumped in the trace output.</p>

<pre><code>...
65 63 74 69 6f 6e 3a 20 6b 65 65 70 2d 61 6c 69  ection: keep-ali
76 65 0d 0a 0d 0a 7b 22 74 65 78 74 22 3a 22 74  ve....{&quot;text&quot;:&quot;t
72 79 20 74 68 65 20 62 65 65 66 22 7d           ry the beef&quot;}
</code></pre>

<p>The latest tips websocketÂ§
There&rsquo;s a variety of ways that we could write up the websocket, but we&rsquo;ll use redux-websocket-action. This allows us to send Redux actions over the websocket to the client, which is neat (although, unfortunately, does mean we are coupling our backend to the use of this library in the frontend, which is worth some questioning).</p>

<p>First, let&rsquo;s install the library in the frontend:</p>

<pre><code>$ npm install --save redux-websocket-action
</code></pre>

<p>Over in index.js, we import it:</p>

<pre><code>import WSAction from 'redux-websocket-action';
</code></pre>

<p>And set it up, like this:</p>

<pre><code>let host = window.location.host;
let wsAction = new WSAction(store, 'ws://' + host + '/latest-tips', {
    retryCount:3,
    reconnectInterval: 3
});
wsAction.start();
</code></pre>

<p>Over in frontend/actions.js, we&rsquo;ll add one more action type (but no action creation function, as it will originate on the server):</p>

<pre><code>export const LATEST_TIP = 'LATEST_TIP';
</code></pre>

<p>Then we&rsquo;ll update our reducer, to prepend each incoming tip to a list of latest tips, so frontend/reducer.js ends up as:</p>

<pre><code>import * as ActionTypes from './actions';

const initialState = {
    tipText: '',
    latestTips: []
};
export function tipsyReducer(state = initialState, action) {
    switch (action.type) {
        case ActionTypes.CHANGE_TIP_TEXT:
            return { ...state, tipText: action.text };
        case ActionTypes.ADD_TIP:
            return { ...state, tipText: '' };
        case ActionTypes.LATEST_TIP: {
            let tip = { id: action.id, text: action.text };
            return {
                ...state,
                latestTips: [tip, ...state.latestTips]
            };
        }
        default:
            return state;
    }
}
</code></pre>

<p>And then update the React components in frontend/index.js to render the latest tips:</p>

<pre><code>var LatestTips = props =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Latest Tips&lt;/h2&gt;
        &lt;ul&gt;
        {props.tips.map(t =&gt; &lt;li key={t.id}&gt;{t.text}&lt;/li&gt;)}
        &lt;/ul&gt;
    &lt;/div&gt;
);

var App = props =&gt; (
    &lt;div&gt;
        &lt;SubmitTip tipText={props.tipText}
            onChangeTipText={props.onChangeTipText}
            onAddTip={props.onAddTip} /&gt;
        &lt;LatestTips tips={props.latestTips} /&gt;
    &lt;/div&gt;
);
</code></pre>

<p>App is updated simply to pass the tips to the LatestTips component. And with that, the client-side additions are done.</p>

<p>Now for the backend, which is just a single addition in Routes.pm6. We clear out the websocket stub that was generated for us, and replace it with code to take the latest-tips Supply from the Tipsy business logic object, turn the events into appropriate JSON, and emit them:</p>

<pre><code>get -&gt; 'latest-tips' {
    web-socket -&gt; $incoming {
        supply whenever $tipsy.latest-tips -&gt; $tip {
            emit to-json {
                WS_ACTION =&gt; True,
                action =&gt; {
                    type =&gt; 'LATEST_TIP',
                    id =&gt; $tip.id,
                    text =&gt; $tip.tip
                }
            }
        }
    }
}
</code></pre>

<p>The outer hash is the &ldquo;envelope&rdquo; for redux-websocket-action, which tells it to pay attention to the message and dispatch its action property as a Redux action.</p>

<p>Reload it in the browser. Add a tip. See it show up. Open a second tab with the application. You&rsquo;ll see it shows the first tip. Add a second tip. Flip back to the first tab, and you&rsquo;ll see that tip magically showed up there too. We&rsquo;re now successfully sharing out the tips over the web socket. Hurrah! That calls for a commit.</p>

<p>Agree and disagreeÂ§
We&rsquo;ve spent a lot of time setting up the client-side infrastructure. Now it&rsquo;s in place, however, adding further features is a far quicker process. Let&rsquo;s round off the tutorial by implementing the Agree/Disagree feature (links to let the user indicate agreement/disagreement with the tips), and showing the list of top tips.</p>

<p>Let&rsquo;s start out in the very backend, by writing tests for these new features in the business logic object. We&rsquo;ll add these tests to t/tipsy.t:</p>

<pre><code>given $tipsy.latest-tips.head(3).list -&gt; @tips {
    $tipsy.agree(@tips[0].id) for ^3;
    $tipsy.agree(@tips[1].id) for ^4;
    $tipsy.disagree(@tips[1].id) for ^10;
    $tipsy.agree(@tips[2].id) for ^2;
}
given $tipsy.top-tips.head(1).list[0] {
    is .[0].tip, 'Try the vanilla stout for sure',
        'Most agreeable tip first';
    is .[1].tip, 'The lamb kebabs are good!',
        'Next most agreeable tip second';
    is .[2].tip, 'Not so keen on the fish burrito!',
        'Least agreeable tip third';
}
throws-like { $tipsy.agree(99999) }, X::Tipsy::NoSuchId,
    'Correct exception on no such tip';
</code></pre>

<p>The first part just adds some agreement and disagreement on the tips (they are sorted latest first). Next, we use the top-tips Supply and grab the first thing it emits (or should emit, at least), which is the current ordering at the point we tap the Supply. It checks that ordering is correct. A final test checks that for unrecognized IDs, we throw an exception.</p>

<p>Here&rsquo;s the new exception type:</p>

<pre><code>class X::Tipsy::NoSuchId is Exception {
    has $.id;
    method message() { &quot;No tip with ID '$!id'&quot; }
}
</code></pre>

<p>Next up, we&rsquo;ll give the Tip class some methods that produce a new version of the Tip object with agreed or disagreed bumped one higher (we keep these instances immutable, since we share them outside of our monitor):</p>

<pre><code>class Tip {
    has Int $.id is required;
    has Str $.tip is required;
    has Int $.agreed = 0;
    has Int $.disagreed = 0;

    method agree() {
        self.clone(agreed =&gt; $!agreed + 1)
    }

    method disagree() {
        self.clone(disagreed =&gt; $!disagreed + 1)
    }
}
</code></pre>

<p>The agree and disagree methods are easy enough:</p>

<pre><code>method agree(Int $tip-id --&gt; Nil) {
    with %!tips-by-id{$tip-id} -&gt; $tip-ref is rw {
        $tip-ref .= agree;
    }
    else {
        X::Tipsy::NoSuchId.new(id =&gt; $tip-id).throw;
    }
}

method disagree(Int $tip-id --&gt; Nil) {
    with %!tips-by-id{$tip-id} -&gt; $tip-ref is rw {
        $tip-ref .= disagree;
    }
    else {
        X::Tipsy::NoSuchId.new(id =&gt; $tip-id).throw;
    }
}
</code></pre>

<p>Hm, actually that&rsquo;s quite a bit of similarity. Let&rsquo;s use a private method to factor it out:</p>

<pre><code>method agree(Int $tip-id --&gt; Nil) {
    self!with-tip: $tip-id, -&gt; $tip-ref is rw {
        $tip-ref .= agree;
    }
}

method disagree(Int $tip-id --&gt; Nil) {
    self!with-tip: $tip-id, -&gt; $tip-ref is rw {
        $tip-ref .= disagree;
    }
}   
        
method !with-tip(Int $tip-id, &amp;operation --&gt; Nil) {
    with %!tips-by-id{$tip-id} -&gt; $tip-ref is rw {
        operation($tip-ref)
    }
    else {
        X::Tipsy::NoSuchId.new(id =&gt; $tip-id).throw;
    }
}
</code></pre>

<p>Finally, here&rsquo;s our first attempt at the top-tips method:</p>

<pre><code>method top-tips(--&gt; Supply) { 
    my @top-tips = %!tips-by-id.values
        .sort({ .disagreed - .agreed })
        .head(50);
    supply {
        emit @top-tips;
    }
}
</code></pre>

<p>It passes the tests, and yet&hellip;something is missing. It&rsquo;s meant to emit an updated sorted list of tips every time there&rsquo;s either a new tip or a tip is agreed or disagreed with. Let&rsquo;s add some tests for that also:</p>

<pre><code>my $new-tip-id;
react {
    whenever $tipsy.top-tips.skip(1).head(1) {
        is .[0].tip, 'Try the vanilla stout for sure',
            'After adding a tip, correct order (1)';
        is .[1].tip, 'The lamb kebabs are good!',
            'After adding a tip, correct order (2)';
        is .[2].tip, 'The pau bahji is super spicy',
            'After adding a tip, correct order (3)';
        is .[3].tip, 'Not so keen on the fish burrito!',
            'After adding a tip, correct order (4)';
        $new-tip-id = .[2].id;
    }
    $tipsy.add-tip('The pau bahji is super spicy');
}
ok $new-tip-id, 'New tip ID seen in top sorted tips';

react {
    whenever $tipsy.top-tips.skip(5).head(1) {
        is .[0].tip, 'The pau bahji is super spicy',
            'After agrees, order updated';
    }
    $tipsy.agree($new-tip-id) for ^5;
}
</code></pre>

<p>To have this update, we need a Supplier that we can emit on to indicate a change to the agree/disagree counts.</p>

<p>has Supplier $!tip-change = Supplier.new;
And to emit on it (easy after the factoring out earlier):</p>

<pre><code>method !with-tip(Int $tip-id, &amp;operation --&gt; Nil) {
    with %!tips-by-id{$tip-id} -&gt; $tip-ref is rw {
        operation($tip-ref);
        start $!tip-change.emit($tip-ref&lt;&gt;);
    }
    else {
        X::Tipsy::NoSuchId.new(id =&gt; $tip-id).throw;
    }
}
</code></pre>

<p>Finally, to update the top-tips method. There&rsquo;s a few ways we could do this, but the easiest way to be sure we&rsquo;re safe is to make sure the Supply keeps its own local state, which it can protect (again, remember that since the supply block is returned from, and lives beyond, the method, it is not going to be protected by the monitor).</p>

<pre><code>method top-tips(--&gt; Supply) {
    my %initial-tips = %!tips-by-id;
    supply {
        my %current-tips = %initial-tips;
        sub emit-latest-sorted() {
            emit [%current-tips.values.sort({ .disagreed - .agreed }).head(50)]
        }
        whenever Supply.merge($!latest-tips.Supply, $!tip-change.Supply) {
            %current-tips{.id} = $_;
            emit-latest-sorted;
        }
        emit-latest-sorted;
    }
}
</code></pre>

<p>With that done, it&rsquo;s time to expose this functionality to the outside world by updating lib/Routes.pm6. Its job is to map the business logic onto HTTP. The only thing we need to watch out for is to turn the &ldquo;no such ID&rdquo; exceptions into the appropriate HTTP response, which is a 404 Not Found. Otherwise, we&rsquo;d send back 500 Internal Server Error, which is wrong because it&rsquo;s not the server&rsquo;s fault that the client sent some bogus ID. Here goes:</p>

<pre><code>post -&gt; 'tips', Int $id, 'agree' {
    $tipsy.agree($id);
    response.status = 204;
    CATCH {
        when X::Tipsy::NoSuchId {
            not-found;
        }
    }
}

post -&gt; 'tips', Int $id, 'disagree' {
    $tipsy.disagree($id);
    response.status = 204;
    CATCH {
        when X::Tipsy::NoSuchId {
            not-found;
        }
    }
}
</code></pre>

<p>The final step in the backend is to map the top tips out to another web socket:</p>

<pre><code>get -&gt; 'top-tips' {
    web-socket -&gt; $incoming {
        supply whenever $tipsy.top-tips -&gt; @tips {
            emit to-json {
                WS_ACTION =&gt; True,
                action =&gt; {
                    type =&gt; 'UPDATE_TOP_TIPS',
                    tips =&gt; [@tips.map: -&gt; $tip {
                        {
                            id =&gt; $tip.id,
                            text =&gt; $tip.tip,
                            agreed =&gt; $tip.agreed,
                            disagreed =&gt; $tip.disagreed
                        }
                    }]
                }
            }
        }
    }
}
</code></pre>

<p>Now for the frontend. In frontend/actions.js, we&rsquo;ll add three new action type constants:</p>

<pre><code>export const UPDATE_TOP_TIPS = 'UPDATE_TOP_TIPS';
export const AGREE = 'AGREE';
export const DISAGREE = 'DISAGREE';
And then two new action creators (UPDATE_TOP_TIPS doesn't need one, as it comes from the server):

export function agree(id) {
    return dispatch =&gt; {
        $.ajax({
            url: '/tips/' + id + '/agree',
            type: 'POST',
            success: () =&gt; dispatch({ type: AGREE, id })
        });
    };
}
export function disagree(id) {
    return dispatch =&gt; {
        $.ajax({
            url: '/tips/' + id + '/disagree',
            type: 'POST',
            success: () =&gt; dispatch({ type: DISAGREE, id })
        });
    };
}
</code></pre>

<p>In the reducer, we&rsquo;ll tweak the initial state to have an empty set of top tips:</p>

<pre><code>const initialState = {
    tipText: '',
    latestTips: [],
    topTips: []
};
</code></pre>

<p>And then add an extra case statement to handle the new update action (we don&rsquo;t need to do anything much on agree/disagree, though in a real application we&rsquo;d want to give some user feedback that their vote was counted):</p>

<pre><code>case ActionTypes.UPDATE_TOP_TIPS:
    return {
        ...state,
        topTips: action.tips
    };
</code></pre>

<p>Next we need to get the second web socket connected up. That&rsquo;s just a little refactor away in frontend/index.js:</p>

<pre><code>['latest-tips', 'top-tips'].forEach(endpoint =&gt; {
    let host = window.location.host;
    let wsAction = new WSAction(store, 'ws://' + host + '/' + endpoint, {
        retryCount:3,
        reconnectInterval: 3
    });
    wsAction.start();
});
</code></pre>

<p>Next, we&rsquo;ll update the dispatch to props map, to include our new agree and disagree actions:</p>

<pre><code>function mapDispatch(dispatch) {
    return {
        onChangeTipText: text =&gt; dispatch(Actions.changeTipText(text)),
        onAddTip: text =&gt; dispatch(Actions.addTip()),
        onAgree: id =&gt; dispatch(Actions.agree(id)),
        onDisagree: id =&gt; dispatch(Actions.disagree(id)),
    };
}
</code></pre>

<p>Next up, we&rsquo;ll factor out showing a tip to a component that we can reuse in both the latest tips and top tips, which includes links to agree or disagree:</p>

<pre><code>var Tip = props =&gt; (
    &lt;li&gt;
        {props.text} [&lt;a href=&quot;#&quot; onClick={() =&gt; props.onAgree(props.id)}&gt;Agree&lt;/a&gt;]
        [&lt;a href=&quot;#&quot; onClick={() =&gt; props.onDisagree(props.id)}&gt;Disagree&lt;/a&gt;]
    &lt;/li&gt;
);
</code></pre>

<p>And then showing a list of tips, with a heading:</p>

<pre><code>var TipList = props =&gt; (
    &lt;div&gt;
        &lt;h2&gt;{props.heading}&lt;/h2&gt;
        &lt;ul&gt;
        {props.tips.map(t =&gt; &lt;Tip key={t.id} {...props} {...t} /&gt;)}
        &lt;/ul&gt;
    &lt;/div&gt;
);
</code></pre>

<p>Finally, the App component becomes:</p>

<pre><code>var App = props =&gt; (
    &lt;div&gt;
        &lt;SubmitTip tipText={props.tipText}
            onChangeTipText={props.onChangeTipText}
            onAddTip={props.onAddTip} /&gt;
        &lt;TipList heading=&quot;Latest Tips&quot; tips={props.latestTips}
            onAgree={props.onAgree} onDisagree={props.onDisagree} /&gt;
        &lt;TipList heading=&quot;Top Tips&quot; tips={props.topTips}
            onAgree={props.onAgree} onDisagree={props.onDisagree} /&gt;
    &lt;/div&gt;
);
</code></pre>

<p>And there we have it. npm run build, refresh, and give it a spin. Clicking agree or disagree in either list ends up with the sort order in the Top Tips list changing to reflect the votes.</p>

<p>At last, we&rsquo;re done.</p>

<pre><code>$ git commit -m &quot;Add agree/disagree feature&quot; .
[master 5d792bc] Add agree/disagree feature
 6 files changed, 188 insertions(+), 18 deletions(-)
</code></pre>

<p>Summing upÂ§
In this tutorial we&rsquo;ve gone from zero to reactive single page application. The frontend is written in modern ES6 using React and Redux. The backend is in Perl 6, using Cro. They communicate using both HTTP and web sockets. And both declare their dependencies, so getting started for a new developer is just a case of:</p>

<pre><code>zef install --deps-only .
npm install .
npm run build
cro run
</code></pre>

<p>One again, the code is available with the commit history described during this tutorial.</p>


        
          <div class="blog-tags">
            
              <a href="https://ohmysummer.github.io//tags/cro/">cro</a>&nbsp;
            
          </div>
        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://ohmysummer.github.io/post/2018-07-20-%E4%BD%BF%E7%94%A8perl6%E8%BF%9E%E6%8E%A5kafka/" data-toggle="tooltip" data-placement="top" title="ä½¿ç”¨ Perl 6 è¿æ¥ Kafka">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://ohmysummer.github.io/post/2018-08-03-ping-pang-in-perl6/" data-toggle="tooltip" data-placement="top" title="Ping Pang in Perl6">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ohmysummer" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        
        
      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            
            <a href="https://ohmysummer.github.io/index.xml" title="RSS">
            
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://ohmysummer.github.io/">ç„‰çŸ¥éé±¼</a>
            
          

          <span style="color: red;">â¤</span>&nbsp;Perl 6
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.41</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://ohmysummer.github.io/js/main.js"></script>
<script src="https://ohmysummer.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="https://ohmysummer.github.io/js/load-photoswipe.js"></script>


<script>
  (function() {
    var cx = '009072066163920799339:qwme9vkotxk';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>





  </body>
</html>

