<!DOCTYPE html>
<html lang="zh" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº - Raku Programming</title>
  <meta name="description" content="Building a Single Page Application with Cro">
  <meta name="author" content="ç„‰çŸ¥éé±¼"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Raku Programming",
    
    "url": "https:\/\/ohmysummer.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/ohmysummer.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/ohmysummer.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/ohmysummer.github.io\/post\/2018-08-02-%E4%BD%BF%E7%94%A8cro%E5%88%9B%E5%BB%BA%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F\/",
          "name": "ä½¿ç”¨ cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "ç„‰çŸ¥éé±¼"
  },
  "headline": "ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº",
  "description" : "ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ æœ¬æ•™ç¨‹å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cro ä½œä¸ºåç«¯æ„å»ºç®€å•çš„å•é¡µåº”ç”¨ç¨‹åºã€‚å¯¹äºå‰ç«¯ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ webpackï¼ŒES6ï¼ŒReact å’Œ Reduxã€‚ä½ ä¸éœ€è¦äº‹å…ˆäº†è§£è¿™äº›ä¿¡æ¯ï¼Œä½†å¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­å¾ˆå¥½åœ°ä½¿ç”¨å®ƒä»¬ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥é˜…è¯»ã€‚",
  "inLanguage" : "zh",
  "wordCount":  3173 ,
  "datePublished" : "2018-08-02T22:54:18",
  "dateModified" : "2018-08-02T22:54:18",
  "image" : "https:\/\/ohmysummer.github.io\/img\/rakudo.png",
  "keywords" : [ "cro" ],
  "mainEntityOfPage" : "https:\/\/ohmysummer.github.io\/post\/2018-08-02-%E4%BD%BF%E7%94%A8cro%E5%88%9B%E5%BB%BA%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/ohmysummer.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/ohmysummer.github.io\/img\/rakudo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº" />
<meta property="og:description" content="Building a Single Page Application with Cro">
<meta property="og:image" content="https://ohmysummer.github.io/img/rakudo.png" />
<meta property="og:url" content="https://ohmysummer.github.io/post/2018-08-02-%E4%BD%BF%E7%94%A8cro%E5%88%9B%E5%BB%BA%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Raku Programming" />

  <meta name="twitter:title" content="ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº" />
  <meta name="twitter:description" content="Building a Single Page Application with Cro">
  <meta name="twitter:image" content="https://ohmysummer.github.io/img/rakudo.png" />
  <meta name="twitter:card" content="summary" />
  <link href='https://ohmysummer.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.63.2" />
  <link rel="alternate" href="https://ohmysummer.github.io/index.xml" type="application/rss+xml" title="Raku Programming"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://ohmysummer.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://ohmysummer.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://ohmysummer.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'ohmycloudy', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://ohmysummer.github.io/">Raku Programming</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="åšå®¢" href="/">åšå®¢</a>
            </li>
          
        
          
            <li>
              <a title="å½’æ¡£" href="/categories">å½’æ¡£</a>
            </li>
          
        
          
            <li>
              <a title="å…³äº" href="/page/about/">å…³äº</a>
            </li>
          
        
          
            <li>
              <a title="æ ‡ç­¾" href="/tags">æ ‡ç­¾</a>
            </li>
          
        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg"></span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Raku Programming" href="https://ohmysummer.github.io/">
            <img class="avatar-img" src="https://ohmysummer.github.io/img/rakudo.png" alt="Raku Programming" />
          </a>
        </div>
      </div>
    

  </div>
</nav>



  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body">
          <gcse:search></gcse:search>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal"></button>
        </div>
      </div>
    </div>
  </div>


    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨ç¨‹åº</h1>
              
              
              
                
                  <h2 class="post-subheading">Building a Single Page Application with Cro</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;15&nbsp;
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3173&nbsp;
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;ç„‰çŸ¥éé±¼
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h1 id="ä½¿ç”¨-cro-åˆ›å»ºå•é¡µåº”ç”¨httpmicroservicesdocsintrospa-with-cro"><a href="http://mi.cro.services/docs/intro/spa-with-cro">ä½¿ç”¨ Cro åˆ›å»ºå•é¡µåº”ç”¨</a></h1>
<p>æœ¬æ•™ç¨‹å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cro ä½œä¸ºåç«¯æ„å»ºç®€å•çš„å•é¡µåº”ç”¨ç¨‹åºã€‚å¯¹äºå‰ç«¯ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ webpackï¼ŒES6ï¼ŒReact å’Œ Reduxã€‚ä½ ä¸éœ€è¦äº‹å…ˆäº†è§£è¿™äº›ä¿¡æ¯ï¼Œä½†å¦‚æœæ‚¨æƒ³åœ¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­å¾ˆå¥½åœ°ä½¿ç”¨å®ƒä»¬ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥é˜…è¯»ã€‚</p>
<p><a href="https://github.com/croservices/sample-app-spa-react">ä»£ç </a>å¯ä»¥åœ¨è¿™é‡Œè·å–ã€‚åœ¨æ•™ç¨‹çš„å„ä¸ªé˜¶æ®µï¼Œæäº¤äº†å½“å‰çš„çŠ¶æ€ã€‚ä»“åº“å†å²è®°å½•ä¸æ•™ç¨‹å®Œå…¨åŒ¹é…ï¼Œå› æ­¤ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥è·å–å„æ­¥éª¤å˜æ›´çš„æ¦‚è¿°ï¼Œæˆ–è€…å¦‚æœä½ è¯•å›¾é€šè¿‡ä»å¤´å¼€å§‹æ„å»ºè¿™äº›ä¸œè¥¿ï¼Œå¯ä»¥çŸ¥é“ä½ é”™è¿‡äº†ä»€ä¹ˆã€‚</p>
<h2 id="ä½ éœ€è¦ä»€ä¹ˆ">ä½ éœ€è¦ä»€ä¹ˆ</h2>
<ul>
<li>è¦å®‰è£… Cro (è¯·å‚é˜…<a href="http://mi.cro.services/docs/intro/getstarted">æœ¬æŒ‡å—</a>è·å–ç›¸å…³å¸®åŠ©)</li>
<li>è¦å®‰è£… <code>npm</code> (å³ Node.js çš„åŒ…ç®¡ç†å™¨, æˆ‘ä»¬è¦ç”¨å®ƒæ¥è·å–éœ€è¦çš„åŒ…æ¥æ„å»ºå‰ç«¯); åœ¨åŸºäº Debian çš„ Linux å‘è¡Œç‰ˆä¸Šï¼Œåªéœ€ <code>sudo apt install npm</code>ã€‚</li>
</ul>
<h2 id="æˆ‘ä»¬è¦æ„å»ºä»€ä¹ˆ">æˆ‘ä»¬è¦æ„å»ºä»€ä¹ˆ</h2>
<p>æ‰€ä»¥æˆ‘ä»¬æ­£åœ¨ä¸¾åŠç¾é£ŸèŠ‚æˆ–è€…å•¤é…’èŠ‚ã€‚æˆ–è€…ä»»ä½•å¸¦æœ‰ä¸€å †æˆ‘ä»¬å¯ä»¥å°è¯•çš„ä¸œè¥¿çš„æ´»åŠ¨ã€‚ä½†æ˜¯&hellip;å°è¯•ä»€ä¹ˆï¼Ÿå¦‚æœæœ‰è¿™æ ·ä¸€äº›åº”ç”¨ç¨‹åºå°±å¥½äº†ï¼Œäººä»¬å¯ä»¥ç•™ä¸‹ä»–ä»¬å…³äºä»€ä¹ˆç«å’Œä»€ä¹ˆä¸ç«çš„æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å®æ—¶çœ‹åˆ°ä»–ä»¬ã€‚å¦‚æœåœ¨å»è¿‡çš„ä¸Šä¸€å±Šå•¤é…’èŠ‚ä¸Šæœ‰è¿‡è¿™æ ·çš„ä¸œè¥¿ï¼Œæˆ‘å¯èƒ½ä¼šå¹¸å…äºé‚£æ¯ç»¿èŒ¶å•¤é…’&hellip;&hellip;</p>
<p>æ‰€ä»¥, æˆ‘ä»¬ä¼šåˆ¶ä½œä¸€ä¸ªå•é¡µåº”ç”¨ç¨‹åºä»¥æ”¯æŒ:</p>
<ul>
<li>æäº¤æ–°çš„æç¤º (POST åˆ°åç«¯)</li>
<li>ç°åœºå‘å¸ƒæœ€æ–°æç¤º (é€šè¿‡ç½‘ç»œå¥—æ¥å­—æä¾›)</li>
<li>èƒ½å¤ŸåŒæ„æˆ–ä¸åŒæ„æŸæç¤º (ä¹Ÿæ˜¯ POST)</li>
<li>èƒ½å¤Ÿçœ‹åˆ°æŒ‰ç…§æœ€æ„‰å¿«åˆ°æœ€ä¸æ„‰å¿« (é€šè¿‡ GE Tè·å–) æ’åºçš„æç¤ºåˆ—è¡¨</li>
</ul>
<h2 id="stubbing-åç«¯">Stubbing åç«¯</h2>
<p>ç»™åº”ç”¨ç¨‹åºæƒ³ä¸€ä¸ªæœ‰åˆ›æ„çš„åç§°ã€‚æˆ‘å«å®ƒ &ldquo;tipsy&rdquo;ã€‚ç„¶åä½¿ç”¨ <code>cro stub</code> æ¥å­˜æ ¹ HTTP åº”ç”¨ç¨‹åºã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†è·³è¿‡ HTTPSï¼ˆä¹Ÿå°±æ˜¯HTTP/2.0ï¼‰ï¼Œä½†ä¼šåŒ…å« Web å¥—æ¥å­—æ”¯æŒã€‚</p>
<pre><code>$ cro stub http tipsy tipsy
Stubbing a HTTP Service 'tipsy' in 'tipsy'...

First, please provide a little more information.

Secure (HTTPS) (yes/no) [no]: n
Support HTTP/1.1 (yes/no) [yes]: y
Support HTTP/2.0 (yes/no) [no]: n
Support Web Sockets (yes/no) [no]: y
</code></pre><p>è¿™åˆ›å»ºäº†ä¸€ä¸ªå« <code>tipsy</code> çš„ç›®å½•ã€‚ç°åœ¨è®©æˆ‘ä»¬è¿›åˆ°è¿™ä¸ªç›®å½•ä¸­å¹¶æ£€æŸ¥å­˜æ ¹åç«¯è¿è¡Œ, ä½¿ç”¨ <code>cro run</code>:</p>
<pre><code>$ cro run
â–¶ Starting tipsy (tipsy)
ğŸ”Œ Endpoint HTTP will be at http://localhost:20000/
ğŸ““ tipsy Listening at http://localhost:20000
</code></pre><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>curl</code> æˆ–é€šè¿‡åœ¨æµè§ˆå™¨ä¸­è®¿é—®å®ƒæ¥æ£€æŸ¥å®ƒï¼š</p>
<pre><code>$ curl http://localhost:20000
&lt;h1&gt; tipsy &lt;/h1&gt;
</code></pre><p>æˆ‘å–œæ¬¢åœ¨å·¥ä½œæ—¶å®šæœŸæäº¤ã€‚å› æ­¤ï¼Œæˆ‘å°†åˆ›å»ºä¸€ä¸ª git ä»“åº“ï¼Œæ·»åŠ ä¸€ä¸ª <code>.gitignore</code> æ–‡ä»¶ (å¿½ç•¥ Raku é¢„ç¼–è¯‘è¾“å‡º) å¹¶æäº¤ stubã€‚</p>
<pre><code>$ git init .
Initialized empty Git repository in /home/jnthn/dev/cro/tipsy/.git/
jnthn@lviv:~/dev/cro/tipsy$ echo '.precomp/' &gt; .gitignore
jnthn@lviv:~/dev/cro/tipsy$ git add .
jnthn@lviv:~/dev/cro/tipsy$ git commit -m &quot;Stub tipsy backend&quot;
[master (root-commit) ff1043a] Stub tipsy backend
 5 files changed, 99 insertions(+)
 create mode 100644 .cro.yml
 create mode 100644 .gitignore
 create mode 100644 META6.json
 create mode 100644 lib/Routes.pm6
 create mode 100644 service.p6
</code></pre><h2 id="æœåŠ¡é™æ€é¡µé¢">æœåŠ¡é™æ€é¡µé¢</h2>
<p>æˆ‘ä»¬ç°åœ¨å°†è°ƒæ•´æˆ‘ä»¬çš„ Cro stub åº”ç”¨ç¨‹åºä»¥æœåŠ¡ HTML é¡µé¢ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª <code>static</code> ç›®å½•ï¼Œå…¶ä¸­æ˜¯è¦æœåŠ¡çš„é™æ€å†…å®¹ã€‚</p>
<pre><code>mkdir static
</code></pre><p>åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬å°†æŠŠ <code>index.html</code> æ”¾åœ¨ä¸‹é¢çš„ä¸Šä¸‹æ–‡ä¸­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">html</span><span class="p"></span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p"></span><span class="p">&gt;</span>Tipsy<span class="p">&lt;</span><span class="p">/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="p">/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p"></span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p"></span><span class="p">&gt;</span>Tipsy<span class="p">&lt;</span><span class="p">/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="p">/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="p">/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><p>ç„¶åï¼Œæˆ‘ä»¬ç¼–è¾‘ <code>lib/Routes.pm6</code> ä»¥ä½¿ <code>/</code> è·¯ç”±æœåŠ¡æ­¤æ–‡ä»¶ï¼š</p>
<pre><code class="language-raku" data-lang="raku">get -&gt; {
    static 'static/index.html'
}
</code></pre><p>æˆ‘ä»¬ä¹‹å‰è¿è¡Œçš„ <code>cro run</code> åº”è¯¥ä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨æœåŠ¡ã€‚åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦è¢«æ­£è¢«æœåŠ¡ã€‚</p>
<h2 id="è®¾ç½®å‰ç«¯æ„å»ºå·¥å…·é“¾">è®¾ç½®å‰ç«¯æ„å»ºå·¥å…·é“¾</h2>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¾ç½®å‰ç«¯ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†å­˜å‚¨ä¸€ä¸ª <code>package.json</code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åŒ…å«æˆ‘ä»¬çš„å¼€å‘å’Œå‰ç«¯ JavaScript ä¾èµ–å…³ç³»ã€‚æˆ‘ä»¬ä½¿ç”¨ <code>npm init</code> å¹¶æä¾›ä¸€äº›ç­”æ¡ˆï¼š</p>
<pre><code>$ npm init .
This utility will walk you through creating a package.json file.
It only covers the most common items, and tries to guess sensible defaults.

See `npm help json` for definitive documentation on these fields
and exactly what they do.

Use `npm install &lt;pkg&gt; --save` afterwards to install a package and
save it as a dependency in the package.json file.

Press ^C at any time to quit.
name: (tipsy) 
version: (1.0.0) 
description: Tipsy gives you tips at festivals
entry point: (index.js) 
test command: 
git repository: 
keywords: 
author: 
license: (ISC) 
About to write to /home/jnthn/dev/cro/tipsy/package.json:

{
  &quot;name&quot;: &quot;tipsy&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;Tipsy gives you tips at festivals&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;
}


Is this ok? (yes)
</code></pre><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å®‰è£… webpack å·¥å…·ä½œä¸ºå¼€å‘ä¾èµ–ï¼š</p>
<pre><code>npm install --save-dev webpack webpack-cli
</code></pre><p>åœ¨è¿è¡Œçš„æ—¶å€™ï¼šæˆ‘ä»¬æ¥è¯´è¯´ webpack æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿå®ƒä»¥å„ç§æ–¹å¼æä¾›å¸®åŠ©ï¼š</p>
<ul>
<li>å®ƒä¸ºæˆ‘ä»¬ä»ç°ä»£ JavaScriptï¼ˆå…·æœ‰è¯¸å¦‚æ¨¡å—å¯¼å…¥ï¼Œlambda è¡¨è¾¾å¼å’Œ <code>let</code> å˜é‡å£°æ˜ä¹‹ç±»çš„ä¾¿åˆ©åŠŸèƒ½ï¼‰ç¼–è¯‘æˆé€‚ç”¨äº Web æµè§ˆå™¨çš„ JavaScript ç‰ˆæœ¬</li>
<li>å®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨ JavaScript æ¨¡å—ï¼Œä½¿ç”¨ <code>npm</code> åŒ…ç®¡ç†å™¨è¿›è¡Œç®¡ç†ï¼Œå¹¶å°†å®ƒä»¬è¿æ¥æˆä¸€ä¸ª JavaScript æ–‡ä»¶</li>
<li>å®ƒä¹Ÿå¯ä»¥å¸®åŠ© CSS å’Œå›¾åƒèµ„äº§</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨ä»“åº“çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª <code>webpack.config.js</code>ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">entry</span><span class="o">:</span> <span class="s1">&#39;./frontend/index.js&#39;</span><span class="p">,</span>
    <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">filename</span><span class="o">:</span> <span class="s1">&#39;bundle.js&#39;</span><span class="p">,</span>
        <span class="nx">path</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;static/js&#39;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></div><p>è¿™æ„å‘³ç€å®ƒå°†é‡‡ç”¨ <code>frontend/index.js</code> ä½œä¸ºæˆ‘ä»¬åº”ç”¨ç¨‹åºçš„ JavaScript å‰ç«¯éƒ¨åˆ†çš„æ ¹ï¼Œå¹¶éµå¾ªå®ƒçš„æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Œå¹¶å°†å®ƒä»¬æ„å»ºåˆ°ä¸€ä¸ªå°†å†™å…¥ <code>static/js/bundle.js</code> çš„åŒ…ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºè¿™äº›ä½ç½®ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¯¹è¾“å‡ºä½ç½®è¿›è¡Œå­˜æ ¹(stub); <code>.gitignore</code> æ—¢ä¼šå¿½ç•¥ç”Ÿæˆçš„è¾“å‡ºåˆä¼šç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆå› ä¸º git ä¸ä¼šè·Ÿè¸ªç©ºç›®å½•ï¼‰ã€‚</p>
<pre><code>$ mkdir static/js
$ echo '*' &gt; static/js/.gitignore
</code></pre><p>ä¸‹é¢, ç»™ <code>frontend/index.js</code> å ä¸ªå‘:</p>
<pre><code>$ mkdir frontend
$ echo 'document.write(&quot;Hello from JS&quot;)' &gt; frontend/index.js
</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ–¹ä¾¿åœ°ä»æˆ‘ä»¬çš„æœ¬åœ°å®‰è£…ä¸­è¿è¡Œ webpackã€‚ä¸€ç§æ–¹æ³•æ˜¯ç¼–è¾‘ <code>package.json</code> å¹¶å‘ <code>scripts</code> éƒ¨åˆ†æ·»åŠ ä¸€é¡¹ï¼š</p>
<pre><code>&quot;scripts&quot;: {
    &quot;build&quot;: &quot;webpack&quot;,
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
</code></pre><p>ç°åœ¨å¯ä»¥ä½¿ç”¨ <code>npm run build</code> è¿è¡Œï¼š</p>
<pre><code>$ npm run build

&gt; tipsy@1.0.0 build /home/jnthn/dev/cro/tipsy
&gt; webpack

Hash: 142d15221600d8f7960f
Version: webpack 3.6.0
Time: 125ms
    Asset    Size  Chunks             Chunk Names
bundle.js  2.5 kB       0  [emitted]  main
   [0] ./frontend/index.js 32 bytes {0} [built]
</code></pre><h2 id="æœåŠ¡å’Œä½¿ç”¨-bundle">æœåŠ¡å’Œä½¿ç”¨ bundle</h2>
<p>æ¥ä¸‹æ¥ï¼Œç¼–è¾‘ <code>static/index.html</code>ï¼Œå¹¶åœ¨ <code>&lt;/body&gt;</code> é—­åˆæ ‡è®°ä¹‹å‰æ·»åŠ ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/bundle.js&#34;</span><span class="p"></span><span class="p">&gt;</span><span class="p">&lt;</span><span class="p">/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div><p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸º JavaScript æä¾›æœåŠ¡ã€‚ç¼–è¾‘ <code>lib/Routes.pm6</code> å¹¶æ·»åŠ ä¸€ä¸ªåƒè¿™æ ·çš„æ–°è·¯ç”±ï¼ˆè¿™å°†æœåŠ¡ <code>static/js</code> ä¸‹çš„ä»»ä½•ä¸œè¥¿ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦ï¼Œå¯ä»¥ä¸ºå°†æ¥çš„å¤šä¸ªåŒ…åšå¥½å‡†å¤‡ï¼‰ï¼š</p>
<pre><code class="language-raku" data-lang="raku">get -&gt; 'js', *@path {
    static 'static/js', @path
}
</code></pre><p>åœ¨æµè§ˆå™¨ä¸­åˆ·æ–°ï¼Œé‚£ä¹ˆ <code>Hello from JS</code> åº”è¯¥å‡ºç°åœ¨é¡µé¢ä¸Šã€‚</p>
<p>æœ€åä½†å¹¶éæœ€ä¸é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å¿½ç•¥ <code>node_modules</code>ï¼Œç„¶åå¯ä»¥æäº¤å‰ç«¯å­˜æ ¹ï¼š</p>
<pre><code>$ echo 'node_modules/' &gt;&gt; .gitignore
$ git add .
$ git commit -m &quot;Stub JavaScript application&quot;
[master 199866c] Stub JavaScript application
 6 files changed, 40 insertions(+), 1 deletion(-)
 create mode 100644 frontend/index.js
 create mode 100644 package.json
 create mode 100644 static/index.html
 create mode 100644 webpack.config.js
</code></pre><h2 id="å¼€å§‹æ„å»ºåç«¯">å¼€å§‹æ„å»ºåç«¯</h2>
<p>ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå†…å­˜æ¨¡å‹ã€‚æœ‰å„ç§å„æ ·çš„æ–¹æ³•å¯ä»¥å°†å®ƒè€ƒè™‘åœ¨å†…ï¼Œä½†è¦è®°ä½çš„å…³é”®æ˜¯ Web åº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªå¹¶å‘ç³»ç»Ÿï¼Œè€Œ Cro è¯·æ±‚åœ¨çº¿ç¨‹æ± ä¸­å¤„ç†ã€‚è¿™æ„å‘³ç€å¯ä»¥åŒæ—¶å¤„ç†ä¸¤ä¸ªè¯·æ±‚ï¼</p>
<p>ä¸ºäº†å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ <code>OO::Monitors</code> æ¨¡å—ã€‚ç›‘è§†å™¨å°±åƒä¸€ä¸ªç±»ï¼Œä½†å®ƒå¼ºåˆ¶å®ƒçš„æ–¹æ³•äº’ç›¸æ’æ–¥ - ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯èƒ½åœ¨ç‰¹å®šå®ä¾‹çš„æ–¹æ³•å†…ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ³„éœ²æˆ‘ä»¬çš„å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚æœæˆ‘ä»¬å¿…é¡»è¿”å›å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™åˆ¶ä½œé˜²å¾¡å‰¯æœ¬ï¼‰ï¼Œç›‘è§†å¯¹è±¡å†…éƒ¨çš„çŠ¶æ€å°†å—åˆ°ä¿æŠ¤ã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°† <code>OO::Monitors</code> æ·»åŠ åˆ°æˆ‘ä»¬çš„ <code>META6.json</code> depends éƒ¨åˆ†ï¼Œä»¥è‡³äºæ–‡ä»¶çš„ä¸€éƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>&quot;depends&quot;: [
    &quot;Cro::HTTP&quot;,
    &quot;Cro::WebSocket&quot;,
    &quot;OO::Monitors&quot;
  ],
</code></pre><p>ä¸ºäº†ç¡®ä¿ä½ çœŸçš„æœ‰è¿™ä¸ªæ¨¡å—å¯ç”¨ï¼Œå¦‚æœç¼ºå¤±, è¯·ä½¿ç”¨ <code>zef</code> å®‰è£…å®ƒ:</p>
<pre><code>$ zef install --deps-only .
</code></pre><p>æˆ‘ä»¬å°†æŠŠä¸šåŠ¡é€»è¾‘æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ¨¡å— <code>lib/Tipsy.pm6</code> ä¸­ï¼Œå¹¶åœ¨ <code>t/tipsy.t</code> ä¸­ä¸ºå®ƒå†™ä¸€äº›æµ‹è¯•ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„ä¸šåŠ¡/åŸŸé€»è¾‘å­˜å‚¨ APIï¼š</p>
<pre><code class="language-raku" data-lang="raku">use OO::Monitors;

class Tip {
    has Int $.id;
    has Str $.tip;
    has Int $.agreed;
    has Int $.disagreed;
}

monitor Tipsy {
    method add-tip(Str $tip --&gt; Nil) { ... }
    method agree(Int $tip-id --&gt; Nil) { ... }
    method disagree(Int $tip-id --&gt; Nil) { ... }
    method latest-tips(--&gt; Supply) { ... }
    method top-tips(--&gt; Supply) { ... }
}
</code></pre><p>åœ¨è¿™é‡Œï¼Œ<code>Tip</code> æ˜¯ä¸€ä¸ªä¸å˜çš„å¯¹è±¡ï¼Œä»£è¡¨ä¸€ä¸ªæç¤ºä»¥åŠåŒæ„å’Œä¸åŒæ„çš„æ•°é‡ã€‚ <code>Tipsy</code> ç±»æœ‰å¾ˆå¤šæ–¹æ³•æ¥å®ç°å„ç§æ“ä½œã€‚å‰ä¸‰ä¸ªæ˜¯å¯å˜æ“ä½œã€‚æ¥ä¸‹æ¥çš„ <code>atest-tips</code> å°†æ˜¯ Tip å¯¹è±¡çš„ <code>Supply</code>ï¼Œæ¯æ¬¡æ·»åŠ æ–°æç¤ºæ—¶éƒ½ä¼šå‘å‡ºæç¤ºå¯¹è±¡ã€‚ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ï¼Œæˆ‘ä»¬å°†å§‹ç»ˆå‘å‡ºæœ€æ–°çš„ 50 ä¸ªæç¤ºã€‚ <code>top-tips</code> æ–¹æ³•è¿”å›ä¸€ä¸ª Supplyï¼Œæ¯å½“æ’åå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒå°†å‘å‡ºå‰ 50 ä¸ªæç¤ºçš„æ’åºåˆ—è¡¨ã€‚ä¸è¦è¯•å›¾è®°ä½æ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬ä¼šä¸€æ¬¡ä¸€ä¸ªåœ°å›åˆ°ä»–ä»¬èº«ä¸Šã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯è®©æˆ‘ä»¬çš„è·¯ç”±å¯ç”¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>Routes.pm6</code> ä¸­åˆ›å»ºå®ä¾‹ï¼Œä½†è¿™ä¼šè®©æˆ‘ä»¬å¾ˆéš¾åœ¨ç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘çš„æƒ…å†µä¸‹æµ‹è¯•æˆ‘ä»¬çš„è·¯ç”±ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ <code>Routes.pm6</code> ä¸­çš„ stub ä½œä¸ºå‚æ•°æ¥ä½¿ç”¨ä¸šåŠ¡é€»è¾‘å¯¹è±¡çš„å®ä¾‹ï¼š</p>
<pre><code class="language-raku" data-lang="raku">use Cro::HTTP::Router;
use Cro::HTTP::Router::WebSocket;
use Tipsy;

sub routes(Tipsy $tipsy) is export {
    route {
        get -&gt; {
            static 'static/index.html'
        }
    ...
}
</code></pre><p>ç„¶åé€šè¿‡ä»¥ä¸‹æ–¹å¼å°†å…¶è®¾ç½®åœ¨ <code>service.p6</code> å…¥å£ç‚¹ï¼š</p>
<p>1.ä½¿ç”¨æ¨¡å— 2.åˆ¶ä½œä¸€ä¸ªå®ä¾‹</p>
<p><code>service.p6</code> æ–‡ä»¶æœ€ç»ˆä¼šçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>
<pre><code class="language-raku" data-lang="raku">use Cro::HTTP::Log::File;
use Cro::HTTP::Server;
use Routes;
use Tipsy;

my $tipsy = Tipsy.new;
my $application = routes($tipsy);

my Cro::Service $http = Cro::HTTP::Server.new(
    http =&gt; &lt;1.1&gt;,
    host =&gt; %*ENV&lt;TIPSY_HOST&gt; ||
        die(&quot;Missing TIPSY_HOST in environment&quot;),
    port =&gt; %*ENV&lt;TIPSY_PORT&gt; ||
        die(&quot;Missing TIPSY_PORT in environment&quot;),
    :$application,
    after =&gt; [
        Cro::HTTP::Log::File.new(logs =&gt; $*OUT, errors =&gt; $*ERR)
    ]
);
$http.start;
say &quot;Listening at http://%*ENV&lt;TIPSY_HOST&gt;:%*ENV&lt;TIPSY_PORT&gt;&quot;;
react {
    whenever signal(SIGINT) {
        say &quot;Shutting down...&quot;;
        $http.stop;
        done;
    }
}
</code></pre><h2 id="æ·»åŠ æç¤ºå’Œæœ€è¿‘çš„æç¤º">æ·»åŠ æç¤ºå’Œæœ€è¿‘çš„æç¤º</h2>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç¼–å†™æµ‹è¯•ä»¥æ·»åŠ æç¤ºï¼Œå¹¶åœ¨æœ€æ–°æç¤ºä¸­çœ‹åˆ°å®ƒã€‚è¿™é‡Œæœ‰ <code>t/tipsy.t</code>ï¼š</p>
<pre><code class="language-raku" data-lang="raku">use Tipsy;
use Test;

my $tipsy = Tipsy.new;
lives-ok { $tipsy.add-tip('The lamb kebabs are good!') },
    'Can add a tip';
lives-ok { $tipsy.add-tip('Not so keen on the fish burrito!') },
    'Can add another tip';
given $tipsy.latest-tips.head(2).list -&gt; @tips {
    is @tips[0].tip, 'Not so keen on the fish burrito!',
        'Correct first tip retrieved on initial tap of latest-tips';
    is @tips[1].tip, 'The lamb kebabs are good!',
        'Correct second tip retrieved on initial tap of latest-tips';
}

react {
    whenever $tipsy.latest-tips.skip(2).head(1) {
        is .tip, 'Try the vanilla stout for sure',
            'Get new tips emitted live';
    }
    $tipsy.add-tip('Try the vanilla stout for sure');
}

done-testing;
</code></pre><p>ç¬¬ä¸€éƒ¨åˆ†æµ‹è¯•æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸¤ä¸ªæç¤ºï¼Œå¦‚æœæˆ‘ä»¬ç‚¹å‡»æä¾›æœ€æ–°çš„æç¤ºï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šç«‹å³ç»™å‡ºè¿™ä¸¤ä¸ªæç¤ºã€‚ç¬¬äºŒéƒ¨åˆ†æ¶‰åŠæ›´å¤šï¼šå®ƒæ£€æŸ¥å¦‚æœæˆ‘ä»¬ç‚¹å‡»æœ€æ–°çš„æç¤ºSupplyï¼Œç„¶åæ·»åŠ ä¸€ä¸ªæ–°çš„æç¤ºï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿä¼šè¢«å‘ŠçŸ¥è¿™ä¸ªæ–°æç¤ºã€‚</p>
<p>ç°åœ¨è®©ä»–ä»¬é€šè¿‡ï¼è¿™æ˜¯ <code>monitor</code> ä¸­çš„å®ç°ï¼š</p>
<pre><code class="language-raku" data-lang="raku">monitor Tipsy {
    has Int $!next-id = 1;
    has Tip %!tips-by-id{Int};
    has Supplier $!latest-tips = Supplier.new;

    method add-tip(Str $tip --&gt; Nil) {
        my $id = $!next-id++;
        my $new-tip = Tip.new(:$id, :$tip);
        %!tips-by-id{$id} = $new-tip;
        start $!latest-tips.emit($new-tip);
    }

    method latest-tips(--&gt; Supply) {
        my @latest-existing = %!tips-by-id.values.sort(-*.id).head(50);
        supply {
            whenever $!latest-tips {
                .emit;
            }
            .emit for @latest-existing;
        }
    }
    
    # The other unimplemented methods go here
}
</code></pre><p>æˆ‘ä»¬ä¿ç•™ä¸€ä¸ªIDçš„è®¡æ•°å™¨ï¼Œä¸ºæ¯ä¸ªæç¤ºåˆ†é…è‡ªå·±çš„å”¯ä¸€IDã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå“ˆå¸Œæ˜ å°„åˆ°Tipå¯¹è±¡çš„IDã€‚ç„¶åæˆ‘ä»¬æœ‰ä¸€ä¸ªä¾›åº”å•†ï¼Œå½“æœ‰æ–°çš„æç¤ºæ—¶ï¼Œæˆ‘ä»¬å°†ç”¨å®ƒæ¥é€šçŸ¥ä»»ä½•æ„Ÿå…´è¶£çš„å›¢ä½“ã€‚</p>
<p>æ·»åŠ æç¤ºæ–¹æ³•çš„å‰3è¡Œå¾ˆç®€å•ï¼Œæœ€åä¸€è¡Œæœ‰ç‚¹å¥½å¥‡ï¼šä¸ºä»€ä¹ˆè¦å¼€å§‹ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œä½¿ç”¨è€—ææ—¶ï¼Œå‘ä»¶äººæ”¯ä»˜åˆ†å‘æ¶ˆæ¯çš„è´¹ç”¨ï¼Œä½†æˆ‘ä»¬ä¸å¸Œæœ›å°†æ˜¾ç¤ºå™¨ - è¿™ä¼šäº’ç›¸æ’æ–¥ - ä¸æ‰€æœ‰è¿™äº›å·¥ä½œæŒ‚é’©ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¼€å§‹å¼‚æ­¥åˆ†æ´¾é€šçŸ¥ã€‚</p>
<p>æœ€æ–°æŠ€å·§çš„æ–¹æ³•ä¹Ÿéœ€è¦å°å¿ƒã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬ä»ç›‘è§†å™¨è¿”å›çš„å†…å®¹ä¸å—äº’æ–¥æ’é™¤çš„ä¿æŠ¤ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ä¾›åº”æ¨¡å—ä¹‹å¤–å¤åˆ¶æœ€æ–°çš„ç°æœ‰æŠ€å·§ï¼Œè€Œæ˜¾ç¤ºå™¨æ­£åœ¨ä¿æŠ¤ï¼…ï¼tips-by-idã€‚ç„¶åï¼Œå½“è¿”å›çš„ä¾›åº”å—è¢«æŒ–æ˜æ—¶ï¼Œæˆ‘ä»¬è®¢é˜…æœ€æ–°çš„æŠ€å·§ï¼Œç„¶åå‘å‡ºæ¯ä¸ªæœ€æ–°çš„ç°æœ‰æŠ€å·§ã€‚</p>
<p>éšç€è¿™äº›ï¼Œæˆ‘ä»¬çš„æµ‹è¯•é€šè¿‡ã€‚è¿›å±•ï¼</p>
<pre><code>$ git add .
$ git commit -m &quot;Implement first part of business logic&quot;
[master 6e352c6] Implement first part of business logic
 6 files changed, 70 insertions(+), 4 deletions(-)
 create mode 100644 lib/Tipsy.pm6
 create mode 100644 t/tipsy.t
</code></pre><h2 id="è®¾ç½®-reacts">è®¾ç½® Reacts</h2>
<p>ç°åœ¨æ˜¯æ—¶å€™å›åˆ°å‰ç«¯äº†ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Reactã€‚ React ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè™šæ‹Ÿçš„DOMï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡æ”¹å˜æ—¶é‡å»ºå®ƒã€‚ç„¶åå°†å…¶ä¸å½“å‰çœŸå®çš„ DOM è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶åº”ç”¨æ›´æ”¹ã€‚è¿™è®©æˆ‘ä»¬ä»¥æ›´å®ç”¨çš„é£æ ¼å·¥ä½œã€‚ React ç»„ä»¶æ˜¯ä½¿ç”¨ JSX ç¼–å†™çš„ï¼Œä¸€ç§åµŒå…¥åˆ° JavaScript ä¸­çš„ç±» XML è¯­æ³•ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç¼–è¯‘ã€‚ä»¥ä¸‹æ˜¯æ–°çš„å¼€å‘ä¾èµ–å…³ç³»ï¼š</p>
<pre><code>$ npm install --save-dev babel-loader babel-core babel-preset-es2015 babel-preset-react
</code></pre><p>æ¥ä¸‹æ¥, æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª <code>.babelrc</code> æ–‡ä»¶, å‡è®¾è¦ä½¿ç”¨è¿™ä¸ª react é¢„å…ˆè£…ç½® (Babel æ˜¯ç”¨äºå°†ç°ä»£ JavaScript è½¬æ¢æˆæµè§ˆå™¨å…¼å®¹çš„ Javascript çš„ä¸œè¥¿)ã€‚å®ƒåº”è¯¥åªåŒ…å«:</p>
<pre><code>{
  &quot;presets&quot; : [&quot;es2015&quot;,&quot;react&quot;]
}
</code></pre><p>æœ€å, <code>webpack.config.js</code> éœ€è¦æ›´æ–°æ‰èƒ½ä½¿ç”¨å®ƒã€‚æ›´æ”¹å, å®ƒçœ‹èµ·æ¥åº”è¯¥åƒä¸‹é¢è¿™æ ·:</p>
<pre><code>const path = require('path');

module.exports = {
    entry: './frontend/index.js',
    output: {
        filename: 'bundle.js',
        path: path.resolve(__dirname, 'static/js')
    },
    module : {
        rules : [
            {
                test: /\.js/,
                include: path.resolve(__dirname, 'frontend'),
                loader: 'babel-loader'
            }
        ]
    }
};
</code></pre><p>å°è¯• <code>npm run build</code>ã€‚å®ƒåº”è¯¥å­˜æ´»ä¸‹æ¥ï¼Œå°½ç®¡æˆ‘ä»¬è¿˜æ²¡æœ‰ä½¿ç”¨ä»»ä½•æ–°çš„ React æ”¯æŒã€‚</p>
<p>æ¥ä¸‹æ¥æ„å»ºå·¥å…·é“¾ï¼Œæ˜¯æ—¶å€™å®‰è£…æˆ‘ä»¬å°†ç”¨äºå‰ç«¯çš„ React æ¨¡å—ã€‚å¼€å§‹ï¼š</p>
<pre><code>$ npm install --save react react-dom
</code></pre><p>é€šè¿‡è¿™äº›ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–è¾‘æˆ‘ä»¬çš„ <code>index.js</code> æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>import React from 'react';
import {render} from 'react-dom';

var App = () =&gt; &lt;p&gt;Hello React!&lt;/p&gt;;
render(&lt;App /&gt;, document.getElementById('app'));
And add a div tag with the ID app to our index.html:

&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Tipsy&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Tipsy&lt;/h1&gt;
    &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;
    &lt;script src=&quot;js/bundle.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>å†æ¬¡è¿è¡Œ <code>npm run build</code>, åˆ·æ–°, å®ƒåº”è¯¥ä¼šæ‰“å°å‡º Hello React!.</p>
<pre><code>$ git add .
$ git commit -m &quot;Setup react&quot;
[master 0ffa260] Setup react
 5 files changed, 27 insertions(+), 1 deletion(-)
 create mode 100644 .babelrc
</code></pre><h2 id="æ·»åŠ ä¸€äº›ç»„ä»¶">æ·»åŠ ä¸€äº›ç»„ä»¶</h2>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å†ç®€å•ä»‹ç»ä¸€ä¸‹ UIã€‚ç”¨ä»¥ä¸‹å†…å®¹æ›¿æ¢ç°æœ‰çš„ App ç»„ä»¶ï¼š</p>
<pre><code>var SubmitTip = () =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Got a tip?&lt;/h2&gt;
        &lt;div&gt;
            &lt;textarea rows=&quot;2&quot; cols=&quot;100&quot; maxlength=&quot;200&quot; /&gt;
        &lt;/div&gt;
        &lt;input type=&quot;button&quot; value=&quot;Add Tip&quot; /&gt;
    &lt;/div&gt;
);

var LatestTips = () =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Latest Tips&lt;/h2&gt;
        TODO
    &lt;/div&gt;
);

var App = () =&gt; (
    &lt;div&gt;
        &lt;SubmitTip /&gt;
        &lt;LatestTips /&gt;
    &lt;/div&gt;
);
</code></pre><p>å†è¿è¡Œä¸€æ¬¡ npm run build, refreshï¼Œå®ƒåº”è¯¥æ˜¾ç¤ºä¸€äº›çœ‹èµ·æ¥å¾ˆåƒäººä»¬æœŸæœ›çš„ UIã€‚ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•è·å–æ•°æ®æ¥å¡«å…… UIï¼Ÿå½“ç‚¹å‡»æŒ‰é’®æ—¶æˆ‘ä»¬è¦åšäº›ä»€ä¹ˆï¼Ÿä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å¼•å…¥å®¢æˆ·ç«¯éš¾é¢˜çš„æœ€åä¸€éƒ¨åˆ†ï¼šReduxã€‚</p>
<h2 id="redux">Redux</h2>
<p>Redux åœ¨å…¶ç½‘ç«™ä¸Šæœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ•™ç¨‹ï¼Œæˆ‘ä¸ä¼šåœ¨è¿™é‡Œå°è¯•é‡å¤ï¼Œä½†æˆ‘ä¼šå°è¯•æ€»ç»“ä¸€ä¸‹ Redux çš„ä½œç”¨ã€‚ React ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§åœ¨æ¯æ¬¡æ›´æ”¹æ—¶æ¸²æŸ“è™šæ‹Ÿ DOM çš„æ–¹æ³•ã€‚ä¸ºäº†ä½¿å®ƒæœ‰ç”¨ï¼Œæˆ‘ä»¬éœ€è¦æŸç§å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«åº”è¯¥å‘ˆç°åœ¨ UI ä¸Šçš„å½“å‰çŠ¶æ€ã€‚ Redux æ˜¯è¯¥çŠ¶æ€çš„å®¹å™¨ï¼Œå®ƒè®©æˆ‘ä»¬ä½¿ç”¨ reducer ç»„ç»‡å¯¹å®ƒçš„æ›´æ”¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šçœŸæ­£æ›´æ–°çŠ¶æ€ï¼Œæˆ‘ä»¬åªæ˜¯ç”Ÿæˆä¸€ä¸ªä»å½“å‰çŠ¶æ€æ´¾ç”Ÿçš„æ–°çŠ¶æ€ï¼Œå†åŠ ä¸Šä¸€ä¸ªåŠ¨ä½œã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ·»åŠ  redux å’Œç›¸å…³çš„ä¾èµ–é¡¹ã€‚</p>
<pre><code>$ npm install --save redux redux-thunk react-redux
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€äº› actionã€‚action å¯¹åº”äºé¡µé¢ä¸Šçš„çŠ¶æ€æ›´æ”¹ã€‚æˆ‘ä»¬ç°åœ¨åªåˆ›å»ºä¸¤ä¸ªï¼š</p>
<ul>
<li>CHANGE_TIP_TEXT - å½“ç”¨æˆ·è¾“å…¥çš„æç¤ºæ–‡æœ¬å‘ç”Ÿå˜åŒ–æ—¶</li>
<li>ADD_TIP - å½“æ·»åŠ  Tip çš„æŒ‰é’®è¢«æŒ‰ä¸‹æ—¶</li>
</ul>
<p>åœ¨ frontend/actions.js æ–‡ä»¶ä¸­, æˆ‘ä»¬è¿™æ ·åš:</p>
<pre><code>export const CHANGE_TIP_TEXT = 'CHANGE_TIP_TEXT';
export const ADD_TIP = 'ADD_TIP';

export function changeTipText(text) {
    return { type: CHANGE_TIP_TEXT, text };
}
export function addTip() {
    return { type: ADD_TIP };
}
</code></pre><p>å¸¸é‡æ˜¯ actions çš„åç§°ï¼Œè¿™äº›å‡½æ•°ç§°ä¸ºâ€œaction åˆ›å»ºè€…â€ï¼šå®ƒä»¬åˆ›å»ºä¸€ä¸ªå…·æœ‰ç±»å‹å±æ€§çš„å¯¹è±¡ï¼Œå¹¶ä¸”å¯é€‰åœ°åˆ›å»ºä¸€äº›æ•°æ®ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª reducerã€‚ Reducers é‡‡ç”¨å½“å‰çŠ¶æ€ï¼Œè®¡ç®—å¹¶è¿”å›ä¸€ä¸ªæ–°çŠ¶æ€ã€‚ä»–ä»¬æ°¸è¿œä¸ä¼šæ”¹å˜çŠ¶æ€ï¼Œä¹Ÿä¸ä¼šåšä»»ä½•å‰¯ä½œç”¨ï¼ˆä¾‹å¦‚ç½‘ç»œ I/Oï¼‰ã€‚ä»–ä»¬æ˜¯çº¯ç²¹çš„è®¡ç®—ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„çŠ¶æ€å°†éå¸¸ç®€å•ï¼šåªæ˜¯æ–‡æœ¬æ¡†çš„å†…å®¹ã€‚</p>
<p>å½“æˆ‘ä»¬åœ¨ JavaScript ä¸­ä½¿ç”¨å³å°†æ¨å‡ºçš„æ‰©å±•è¿ç®—ç¬¦æ—¶ï¼Œå†™ reducers ä¼šæ›´æ–¹ä¾¿; å®ƒæ˜¯ä¸€ä¸ªå‰ç¼€ <code>...</code>ï¼Œå’Œ Raku çš„å‰ç¼€ <code>|</code> æ“ä½œç¬¦ä¸€æ ·å‹å¹³æ“ä½œæ•°ã€‚ç”±äºæˆ‘ä»¬å·²ç»æœ‰äº†æ„å»ºå·¥å…·é“¾ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®‰è£…å¦ä¸€ä¸ªè¯­æ³•è½¬æ¢æ¥æ·»åŠ å®ƒï¼š</p>
<pre><code>npm install --save-dev babel-plugin-transform-object-rest-spread
</code></pre><p>å¹¶æŠŠå®ƒæ·»åŠ åˆ°æˆ‘ä»¬çš„ .babelrc æ–‡ä»¶ä¸­:</p>
<pre><code>{
    &quot;presets&quot; : [&quot;es2015&quot;,&quot;react&quot;],
    &quot;plugins&quot; : [&quot;transform-object-rest-spread&quot;]
}
</code></pre><p>å®Œæˆåï¼Œè¿™æ˜¯æˆ‘ä»¬çš„ reducerï¼Œæ”¾åœ¨ frontend/reducer.js æ–‡ä»¶ä¸­ï¼š</p>
<pre><code>import * as ActionTypes from './actions';

const initialState = {
    tipText: ''
};
export function tipsyReducer(state = initialState, action) {
    switch (action.type) {
        case ActionTypes.CHANGE_TIP_TEXT:
            return { ...state, tipText: action.text };
        case ActionTypes.ADD_TIP:
            return { ...state, tipText: '' };
        default:
            return state;
    }
}
</code></pre><p>ç°åœ¨æ˜¯æ—¶å€™æŠŠå®ƒè¿æ¥åˆ° React äº†ã€‚æ•´ä½“æµç¨‹å°†æ˜¯ï¼š</p>
<ol>
<li>UI ä¸Šå‘ç”Ÿäº†ä¸€äº›äº‹æƒ…ï¼ˆæ–‡æœ¬å·²æ›´æ”¹ï¼ŒæŒ‰ä¸‹äº†æ·»åŠ æç¤ºæŒ‰é’®ï¼‰2ã€‚åˆ›å»ºäº†ä¸€ä¸ª action å¯¹è±¡ 3.å®ƒè¢«ä¼ é€’åˆ° reducerï¼Œå®ƒç”Ÿæˆä¸€ä¸ªæ–°çŠ¶æ€ 4.æ–°çŠ¶æ€è½¬æ¢ä¸ºå±æ€§ï¼Œç„¶åç”¨äºæ„å»º React è™šæ‹Ÿ DOM 5. React è´Ÿè´£å°†ä»»ä½•æ›´æ–°åº”ç”¨äºçœŸå®DOMï¼Œä»è€Œåæ˜ æˆ‘ä»¬çš„æ›´æ”¹</li>
</ol>
<p>å›åˆ° frontend/index.jsï¼Œæˆ‘ä»¬å°†å¯¼å…¥æˆ‘ä»¬çš„ actions å’Œ reducerï¼Œä»¥åŠ redux å’Œ react-redux åº“ä¸­çš„ä¸€äº›ä¸œè¥¿ï¼š</p>
<pre><code>import { createStore } from 'redux';
import { Provider, connect } from 'react-redux';
import * as Actions from './actions';
import { tipsyReducer } from './reducer';
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª Redux å­˜å‚¨ï¼Œå®ƒåŒ…å« reducer ç”Ÿæˆçš„æœ€æ–°ç‰ˆæœ¬çš„çŠ¶æ€ã€‚æˆ‘ä»¬é€šè¿‡å°† reducer ä¼ é€’ç»™ createStore æ¥åˆ›å»ºå®ƒï¼š</p>
<pre><code>let store = createStore(tipsyReducer);
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å°†å­˜å‚¨ä¸­çš„çŠ¶æ€æ˜ å°„åˆ° React ç»„ä»¶ä¸­å¯ç”¨å±æ€§ï¼Œå¹¶ç”Ÿæˆä¸€äº›ä¹Ÿå¯ä»¥åœ¨è¿™äº›å±æ€§ä¸­ä½¿ç”¨çš„å‡½æ•°ï¼Œå¹¶è°ƒåº¦ actionsã€‚</p>
<pre><code>function mapProps(state) {
    return state;
}
function mapDispatch(dispatch) {
    return {
        onChangeTipText: text =&gt; dispatch(Actions.changeTipText(text)),
        onAddTip: text =&gt; dispatch(Actions.addTip())
    };
}
</code></pre><p>æœ‰äº†è¿™äº›ï¼Œæˆ‘ä»¬å¯ä»¥å®Œæˆ Redux ä¸ React çš„é›†æˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>let ConnectedApp = connect(mapProps, mapDispatch)(App);
render(
    &lt;Provider store={store}&gt;
        &lt;ConnectedApp /&gt;
    &lt;/Provider&gt;,
    document.getElementById('app'));
</code></pre><p>connect å‡½æ•°ä½¿æ¥è‡ªå­˜å‚¨ä¸­çŠ¶æ€çš„å±æ€§å¯ç”¨äº App React ç»„ä»¶ï¼Œå¹¶å°†å…¶åŒ…è£…åœ¨ Provider ä¸­ä½¿å¾—å­˜å‚¨ä¸­çš„çŠ¶æ€å¯ç”¨ä»¥ä¾¿å®ç°ã€‚</p>
<p>æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°æˆ‘ä»¬çš„ç»„ä»¶ï¼š</p>
<pre><code>var SubmitTip = props =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Got a tip?&lt;/h2&gt;
        &lt;div&gt;
            &lt;textarea rows=&quot;2&quot; cols=&quot;100&quot; maxLength=&quot;200&quot;
                value={props.tipText}
                onChange={e =&gt; props.onChangeTipText(e.target.value)} /&gt;
        &lt;/div&gt;
        &lt;input type=&quot;button&quot; value=&quot;Add Tip&quot; onClick={props.onAddTip} /&gt;
    &lt;/div&gt;
);

var App = props =&gt; (
    &lt;div&gt;
        &lt;SubmitTip tipText={props.tipText}
            onChangeTipText={props.onChangeTipText}
            onAddTip={props.onAddTip} /&gt;
        &lt;LatestTips /&gt;
    &lt;/div&gt;
);
</code></pre><p>åœ¨ npm run build ä¹‹å, åˆ·æ–°æµè§ˆå™¨ï¼Œæˆ‘ä»¬åº”è¯¥æ³¨æ„åˆ°åœ¨é”®å…¥åç‚¹å‡» Add Tip æŒ‰é’®å°†æ¸…é™¤æ–‡æœ¬æ¡†ã€‚æˆ‘ä»¬çš„ action å’Œ reducer æ­£åœ¨è¿è¡Œã€‚å”·ï¼</p>
<p>ä¸ºäº†å®Œæ•´æ€§ï¼Œè¿™é‡Œæ˜¯è¿™ä¸ªé˜¶æ®µæ•´ä¸ª frontend/index.jsï¼š</p>
<pre><code>import React from 'react';
import { render } from 'react-dom';
import { createStore } from 'redux';
import { Provider, connect } from 'react-redux';
import * as Actions from './actions';
import { tipsyReducer } from './reducer';

var SubmitTip = props =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Got a tip?&lt;/h2&gt;
        &lt;div&gt;
            &lt;textarea rows=&quot;2&quot; cols=&quot;100&quot; maxLength=&quot;200&quot;
                value={props.tipText}
                onChange={e =&gt; props.onChangeTipText(e.target.value)} /&gt;
        &lt;/div&gt;
        &lt;input type=&quot;button&quot; value=&quot;Add Tip&quot; onClick={props.onAddTip} /&gt;
    &lt;/div&gt;
);

var LatestTips = () =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Latest Tips&lt;/h2&gt;
        TODO
    &lt;/div&gt;
);

var App = props =&gt; (
    &lt;div&gt;
        &lt;SubmitTip tipText={props.tipText}
            onChangeTipText={props.onChangeTipText}
            onAddTip={props.onAddTip} /&gt;
        &lt;LatestTips /&gt;
    &lt;/div&gt;
);

function mapProps(state) {
    return state;
}
function mapDispatch(dispatch) {
    return {
        onChangeTipText: text =&gt; dispatch(Actions.changeTipText(text)),
        onAddTip: text =&gt; dispatch(Actions.addTip())
    };
}

let store = createStore(tipsyReducer);
let ConnectedApp = connect(mapProps, mapDispatch)(App);
render(
    &lt;Provider store={store}&gt;
        &lt;ConnectedApp /&gt;
    &lt;/Provider&gt;,
    document.getElementById('app'));
</code></pre><p>åˆåˆ°äº†æäº¤çš„æ—¶é—´äº†ã€‚</p>
<pre><code>$ git add .
$ git commit -m &quot;Wire up Redux&quot;
[master 3478433] Wire up Redux
 5 files changed, 83 insertions(+), 7 deletions(-)
 create mode 100644 frontend/actions.js
 rewrite frontend/index.js (81%)
 create mode 100644 frontend/reducer.js
</code></pre><h2 id="posting-åˆ°åç«¯">POSTing åˆ°åç«¯</h2>
<p>æœ€åï¼Œæ˜¯æ—¶å€™åœ¨å‰ç«¯æ·»åŠ ä¸€ä¸ªæç¤ºè°ƒç”¨åç«¯äº†ï¼æˆ‘ä»¬éœ€è¦åšä¸¤ä»¶äº‹ï¼š</p>
<p>1.åœ¨ Cro åç«¯ç¼–å†™ä¸€ä¸ª POST å¤„ç†ç¨‹åº 2.æ‰¾åˆ°ä¸€ç§æ–¹æ³•è®©æˆ‘ä»¬çš„ Redux action ç»“æœåœ¨ POST ä¸­</p>
<p>é¦–å…ˆæ˜¯ Cro éƒ¨åˆ†ã€‚åœ¨ lib/Routes.pm6 ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ ä»¥ä¸‹è·¯ç”±å®ç°ï¼š</p>
<pre><code>post -&gt; 'tips' {
    request-body -&gt; (:$text) {
        $tipsy.add-tip($text);
        response.status = 204;
    }
}
</code></pre><p>æ¥ä¸‹æ¥ï¼ŒJavaScript éƒ¨åˆ†ã€‚é—®é¢˜æ˜¯ç½‘ç»œéƒ¨åˆ†åœ¨å“ªé‡Œï¼Ÿæˆ‘ä»¬çš„ reducer åº”è¯¥æ˜¯çº¯å‡€çš„ã€‚ç­”æ¡ˆæ˜¯æˆ‘ä»¬ä¹‹å‰å®‰è£…çš„ redux-thunk æ¨¡å—ï¼Œä½†å°šæœªä½¿ç”¨ã€‚è¿™å…è®¸æˆ‘ä»¬ç¼–å†™è¿”å›å‡½æ•°çš„ action åˆ›å»ºè€…ã€‚è¯¥å‡½æ•°å°†é€šè¿‡è°ƒåº¦ç¨‹åºï¼Œå¹¶å¯ä»¥è°ƒç”¨å®ƒæ¥è°ƒåº¦ actionã€‚é€šå¸¸ï¼Œæˆ‘ä»¬å°†åœ¨å¼‚æ­¥æ“ä½œå¼€å§‹æ—¶è°ƒåº¦ä¸€ä¸ª actionï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒåœ¨ UI ä¸ŠæŒ‡ç¤ºï¼Œå¹¶åœ¨å®Œæˆåå†æŒ‡ç¤ºä¸€ä¸ªæ“ä½œï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å†æ¬¡æŒ‡ç¤ºæ“ä½œåœ¨ UI ä¸­å®Œæˆã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬è®¾ç½® redux-thunkï¼Œè¿™æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ã€‚å›åˆ° frontend/index.jsï¼Œæ·»åŠ ï¼š</p>
<pre><code>import thunkMiddleware from 'redux-thunk';
</code></pre><p>ç„¶åæ”¹å˜ï¼š</p>
<pre><code>import { createStore } from 'redux';
</code></pre><p>è¿˜è¦å†å¯¼å…¥ applyMiddleware:</p>
<pre><code>import { createStore, applyMiddleware } from 'redux';
</code></pre><p>æœ€åï¼Œæ›´æ”¹ï¼š</p>
<pre><code>let store = createStore(tipsyReducer);
</code></pre><p>è¿˜è¦åº”ç”¨ the middleware:</p>
<pre><code>let store = createStore(tipsyReducer, applyMiddleware(thunkMiddleware));
</code></pre><p>ä¸‹ä¸€æ­¥ï¼Œåœ¨ frontend/actions.js ä¸­, æˆ‘ä»¬å°†é‡æ„ add tip action åˆ›å»ºå™¨å‡½æ•°ä½œä¸º thunk actionï¼š</p>
<pre><code>export function addTip() {
    return dispatch =&gt; {
        dispatch({ type: ADD_TIP });
    };
}
</code></pre><p>è¯·æ³¨æ„ï¼Œè¿™è¿˜æ²¡æœ‰æ”¹å˜ä»»ä½•ä¸œè¥¿; build å®ƒï¼Œè¡Œä¸ºåº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†è¿™é¡¹å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ç½‘ç»œæ“ä½œä¹‹åå¯ä»¥åœ¨å›è°ƒä¸­æ‰§è¡Œæ­¤è°ƒåº¦ã€‚</p>
<p>å½“ç„¶æœ‰å¾ˆå¤šå¥½æ–¹æ³•å¯ä»¥å¤„ç† JavaScript ä¸­çš„å¼‚æ­¥æ“ä½œï¼Œå¦‚æœä½ æ­£åœ¨è®¤çœŸæ„å»ºå•é¡µé¢åº”ç”¨ç¨‹åºï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½ è€ƒè™‘ä½¿ç”¨ promise åº“ã€‚è¿˜æœ‰ Redux ä¸­é—´ä»¶å°†ä¸ä¹‹é›†æˆã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†åšæœ€ç®€å•çš„äº‹æƒ…ï¼šä½¿ç”¨ jQuery å’Œå›è°ƒã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ·»åŠ  jQuery ä½œä¸ºä¾èµ–ï¼š</p>
<pre><code>$ npm install --save jquery
</code></pre><p>ç„¶åæˆ‘ä»¬ä¼šåœ¨ frontend/actions.js ä¸­å¯¼å…¥å®ƒ:</p>
<pre><code>import $ from 'jquery';
</code></pre><p>å¹¶å°† POST å‘é€åˆ°åç«¯ï¼š</p>
<pre><code>export function addTip() {
    return (dispatch, getState) =&gt; {
        $.ajax({
            url: '/tips',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ text: getState().tipText }),
            success: () =&gt; dispatch({ type: ADD_TIP })
        });
    };
}
</code></pre><p>é‡æ–°åŠ è½½å®ƒï¼Œå¯èƒ½æ‰“å¼€æµè§ˆå™¨çš„å¼€å‘å·¥å…·ï¼ˆé€šå¸¸æ˜¯F12ï¼‰ï¼Œç¿»åˆ°â€œç½‘ç»œâ€é€‰é¡¹å¡ï¼Œç„¶åå•å‡»â€œæ·»åŠ æç¤ºâ€ã€‚ä¸€åˆ‡é¡ºåˆ©ï¼Œæ‚¨å°†è§‚å¯Ÿåˆ°è¯·æ±‚å·²ç»å®Œæˆå¹¶ä¸”å®ƒäº§ç”Ÿäº† 204 å“åº”ã€‚æˆ–è€…ï¼Œä½ å¯èƒ½æƒ³åœæ­¢è¿è¡Œï¼Œè€Œæ˜¯åšä¸€äº› cro trace; é”®å…¥æ¶ˆæ¯ï¼Œå†æ¬¡å•å‡»â€œæ·»åŠ æç¤ºâ€ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°è¯·æ±‚ä¸»ä½“åœ¨è·Ÿè¸ªè¾“å‡ºä¸­è½¬å‚¨ã€‚</p>
<pre><code>...
65 63 74 69 6f 6e 3a 20 6b 65 65 70 2d 61 6c 69  ection: keep-ali
76 65 0d 0a 0d 0a 7b 22 74 65 78 74 22 3a 22 74  ve....{&quot;text&quot;:&quot;t
72 79 20 74 68 65 20 62 65 65 66 22 7d           ry the beef&quot;}
</code></pre><h2 id="the-latest-tips-websocket">The latest tips websocket</h2>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å„ç§æ–¹å¼ç¼–å†™ websocketï¼Œä½†æˆ‘ä»¬å°†ä½¿ç”¨ redux-websocket-actionã€‚è¿™å…è®¸æˆ‘ä»¬é€šè¿‡ websocket å°† Redux åŠ¨ä½œå‘é€åˆ°å®¢æˆ·ç«¯ï¼Œè¿™å¾ˆç®€æ´ï¼ˆå°½ç®¡ä¸å¹¸çš„æ˜¯ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å°†åç«¯ä¸å‰ç«¯ä¸­æ­¤åº“çš„ä½¿ç”¨ç›¸ç»“åˆï¼Œè¿™å€¼å¾—ä¸€äº›è´¨ç–‘ï¼‰ã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨å‰ç«¯å®‰è£…åº“ï¼š</p>
<pre><code>$ npm install --save redux-websocket-action
</code></pre><p>åœ¨ index.js ä¸­ï¼Œæˆ‘ä»¬å¯¼å…¥å®ƒï¼š</p>
<pre><code>import WSAction from 'redux-websocket-action';
</code></pre><p>å¹¶è®¾ç½®å®ƒï¼Œåƒè¿™æ ·ï¼š</p>
<pre><code>let host = window.location.host;
let wsAction = new WSAction(store, 'ws://' + host + '/latest-tips', {
    retryCount:3,
    reconnectInterval: 3
});
wsAction.start();
</code></pre><p>åœ¨ frontend/actions.js ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªåŠ¨ä½œç±»å‹ï¼ˆä½†æ²¡æœ‰åŠ¨ä½œåˆ›å»ºåŠŸèƒ½ï¼Œå› ä¸ºå®ƒå°†æ¥è‡ªæœåŠ¡å™¨ï¼‰ï¼š</p>
<pre><code>export const LATEST_TIP = 'LATEST_TIP';
</code></pre><p>ç„¶åæˆ‘ä»¬å°†æ›´æ–°æˆ‘ä»¬çš„ reducerï¼Œå°†æ¯ä¸ªä¼ å…¥çš„æç¤ºæ·»åŠ åˆ°æœ€æ–°æç¤ºåˆ—è¡¨ä¸­ï¼Œå› æ­¤ frontend/reducer.js æœ€ç»ˆä¸ºï¼š</p>
<pre><code>import * as ActionTypes from './actions';

const initialState = {
    tipText: '',
    latestTips: []
};
export function tipsyReducer(state = initialState, action) {
    switch (action.type) {
        case ActionTypes.CHANGE_TIP_TEXT:
            return { ...state, tipText: action.text };
        case ActionTypes.ADD_TIP:
            return { ...state, tipText: '' };
        case ActionTypes.LATEST_TIP: {
            let tip = { id: action.id, text: action.text };
            return {
                ...state,
                latestTips: [tip, ...state.latestTips]
            };
        }
        default:
            return state;
    }
}
</code></pre><p>ç„¶åæ›´æ–° frontend/index.js ä¸­çš„ React ç»„ä»¶ä»¥æ¸²æŸ“æœ€æ–°æç¤ºï¼š</p>
<pre><code>var LatestTips = props =&gt; (
    &lt;div&gt;
        &lt;h2&gt;Latest Tips&lt;/h2&gt;
        &lt;ul&gt;
        {props.tips.map(t =&gt; &lt;li key={t.id}&gt;{t.text}&lt;/li&gt;)}
        &lt;/ul&gt;
    &lt;/div&gt;
);

var App = props =&gt; (
    &lt;div&gt;
        &lt;SubmitTip tipText={props.tipText}
            onChangeTipText={props.onChangeTipText}
            onAddTip={props.onAddTip} /&gt;
        &lt;LatestTips tips={props.latestTips} /&gt;
    &lt;/div&gt;
);
</code></pre><p>åº”ç”¨ç¨‹åºæ›´æ–°åªæ˜¯ä¸ºäº†å°†æç¤ºä¼ é€’ç»™ LatestTips ç»„ä»¶ã€‚ç„¶åï¼Œå®¢æˆ·ç«¯æ·»åŠ å®Œæˆã€‚</p>
<p>ç°åœ¨æ˜¯åç«¯ï¼Œè¿™åªæ˜¯ Routes.pm6 ä¸­çš„ä¸€ä¸ªè¡¥å……ã€‚æˆ‘ä»¬æ¸…é™¤äº†ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„ websocket å­˜æ ¹ï¼Œå¹¶å°†å…¶æ›¿æ¢ä¸ºä»£ç ä»¥ä» Tipsy ä¸šåŠ¡é€»è¾‘å¯¹è±¡è·å–æœ€æ–°æç¤ºï¼Œå°†äº‹ä»¶è½¬æ¢ä¸ºé€‚å½“çš„ JSONï¼Œç„¶åå‘å‡ºå®ƒä»¬ï¼š</p>
<pre><code>get -&gt; 'latest-tips' {
    web-socket -&gt; $incoming {
        supply whenever $tipsy.latest-tips -&gt; $tip {
            emit to-json {
                WS_ACTION =&gt; True,
                action =&gt; {
                    type =&gt; 'LATEST_TIP',
                    id =&gt; $tip.id,
                    text =&gt; $tip.tip
                }
            }
        }
    }
}
</code></pre><p>The outer hash is the &ldquo;envelope&rdquo; for redux-websocket-action, which tells it to pay attention to the message and dispatch its action property as a Redux action.</p>
<p>Reload it in the browser. Add a tip. See it show up. Open a second tab with the application. You&rsquo;ll see it shows the first tip. Add a second tip. Flip back to the first tab, and you&rsquo;ll see that tip magically showed up there too. We&rsquo;re now successfully sharing out the tips over the web socket. Hurrah! That calls for a commit.</p>
<p>å¤–éƒ¨å“ˆå¸Œæ˜¯ redux-websocket-action çš„â€œä¿¡å°â€ï¼Œå®ƒå‘Šè¯‰å®ƒæ³¨æ„æ¶ˆæ¯å¹¶å°†å…¶ action å±æ€§ä½œä¸º Redux åŠ¨ä½œå‘é€ã€‚</p>
<p>åœ¨æµè§ˆå™¨ä¸­é‡æ–°åŠ è½½å®ƒã€‚æ·»åŠ æç¤ºã€‚çœ‹åˆ°å®ƒå‡ºç°ã€‚ä½¿ç”¨è¯¥åº”ç”¨ç¨‹åºæ‰“å¼€ç¬¬äºŒä¸ªé€‰é¡¹å¡ã€‚ä½ ä¼šçœ‹åˆ°å®ƒæ˜¾ç¤ºç¬¬ä¸€ä¸ªæç¤ºã€‚æ·»åŠ ç¬¬äºŒä¸ªæç¤ºã€‚ç¿»å›ç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼Œä½ ä¼šçœ‹åˆ°é‚£ä¸ªå°è´¹ç¥å¥‡åœ°å‡ºç°åœ¨é‚£é‡Œã€‚æˆ‘ä»¬ç°åœ¨å·²æˆåŠŸé€šè¿‡ Web å¥—æ¥å­—åˆ†äº«æç¤ºã€‚æ¬¢å‘¼ï¼è¿™éœ€è¦æäº¤ä¸€æ¬¡ã€‚</p>
<h2 id="agree-and-disagree">Agree and disagree</h2>
<p>æˆ‘ä»¬èŠ±äº†å¾ˆå¤šæ—¶é—´æ¥è®¾ç½®å®¢æˆ·ç«¯(client-side)çš„åŸºç¡€æ¶æ„ã€‚ç°åœ¨å®ƒå·²ç»åˆ°ä½ï¼Œä½†æ˜¯ï¼Œæ·»åŠ æ›´å¤šåŠŸèƒ½æ˜¯ä¸€ä¸ªæ›´å¿«çš„è¿‡ç¨‹ã€‚è®©æˆ‘ä»¬é€šè¿‡å®ç°åŒæ„/ä¸åŒæ„åŠŸèƒ½ï¼ˆé“¾æ¥è®©ç”¨æˆ·è¡¨ç¤ºåŒæ„/ä¸åŒæ„æç¤ºï¼‰æ¥å®Œå–„æ•™ç¨‹ï¼Œå¹¶æ˜¾ç¤ºæœ€å¤´éƒ¨çš„æç¤ºåˆ—è¡¨ã€‚</p>
<p>è®©æˆ‘ä»¬ä»åç«¯å¼€å§‹ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘å¯¹è±¡ä¸­ç¼–å†™è¿™äº›æ–°åŠŸèƒ½çš„æµ‹è¯•ã€‚æˆ‘ä»¬å°†è¿™äº›æµ‹è¯•æ·»åŠ åˆ° <code>t/tipsy.t</code>ï¼š</p>
<pre><code>given $tipsy.latest-tips.head(3).list -&gt; @tips {
    $tipsy.agree(@tips[0].id) for ^3;
    $tipsy.agree(@tips[1].id) for ^4;
    $tipsy.disagree(@tips[1].id) for ^10;
    $tipsy.agree(@tips[2].id) for ^2;
}
given $tipsy.top-tips.head(1).list[0] {
    is .[0].tip, 'Try the vanilla stout for sure',
        'Most agreeable tip first';
    is .[1].tip, 'The lamb kebabs are good!',
        'Next most agreeable tip second';
    is .[2].tip, 'Not so keen on the fish burrito!',
        'Least agreeable tip third';
}
throws-like { $tipsy.agree(99999) }, X::Tipsy::NoSuchId,
    'Correct exception on no such tip';
</code></pre><p>ç¬¬ä¸€éƒ¨åˆ†åªæ˜¯åœ¨æç¤ºä¸Šæ·»åŠ äº†ä¸€äº› agreement å’Œ disagreementï¼ˆæœ€æ–°çš„ä¼šæ‹åœ¨ç¬¬ä¸€çš„ä½ç½®ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ top-tips ä¾›åº”å¹¶æŠ“ä½å®ƒå‘å‡ºçš„ç¬¬ä¸€ä¸ªä¸œè¥¿ï¼ˆæˆ–è‡³å°‘åº”è¯¥å‘å‡ºï¼‰ï¼Œè¿™æ˜¯æˆ‘ä»¬ç‚¹å‡» Supply æ—¶çš„å½“å‰æ’åºã€‚å®ƒæ£€æŸ¥é¡ºåºæ˜¯å¦æ­£ç¡®ã€‚æœ€ç»ˆæµ‹è¯•æ£€æŸ¥å¯¹äºæ— æ³•è¯†åˆ«çš„ IDï¼Œæˆ‘ä»¬æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>è¿™æ˜¯æ–°çš„å¼‚å¸¸ç±»å‹ï¼š</p>
<pre><code>class X::Tipsy::NoSuchId is Exception {
    has $.id;
    method message() { &quot;No tip with ID '$!id'&quot; }
}
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç»™ Tip ç±»æä¾›ä¸€äº›æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ç”Ÿæˆ Tip å¯¹è±¡çš„æ–°ç‰ˆæœ¬ï¼ŒåŒæ„æˆ–ä¸åŒæ„æ›´é«˜ä¸€äº›ï¼ˆæˆ‘ä»¬å°†è¿™äº›å®ä¾‹ä¿æŒä¸å˜ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç›‘è§†å™¨ä¹‹å¤–å…±äº«å®ƒä»¬ï¼‰ï¼š</p>
<pre><code>class Tip {
    has Int $.id is required;
    has Str $.tip is required;
    has Int $.agreed = 0;
    has Int $.disagreed = 0;

    method agree() {
        self.clone(agreed =&gt; $!agreed + 1)
    }

    method disagree() {
        self.clone(disagreed =&gt; $!disagreed + 1)
    }
}
</code></pre><p>åŒæ„å’Œä¸åŒæ„çš„æ–¹æ³•å¾ˆå®¹æ˜“ï¼š</p>
<pre><code>method agree(Int $tip-id --&gt; Nil) {
    with %!tips-by-id{$tip-id} -&gt; $tip-ref is rw {
        $tip-ref .= agree;
    }
    else {
        X::Tipsy::NoSuchId.new(id =&gt; $tip-id).throw;
    }
}

method disagree(Int $tip-id --&gt; Nil) {
    with %!tips-by-id{$tip-id} -&gt; $tip-ref is rw {
        $tip-ref .= disagree;
    }
    else {
        X::Tipsy::NoSuchId.new(id =&gt; $tip-id).throw;
    }
}
</code></pre><p>å—¯ï¼Œå®é™…ä¸Šè¿™æœ‰ç‚¹ç›¸ä¼¼ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ç§æœ‰æ–¹æ³•æ¥è§£å†³å®ƒï¼š</p>
<pre><code>method agree(Int $tip-id --&gt; Nil) {
    self!with-tip: $tip-id, -&gt; $tip-ref is rw {
        $tip-ref .= agree;
    }
}

method disagree(Int $tip-id --&gt; Nil) {
    self!with-tip: $tip-id, -&gt; $tip-ref is rw {
        $tip-ref .= disagree;
    }
}   
        
method !with-tip(Int $tip-id, &amp;operation --&gt; Nil) {
    with %!tips-by-id{$tip-id} -&gt; $tip-ref is rw {
        operation($tip-ref)
    }
    else {
        X::Tipsy::NoSuchId.new(id =&gt; $tip-id).throw;
    }
}
</code></pre><p>æœ€åï¼Œè¿™æ˜¯æˆ‘ä»¬å¯¹ top-tips æ–¹æ³•çš„ç¬¬ä¸€æ¬¡å°è¯•ï¼š</p>
<pre><code>method top-tips(--&gt; Supply) { 
    my @top-tips = %!tips-by-id.values
        .sort({ .disagreed - .agreed })
        .head(50);
    supply {
        emit @top-tips;
    }
}
</code></pre><p>å®ƒé€šè¿‡äº†æµ‹è¯•ï¼Œç„¶è€Œ&hellip;&hellip;ç¼ºå°‘äº†ä¸€äº›ä¸œè¥¿ã€‚è¿™æ„å‘³ç€æ¯å½“æœ‰æ–°çš„æç¤ºæˆ–æç¤ºè¢«åŒæ„æˆ–ä¸åŒæ„æ—¶ï¼Œä¼šå‘å‡ºæ›´æ–°çš„æ’åºæç¤ºåˆ—è¡¨ã€‚è®©æˆ‘ä»¬ä¸ºå®ƒæ·»åŠ ä¸€äº›æµ‹è¯•ï¼š</p>
<pre><code>my $new-tip-id;
react {
    whenever $tipsy.top-tips.skip(1).head(1) {
        is .[0].tip, 'Try the vanilla stout for sure',
            'After adding a tip, correct order (1)';
        is .[1].tip, 'The lamb kebabs are good!',
            'After adding a tip, correct order (2)';
        is .[2].tip, 'The pau bahji is super spicy',
            'After adding a tip, correct order (3)';
        is .[3].tip, 'Not so keen on the fish burrito!',
            'After adding a tip, correct order (4)';
        $new-tip-id = .[2].id;
    }
    $tipsy.add-tip('The pau bahji is super spicy');
}
ok $new-tip-id, 'New tip ID seen in top sorted tips';

react {
    whenever $tipsy.top-tips.skip(5).head(1) {
        is .[0].tip, 'The pau bahji is super spicy',
            'After agrees, order updated';
    }
    $tipsy.agree($new-tip-id) for ^5;
}
</code></pre><p>è¦è¿›è¡Œæ­¤æ›´æ–°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæˆ‘ä»¬å¯ä»¥å‘å‡ºçš„ Supplierï¼Œä»¥è¡¨æ˜å¯¹åŒæ„/ä¸åŒæ„è®¡æ•°çš„æ›´æ”¹ã€‚</p>
<pre><code>has Supplier $!tip-change = Supplier.new;
</code></pre><p>å¹¶åœ¨å…¶ä¸Šå‘å°„ï¼ˆåœ¨ä¹‹å‰çš„å› å­åˆ†è§£åå¾ˆå®¹æ˜“ï¼‰ï¼š</p>
<pre><code>method !with-tip(Int $tip-id, &amp;operation --&gt; Nil) {
    with %!tips-by-id{$tip-id} -&gt; $tip-ref is rw {
        operation($tip-ref);
        start $!tip-change.emit($tip-ref&lt;&gt;);
    }
    else {
        X::Tipsy::NoSuchId.new(id =&gt; $tip-id).throw;
    }
}
</code></pre><p>æœ€åï¼Œæ›´æ–° top-tips æ–¹æ³•ã€‚æˆ‘ä»¬æœ‰å‡ ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†ç¡®ä¿æˆ‘ä»¬å®‰å…¨çš„æœ€ç®€å•æ–¹æ³•æ˜¯ç¡®ä¿ Supply ä¿æŒå…¶è‡ªèº«çš„æœ¬åœ°çŠ¶æ€ï¼Œå®ƒå¯ä»¥ä¿æŠ¤ï¼ˆå†æ¬¡ï¼Œè¯·è®°ä½ï¼Œå› ä¸º supply å—ä»ä¸­è¿”å›ï¼Œå¹¶ä¸”è¶…è¶Šï¼Œæ–¹æ³•ï¼Œå®ƒä¸ä¼šå—åˆ°ç›‘è§†å™¨çš„ä¿æŠ¤ï¼‰ã€‚</p>
<pre><code>method top-tips(--&gt; Supply) {
    my %initial-tips = %!tips-by-id;
    supply {
        my %current-tips = %initial-tips;
        sub emit-latest-sorted() {
            emit [%current-tips.values.sort({ .disagreed - .agreed }).head(50)]
        }
        whenever Supply.merge($!latest-tips.Supply, $!tip-change.Supply) {
            %current-tips{.id} = $_;
            emit-latest-sorted;
        }
        emit-latest-sorted;
    }
}
</code></pre><p>å®Œæˆåï¼Œæ˜¯æ—¶å€™é€šè¿‡æ›´æ–° lib/Routes.pm6 å°†æ­¤åŠŸèƒ½å…¬å¼€ç»™å¤–ç•Œã€‚å®ƒçš„å·¥ä½œæ˜¯å°†ä¸šåŠ¡é€»è¾‘æ˜ å°„åˆ° HTTPã€‚æˆ‘ä»¬å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯å°† â€œno such IDâ€ çš„å¼‚å¸¸è½¬æ¢ä¸ºé€‚å½“çš„ HTTP å“åº”ï¼Œå³ 404 Not Foundã€‚å¦åˆ™ï¼Œæˆ‘ä»¬ä¼šå‘å› 500 å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯å‘é€äº†ä¸€äº›ä¼ªé€ çš„ ID ä¸æ˜¯æœåŠ¡å™¨çš„é”™ã€‚å¼€å§‹ï¼š</p>
<pre><code>post -&gt; 'tips', Int $id, 'agree' {
    $tipsy.agree($id);
    response.status = 204;
    CATCH {
        when X::Tipsy::NoSuchId {
            not-found;
        }
    }
}

post -&gt; 'tips', Int $id, 'disagree' {
    $tipsy.disagree($id);
    response.status = 204;
    CATCH {
        when X::Tipsy::NoSuchId {
            not-found;
        }
    }
}
</code></pre><p>åç«¯çš„æœ€åä¸€æ­¥æ˜¯å°†é¡¶éƒ¨æç¤ºæ˜ å°„åˆ°å¦ä¸€ä¸ª Web å¥—æ¥å­—ï¼š</p>
<pre><code>get -&gt; 'top-tips' {
    web-socket -&gt; $incoming {
        supply whenever $tipsy.top-tips -&gt; @tips {
            emit to-json {
                WS_ACTION =&gt; True,
                action =&gt; {
                    type =&gt; 'UPDATE_TOP_TIPS',
                    tips =&gt; [@tips.map: -&gt; $tip {
                        {
                            id =&gt; $tip.id,
                            text =&gt; $tip.tip,
                            agreed =&gt; $tip.agreed,
                            disagreed =&gt; $tip.disagreed
                        }
                    }]
                }
            }
        }
    }
}
</code></pre><p>ç°åœ¨åˆ°å‰ç«¯äº†ã€‚åœ¨ frontend/actions.js ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸‰ä¸ªæ–°çš„ action ç±»å‹å¸¸é‡ï¼š</p>
<pre><code>export const UPDATE_TOP_TIPS = 'UPDATE_TOP_TIPS';
export const AGREE = 'AGREE';
export const DISAGREE = 'DISAGREE';
And then two new action creators (UPDATE_TOP_TIPS doesn't need one, as it comes from the server):

export function agree(id) {
    return dispatch =&gt; {
        $.ajax({
            url: '/tips/' + id + '/agree',
            type: 'POST',
            success: () =&gt; dispatch({ type: AGREE, id })
        });
    };
}
export function disagree(id) {
    return dispatch =&gt; {
        $.ajax({
            url: '/tips/' + id + '/disagree',
            type: 'POST',
            success: () =&gt; dispatch({ type: DISAGREE, id })
        });
    };
}
</code></pre><p>åœ¨ reducer ä¸­ï¼Œæˆ‘ä»¬å°†è°ƒæ•´åˆå§‹çŠ¶æ€ä»¥è·å¾—ä¸€ç»„ç©ºçš„ top æç¤ºï¼š</p>
<pre><code>const initialState = {
    tipText: '',
    latestTips: [],
    topTips: []
};
</code></pre><p>ç„¶åæ·»åŠ ä¸€ä¸ªé¢å¤–çš„ case è¯­å¥æ¥å¤„ç†æ–°çš„æ›´æ–°æ“ä½œï¼ˆæˆ‘ä»¬ä¸éœ€è¦åœ¨åŒæ„/ä¸åŒæ„çš„æƒ…å†µä¸‹åšä»»ä½•äº‹æƒ…ï¼Œå°½ç®¡åœ¨çœŸå®çš„åº”ç”¨ç¨‹åºä¸­æˆ‘ä»¬æƒ³è¦ç»™ä¸€äº›ç”¨æˆ·åé¦ˆä»–ä»¬çš„æŠ•ç¥¨è¢«è®¡ç®—åœ¨å†…ï¼‰ï¼š</p>
<pre><code>case ActionTypes.UPDATE_TOP_TIPS:
    return {
        ...state,
        topTips: action.tips
    };
</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦è¿æ¥ç¬¬äºŒä¸ª Web å¥—æ¥å­—ã€‚è¿™åªæ˜¯ frontend/index.js ä¸­çš„ä¸€ç‚¹é‡æ„ï¼š</p>
<pre><code>['latest-tips', 'top-tips'].forEach(endpoint =&gt; {
    let host = window.location.host;
    let wsAction = new WSAction(store, 'ws://' + host + '/' + endpoint, {
        retryCount:3,
        reconnectInterval: 3
    });
    wsAction.start();
});
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æŠŠè°ƒåº¦æ›´æ–°åˆ° props mapï¼ŒåŒ…æ‹¬æˆ‘ä»¬æ–°çš„åŒæ„å’Œä¸åŒæ„çš„ actionï¼š</p>
<pre><code>function mapDispatch(dispatch) {
    return {
        onChangeTipText: text =&gt; dispatch(Actions.changeTipText(text)),
        onAddTip: text =&gt; dispatch(Actions.addTip()),
        onAgree: id =&gt; dispatch(Actions.agree(id)),
        onDisagree: id =&gt; dispatch(Actions.disagree(id)),
    };
}
</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºä¸€ä¸ªç»„ä»¶çš„æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœ€æ–°çš„æç¤ºå’Œé‡è¦æç¤ºä¸­é‡å¤ä½¿ç”¨ï¼Œå…¶ä¸­åŒ…æ‹¬åŒæ„æˆ–ä¸åŒæ„çš„é“¾æ¥ï¼š</p>
<pre><code>var Tip = props =&gt; (
    &lt;li&gt;
        {props.text} [&lt;a href=&quot;#&quot; onClick={() =&gt; props.onAgree(props.id)}&gt;Agree&lt;/a&gt;]
        [&lt;a href=&quot;#&quot; onClick={() =&gt; props.onDisagree(props.id)}&gt;Disagree&lt;/a&gt;]
    &lt;/li&gt;
);
</code></pre><p>ç„¶åæ˜¾ç¤ºä¸€ä¸ªæç¤ºåˆ—è¡¨ï¼Œæ ‡é¢˜ä¸ºï¼š</p>
<pre><code>var TipList = props =&gt; (
    &lt;div&gt;
        &lt;h2&gt;{props.heading}&lt;/h2&gt;
        &lt;ul&gt;
        {props.tips.map(t =&gt; &lt;Tip key={t.id} {...props} {...t} /&gt;)}
        &lt;/ul&gt;
    &lt;/div&gt;
);
</code></pre><p>æœ€åï¼ŒApp ç»„ä»¶å˜ä¸ºï¼š</p>
<pre><code>var App = props =&gt; (
    &lt;div&gt;
        &lt;SubmitTip tipText={props.tipText}
            onChangeTipText={props.onChangeTipText}
            onAddTip={props.onAddTip} /&gt;
        &lt;TipList heading=&quot;Latest Tips&quot; tips={props.latestTips}
            onAgree={props.onAgree} onDisagree={props.onDisagree} /&gt;
        &lt;TipList heading=&quot;Top Tips&quot; tips={props.topTips}
            onAgree={props.onAgree} onDisagree={props.onDisagree} /&gt;
    &lt;/div&gt;
);
</code></pre><p>æˆ‘ä»¬ç»ˆäºå¾—åˆ°å®ƒäº†ã€‚ npm run buildï¼Œåˆ·æ–°ï¼Œå¹¶ç»™å®ƒä¸€ä¸ªæ—‹è½¬ã€‚åœ¨ä»»ä¸€åˆ—è¡¨ä¸­å•å‡»åŒæ„æˆ–ä¸åŒæ„æœ€ç»ˆä¼šæ›´æ”¹é¡¶éƒ¨æç¤ºåˆ—è¡¨ä¸­çš„æ’åºé¡ºåºä»¥åæ˜ æŠ•ç¥¨ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬å®Œæˆäº†ã€‚</p>
<pre><code>$ git commit -m &quot;Add agree/disagree feature&quot; .
[master 5d792bc] Add agree/disagree feature
 6 files changed, 188 insertions(+), 18 deletions(-)
</code></pre><h2 id="summing-up">Summing up</h2>
<p>åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»é›¶åˆ°åº”ç”¨å•é¡µé¢åº”ç”¨ç¨‹åºã€‚å‰ç«¯æ˜¯ä½¿ç”¨ React å’Œ Redux åœ¨ç°ä»£ ES6 ä¸­ç¼–å†™çš„ã€‚ä½¿ç”¨ Croï¼Œåç«¯åœ¨ Raku ä¸­ã€‚å®ƒä»¬ä½¿ç”¨ HTTP å’Œ Web å¥—æ¥å­—è¿›è¡Œé€šä¿¡ã€‚å¹¶ä¸”ä¸¤è€…éƒ½å£°æ˜äº†å®ƒä»¬çš„ä¾èµ–å…³ç³»ï¼Œå› æ­¤æ–°å¼€å‘äººå‘˜çš„å…¥é—¨åªæ˜¯ä»¥ä¸‹æƒ…å†µï¼š</p>
<pre><code>zef install --deps-only .
npm install .
npm run build
cro run
</code></pre><p>å†ä¸€æ¬¡ï¼Œä»£ç å¯ç”¨äºæœ¬æ•™ç¨‹ä¸­æè¿°çš„æäº¤å†å²è®°å½•ã€‚</p>


        
          <div class="blog-tags">
            
              <a href="https://ohmysummer.github.io//tags/cro/">cro</a>&nbsp;
            
          </div>
        

        

        
          

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://ohmysummer.github.io/post/2018-07-20-%E4%BD%BF%E7%94%A8raku%E8%BF%9E%E6%8E%A5kafka/" data-toggle="tooltip" data-placement="top" title="ä½¿ç”¨ Raku è¿æ¥ Kafka">&larr; </a>
            </li>
          
          
            <li class="next">
              <a href="https://ohmysummer.github.io/post/2018-08-03-ping-pang-in-raku/" data-toggle="tooltip" data-placement="top" title="Ping Pang in Raku"> &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ohmysummer" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://ohmysummer.github.io/">ç„‰çŸ¥éé±¼</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://ohmysummer.github.io/">Raku Programming</a>
            with <span style="color: red;">â¤</span>
          
        </p>
        
        <p class="credits theme-by text-muted">
          
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://ohmysummer.github.io/js/main.js"></script>
<script src="https://ohmysummer.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://ohmysummer.github.io/js/load-photoswipe.js"></script>



<script>
  (function() {
    var cx = '009072066163920799339:qwme9vkotxk';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>







    
  </body>
</html>

