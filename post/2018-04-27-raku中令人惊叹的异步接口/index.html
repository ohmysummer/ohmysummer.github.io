<!DOCTYPE html>
<html lang="zh" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Awesome Async Interfaces with Raku - Raku Programming</title>
  <meta name="description" content="A tutorial for writing IRC bots with Raku">
  <meta name="author" content="焉知非鱼"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Raku Programming",
    
    "url": "https:\/\/ohmysummer.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/ohmysummer.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/ohmysummer.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/ohmysummer.github.io\/post\/2018-04-27-raku%E4%B8%AD%E4%BB%A4%E4%BA%BA%E6%83%8A%E5%8F%B9%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8E%A5%E5%8F%A3\/",
          "name": "Awesome async interfaces with raku"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "焉知非鱼"
  },
  "headline": "Awesome Async Interfaces with Raku",
  "description" : "2015 年圣诞节前后, 我写了我的第一个 Raku 程序 - 新年 IRC 派对机器人。这项工作包括发布了 IRC::Client 模块。我从这个语言中找到了童年的乐趣并且在假期喝了不少酒, 结果就是这个模块最终足够疯狂。",
  "inLanguage" : "zh",
  "wordCount":  1434 ,
  "datePublished" : "2018-04-26T10:54:24",
  "dateModified" : "2018-04-26T10:54:24",
  "image" : "https:\/\/ohmysummer.github.io\/img\/rakudo.png",
  "keywords" : [ "Raku, IRC" ],
  "mainEntityOfPage" : "https:\/\/ohmysummer.github.io\/post\/2018-04-27-raku%E4%B8%AD%E4%BB%A4%E4%BA%BA%E6%83%8A%E5%8F%B9%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8E%A5%E5%8F%A3\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/ohmysummer.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/ohmysummer.github.io\/img\/rakudo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Awesome Async Interfaces with Raku" />
<meta property="og:description" content="A tutorial for writing IRC bots with Raku">
<meta property="og:image" content="https://ohmysummer.github.io/img/rakudo.png" />
<meta property="og:url" content="https://ohmysummer.github.io/post/2018-04-27-raku%E4%B8%AD%E4%BB%A4%E4%BA%BA%E6%83%8A%E5%8F%B9%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8E%A5%E5%8F%A3/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Raku Programming" />

  <meta name="twitter:title" content="Awesome Async Interfaces with Raku" />
  <meta name="twitter:description" content="A tutorial for writing IRC bots with Raku">
  <meta name="twitter:image" content="https://ohmysummer.github.io/img/rakudo.png" />
  <meta name="twitter:card" content="summary" />
  <link href='https://ohmysummer.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.63.2" />
  <link rel="alternate" href="https://ohmysummer.github.io/index.xml" type="application/rss+xml" title="Raku Programming"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://ohmysummer.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://ohmysummer.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://ohmysummer.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'ohmycloudy', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://ohmysummer.github.io/">Raku Programming</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="博客" href="/">博客</a>
            </li>
          
        
          
            <li>
              <a title="归档" href="/categories">归档</a>
            </li>
          
        
          
            <li>
              <a title="关于" href="/page/about/">关于</a>
            </li>
          
        
          
            <li>
              <a title="标签" href="/tags">标签</a>
            </li>
          
        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg"></span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Raku Programming" href="https://ohmysummer.github.io/">
            <img class="avatar-img" src="https://ohmysummer.github.io/img/rakudo.png" alt="Raku Programming" />
          </a>
        </div>
      </div>
    

  </div>
</nav>



  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body">
          <gcse:search></gcse:search>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal"></button>
        </div>
      </div>
    </div>
  </div>


    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Awesome Async Interfaces with Raku</h1>
              
              
              
                
                  <h2 class="post-subheading">A tutorial for writing IRC bots with Raku</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;7&nbsp;
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;1434&nbsp;
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;焉知非鱼
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>2015 年圣诞节前后, 我写了我的第一个 Raku 程序 - 新年 IRC 派对机器人。这项工作包括发布了 <a href="https://github.com/zoffixznet/raku-IRC-Client/">IRC::Client</a> 模块。我从这个语言中找到了童年的乐趣并且在假期喝了不少酒, 结果就是这个模块最终足够疯狂。</p>
<p>最近, 我需要一个工具来完成一些 Raku 的 bug 队列工作, 因此我决定把自己关上一个周末, 从头开始重新设计和重写这个模块。在过去的几个月里, 有好几个人请求我这么做, 所以我想我也应该写一篇关于如何使用这个模块的教程 - 作为对我这个拖延症大师的道歉。如果你对 IRC 没有兴趣的话, 我希望这篇教程可以作为 Raku 中的异步、非阻塞接口的一个一般示例。</p>
<h2 id="基础">基础</h2>
<p>要创建一个 IRC 机器人, 请实例化一个 <code>IRC::Client</code> 对象, 给它一些基本信息, 然后调用 <code>.run</code> 方法。将所有你需要的功能实现为类, 并通过方法名匹配你想要监听的事件, 然后通过 <code>.plugins</code> 属性将其传递给所有的插件。当发生 IRC 事件时, 它会按照你指定的顺序传递给所有的插件, 如果有插件宣称处理了该事件就停止。</p>
<p>这里有一个简单的 IRC 机器人, 它可以响应在频道中找人、通知和发送给它的私人消息。下面这个响应是机器人收到的大写后的原始消息：</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;
.run with IRC::Client.new:
    :nick&lt;MahBot&gt;
    :host&lt;irc.freenode.net&gt;
    :channels&lt;#raku&gt;
    :debug
    :plugins(class { method irc-to-me ($_) { .text.uc } })
</code></pre><p>这就是机器人运行时的样子：</p>
<pre><code>&lt;Zoffix&gt; MahBot, I ♥ you!
&lt;MahBot&gt; Zoffix, I ♥ YOU!
</code></pre><p><code>:nick</code>, <code>:host</code> 和 <code>:channels</code> 是机器人的昵称、它应该连接的服务器以及它应该加入的频道。<code>:debug</code> 控制要显示多少调试输出。我们在这里将其值设置为 <code>1</code>, 用于显示稀疏的调试输出, 只是为了看看发生了什么。提示：安装可选的 <a href="https://modules.raku.org/repo/Terminal::ANSIColor">Terminal::ANSIColor</a> 模块可以使调试输出更好看：</p>
<p><img src="https://perl6.party/assets/pics/irc-bot/debug-output.png" alt="img"></p>
<p>对于 <code>.plugins</code> 属性, 我们传入了一个匿名类。如果你有多个插件, 只需按照你想让它们接收事件的顺序把它们都塞进去即可：</p>
<pre><code class="language-raku" data-lang="raku">:plugins(PlugFirst.new, PlugSecond.new(:conf), class { ... })
</code></pre><p>我们 uppercasing 机器人的插件类有一个单独的方法来监听 <code>irc-to-me</code> 事件, 每当机器人在频道中被寻址或被发送私信或通知时, 就会被触发。它接收单个参数：扮演 <code>IRC::Client::Message</code> 角色的对象之一。我们将其插入到 <code>$_</code> 主题变量中, 以节省一些输入。</p>
<p>我们通过从这个方法中返回一个值来响应该事件。原文包含在消息对象的 <code>.text</code> 属性中, 所以我们将调用 <code>.uc</code> 方法对内容进行大写, 这就是我们的响应。</p>
<p>就像我们的 uppercasing 机器人一样厉害, 它就像极地考察中的空调一样好用。让我们教给它一些技巧吧。</p>
<h2 id="变得更聪明">变得更聪明</h2>
<p>我们将调用我们的新插件 <code>Trickster</code>, 它响应命令 <code>time</code> - 这会给出当地的时间和日期 - 以及 <code>temp</code> - 将温度在华氏温度和摄氏温度之间进行转换。下面是代码：</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;

class Trickster {
    method irc-to-me ($_) {
        given .text {
            when /time/ { DateTime.now }
            when /temp \s+ $&lt;temp&gt;=\d+ $&lt;unit&gt;=[F|C]/ {
                when $&lt;unit&gt; eq 'F' { &quot;That's {($&lt;temp&gt; - 32) × .5556}°C&quot; }
                default             { &quot;That's { $&lt;temp&gt; × 1.8 + 32   }°F&quot; }
            }
            'huh?'
        }
    }
}

.run with IRC::Client.new:
    :nick&lt;MahBot&gt;
    :host&lt;irc.freenode.net&gt;
    :channels&lt;#raku&gt;
    :debug
    :plugins(Trickster)
</code></pre><pre><code>&lt;Zoffix&gt; MahBot, time
&lt;MahBot&gt; Zoffix, 2016-07-23T19:00:15.795551-04:00
&lt;Zoffix&gt; MahBot, temp 42F
&lt;MahBot&gt; Zoffix, That's 5.556°C
&lt;Zoffix&gt; MahBot, temp 42C
&lt;MahBot&gt; Zoffix, That's 107.6°F
&lt;Zoffix&gt; MahBot, I ♥ you!
&lt;MahBot&gt; Zoffix, huh?
</code></pre><p>这段代码很简单：我们将给定的文本传递给几个正则表达式。如果它包含单词 <code>time</code>, 我们会返回当前时间。如果它包含单词 <code>temp</code>, 我们会根据给定的数字是由 F 还是 C 后缀来进行适当的计算。而如果没有匹配发生, 我们最终会返回好奇的 <code>huh?</code>。</p>
<p>这个新的改进后的插件有一个明显的问题：机器人不再爱我了！虽然我还能熬过心痛, 但我怀疑任何其他插件都不会再教导机器人爱我了, 因为 <code>Trickster</code> 会消耗掉所有的 <code>irc-to-me</code> 事件, 即使它不识别任何它能处理的命令。让我们来解决这个问题吧！</p>
<h2 id="传递美元">传递美元</h2>
<p>事件处理程序可以返回一个特殊的值, 以表示它没有处理该事件, 并且应该将其传播给其它插件和事件处理程序。这个值是由 <code>IRC::Client::Plugin</code> 角色提供的 <code>.NEXT</code> 属性提供的, 插件可以 <code>does</code> 获取这个属性。当你使用 <code>IRC::Client</code> 时, 这个角色会自动导出。</p>
<p>让我们来看看一些利用这个特殊值的代码。请注意, 由于 <code>.NEXT</code> 是一个属性, 而我们无法在类型对象上查找属性, 所以你需要多走一步, 在将插件类实例化的时候, 将它们传递给 <code>:plugins</code>。</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;

class Trickster does IRC::Client::Plugin {
    method irc-to-me ($_) {
        given .text {
            when /time/ { DateTime.now }
            when /temp \s+ $&lt;temp&gt;=\d+ $&lt;unit&gt;=[F|C]/ {
                when $&lt;unit&gt; eq 'F' { &quot;That's {($&lt;temp&gt; - 32) × .5556}°C&quot; }
                default             { &quot;That's { $&lt;temp&gt; × 1.8 + 32   }°F&quot; }
            }
            $.NEXT;
        }
    }
}

class BFF does IRC::Client::Plugin {
    method irc-to-me ($_) {
        when .text ~~ /'♥'/ { 'I ♥ YOU!' };
        $.NEXT;
    }
}

.run with IRC::Client.new:
    :nick&lt;MahBot&gt;
    :host&lt;irc.freenode.net&gt;
    :channels&lt;#raku&gt;
    :debug
    :plugins(Trickster.new, BFF.new)
</code></pre><pre><code>&lt;Zoffix&gt; MahBot, time
&lt;MahBot&gt; Zoffix, 2016-07-23T19:37:45.788272-04:00
&lt;Zoffix&gt; MahBot, temp 42F
&lt;MahBot&gt; Zoffix, That's 5.556°C
&lt;Zoffix&gt; MahBot, temp 42C
&lt;MahBot&gt; Zoffix, That's 107.6°F
&lt;Zoffix&gt; MahBot, I ♥ you!
&lt;MahBot&gt; Zoffix, I ♥ YOU!
</code></pre><p>我们现在有两个插件都订阅了 <code>irc-to-me</code> 事件。 <code>:plugins</code> 属性首先接收 <code>Trickster</code> 插件, 所以它的事件处理程序将首先运行。如果接收到的文本与 <code>Trickster</code> 的任何一个正则表达式中的都不匹配, 它将从该方法返回 <code>$.NEXT</code>。</p>
<p>这就给客户端对象发出了寻找其他处理程序的信号, 所以它就会到达 <code>BFF</code> 的 <code>irc-to-me</code> 处理程序。在那里, 如果输入中是否包含爱心, 我们就会回复, 如果没有, 我们也会在这里预先返回 <code>$.NEXT</code>。</p>
<p>当机器人恢复了它的晴朗的性格, 但它是以额外的打字为代价的。我们能做些什么呢？</p>
<h2 id="万物多变">万物多变</h2>
<p>Raku 支持多重分派以及签名中的类型约束。除此之外, 如果 <code>IRC::Client</code> 的消息对象有 <code>.text</code> 属性, 那么 smartmatch 就会使用该属性的值。将这三个特性结合起来, 你就可以得到一个非常简洁的代码：</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;
class Trickster {
    multi method irc-to-me ($ where /time/) { DateTime.now }
    multi method irc-to-me ($ where /temp \s+ $&lt;temp&gt;=\d+ $&lt;unit&gt;=[F|C]/) {
        $&lt;unit&gt; eq 'F' ?? &quot;That's {($&lt;temp&gt; - 32) × .5556}°C&quot;
                       !! &quot;That's { $&lt;temp&gt; × 1.8 + 32   }°F&quot;
    }
}

class BFF { method irc-to-me ($ where /'♥'/) { 'I ♥ YOU!' } }

.run with IRC::Client.new:
    :nick&lt;MahBot&gt;
    :host&lt;irc.freenode.net&gt;
    :channels&lt;#raku&gt;
    :debug
    :plugins(Trickster, BFF)
</code></pre><pre><code>&lt;Zoffix&gt; MahBot, time
&lt;MahBot&gt; Zoffix, 2016-07-23T19:59:44.481553-04:00
&lt;Zoffix&gt; MahBot, temp 42F
&lt;MahBot&gt; Zoffix, That's 5.556°C
&lt;Zoffix&gt; MahBot, temp 42C
&lt;MahBot&gt; Zoffix, That's 107.6°F
&lt;Zoffix&gt; MahBot, I ♥ you!
&lt;MahBot&gt; Zoffix, I ♥ YOU!
</code></pre><p>在签名之外, 我们不再需要消息对象, 所以我们可以使用匿名 <code>$</code> 参数来代替它。然后, 我们使用正则表达式匹配的类型来<a href="https://raku.party/post/Perl-6-Types--Made-for-Humans#subsets:tailor-madetypes">约束</a>这个参数, 因此只有当消息的文本与这个正则表达式匹配时, 方法才会被调用。因为没有方法会在失败时被调用, 所以我们不再需要在插件中加入 <code>$.NEXT</code>, 也不需要在插件中添加任何角色。</p>
<p>我们方法的主体都有一个单独的语句产生事件的响应值。在温度转换器中, 我们使用三元运算符来选择转换时使用哪个公式, 这取决于所请求的单位, 是的, 在签名类型约束匹配中创建的 <code>$&lt;unit&gt;</code> 和 <code>$&lt;temp&gt;</code> 捕获可用于该方法的主体。</p>
<h2 id="多事之秋">多事之秋</h2>
<p>除了标准的命名和数字 IRC 协议事件外, <code>IRC::Client</code> 还提供了方便事件。其中一个我们已经看到过：<code>irc-to-me</code> 事件。这样的事件是分层的, 所以一个 IRC 事件可以触发多个 <code>IRC::Client</code> 的事件。例如, 如果有人在频道中 @ 我们的机器人, 就会触发以下事件链：</p>
<pre><code>irc-addressed  ▶  irc-to-me  ▶  irc-privmsg-channel  ▶  irc-privmsg  ▶  irc-all
</code></pre><p>这些事件从&quot;最窄&quot;到&quot;最宽&quot;排列：当我们的机器人被 @ 时, 才会在频道中触发 <code>irc-addressed</code>。 <code>irc-to-me</code> 也可以通过通知和私信触发, 所以它的范围更宽; <code>irc-privmsg-channel</code> 包含所有频道消息, 所以它的范围仍然更宽; 而 <code>irc-privmsg</code> 也包含给我们的机器人的私信。这条链以其中最宽的事件结束：<code>irc-all</code>。</p>
<p>如果插件的事件处理程序返回 <code>$.NEXT</code> 以外的任何值, 那么事件链后面的事件就不会被触发, 就像插件链中后面的插件也不会因为同样的原因而被尝试一样。每个事件都会在所有的插件上进行尝试, 然后再尝试处理更宽的事件。</p>
<p>通过将 <code>:debug</code> 属性设置为 3 级或更高的级别, 你会在调试输出中得到发射的事件。下面是我们的机器人尝试处理未知的命令 <code>blarg</code>, 然后处理由我们定义的 <code>irc-to-me</code> 事件处理程序处理的命令 <code>time</code>：</p>
<p><img src="https://perl6.party/assets/pics/irc-bot/debug-output2.png" alt="img"></p>
<p><code>IRC::Client</code> 的所有事件都有 <code>irc-</code> 前缀, 所以你可以在插件中自由定义辅助方法, 不用担心与事件处理程序冲突。说到发出的东西&hellip;&hellip;</p>
<h2 id="让它们来吧">让它们来吧!</h2>
<p>响应命令是很好的, 但很多机器人可能会希望自己主动产生一些输出。作为一个例子, 让我们写一个机器人, 每当我们有未读的 GitHub 通知时, 它会来过来烦我们！</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;
use HTTP::Tinyish;
use JSON::Fast;

class GitHub::Notifications does IRC::Client::Plugin {
    has Str  $.token  = %*ENV&lt;GITHUB_TOKEN&gt;;
    has      $!ua     = HTTP::Tinyish.new;
    constant $API_URL = 'https://api.github.com/notifications';

    method irc-connected ($) {
        start react {
            whenever self!notification.grep(* &gt; 0) -&gt; $num {
                $.irc.send: :where&lt;Zoffix&gt;
                            :text(&quot;You have $num unread notifications!&quot;)
                            :notice;
            }
        }
    }

    method !notification {
        supply {
            loop {
                my $res = $!ua.get: $API_URL, :headers{ :Authorization(&quot;token $!token&quot;) };
                $res&lt;success&gt; and emit +grep *.&lt;unread&gt;, |from-json $res&lt;content&gt;;
                sleep $res&lt;headers&gt;&lt;X-Poll-Interval&gt; || 60;
            }
        }
    }
}

.run with IRC::Client.new:
    :nick&lt;MahBot&gt;
    :host&lt;irc.freenode.net&gt;
    :channels&lt;#raku&gt;
    :debug
    :plugins(GitHub::Notifications.new)
</code></pre><pre><code>[00:25:41] -MahBot- Zoffix, You have 20 unread notifications!
[00:26:41] -MahBot- Zoffix, You have 19 unread notifications!
</code></pre><p>我们创建了一个 <code>does</code> <code>IRC::Client::Plugin</code> 角色的 <code>GitHub::Notifications</code> 类。这个角色为我们提供了 <code>$.irc</code> 属性, 这是我们将用于在 IRC 上向我们发送消息的 <code>IRC::Client</code> 对象。</p>
<p>除了 <code>irc-connected</code> 方法之外, 这个类也和其他类一样：用于我们的 GitHub API token 的公共 <code>$.token</code> 属性, 用于保留 HTTP 用户代理对象的私有 <code>$!ua</code> 属性以及私有的 <code>notification</code> 方法, 所有的操作都是在这里发生的。</p>
<p>在 <code>notification</code> 内部, 我们创建了一个 <a href="https://docs.raku.org/type/Supply">Supply</a>, 它将发布未读通知的数量。它通过使用 <a href="https://modules.raku.org/repo/HTTP::Tinyish">HTTP::Tinyish</a> 对象来访问 GitHub API 端点。在第 24 行, 它解析成功请求返回的 JSON, 并在消息列表中搜索任何 <code>unread</code> 属性设置为 <code>true</code> 的项目。前缀 <code>+</code> 运算符将列表转换为一个 <code>Int</code>, 即找到的总项目, 这也是我们从 supply 中 <code>emit</code> 的内容。</p>
<p>当我们成功连接到 IRC 服务器时, 会触发 <code>irc-connected</code> 的事件处理程序。其中, 我们启动(<code>start</code>)一个事件循环, 当我们收到由 <code>notifications</code> 方法给出的当前未读消息数时, 就会启动一个事件循环进行响应。因为我们只对有未读消息的情况感兴趣, 所以我们也会在 supply 上弹出一个 <code>grep</code> 来过滤掉没有消息的情况（没错, 我们可以在第一时间避免发送这些消息, 但我只是在这里炫耀一下 Raku 😸）。一旦有未读消息, 我们只需调用 <code>IRC::Client</code> 的 <code>.send</code> 方法, 让它发送一条 IRC 通知, 并注明未读消息的总数。真是太神奇了！</p>
<h2 id="别等了">别等了</h2>
<p>我们涵盖了我们发送到 IRC 的异步数据供应值, 或者马上回复命令的情况。机器人命令需要一些时间来执行的情况并不少见。在这些情况下, 我们不希望在命令执行的过程中, 机器人被锁定。</p>
<p>多亏了 Raku 的优秀的并发原语, 它就不必这样做了！如果事件处理程序返回一个 <a href="https://docs.raku.org/type/Promise">Promise</a>, 则客户端对象将在保存(kept)时使用它的 <code>.result</code> 作为回复。这意味着, 为了使我们的阻塞事件处理程序不阻塞, 我们要做的就是把它的主体封装在一个 <code>start {...}</code> 块中。还有什么能比这更简单呢？</p>
<p>作为一个例子, 让我们来写一个机器人来响应 <code>bash</code> 命令。该机器人将获取 <a href="http://bash.org/?random1">bash.org/?random1</a>, 解析出 HTML 中的引号, 并将其保存在缓存中。当命令被触发时, 机器人会把其中的一个引号递送出去, 当缓存用完时, 重复提取。特别是, 我们不希望机器人在检索和解析网页的过程中出现阻塞。下面是完整的代码：</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;
use Mojo::UserAgent:from&lt;Perl5&gt;;

class Bash {
    constant $BASH_URL = 'http://bash.org/?random1';
    constant $cache    = Channel.new;
    has        $!ua    = Mojo::UserAgent.new;

    multi method irc-to-me ($ where /bash/) {
        start $cache.poll or do { self!fetch-quotes; $cache.poll };
    }

    method !fetch-quotes {
        $cache.send: $_
            for $!ua.get($BASH_URL).res.dom.find('.qt').each».all_text.lines.join: '  ';
    }
}

.run with IRC::Client.new:
    :nick&lt;MahBot&gt;
    :host&lt;irc.freenode.net&gt;
    :channels&lt;#raku&gt;
    :debug
    :plugins(Bash.new)
</code></pre><pre><code>&lt;Zoffix&gt; MahBot, bash
&lt;MahBot&gt; Zoffix, &lt;Time&gt; that reminds me of when Manning and I installed OS/2 Warp4 on a box and during the install routine it said something to the likes of 'join the hundreds of people on the internet'
</code></pre><p>为了满足页面抓取的需求, 我选择了 Perl 5 的 <a href="https://metacpan.org/pod/Mojo::UserAgent">Mojo::UserAgent</a>, 因为它有内置了一个 HTML 解析器。 <code>:from&lt;Perl5&gt;</code> 副词向编译器指示我们要加载一个 Perl 5 模块, 而不是 Raku 模块。</p>
<p>由于我们是多线程的, 因此我们将使用一个 <a href="https://docs.raku.org/type/Channel">Channel</a> 作为线程安全队列来进行缓存。我们订阅了文字包含单词 <code>bash</code> 的 <code>irc-to-me</code> 事件。当事件处理程序被触发时, 我们使用 <code>start</code> 关键字弹出到一个新的线程。然后, 我们会轮询(<code>.poll</code>)我们的缓存并使用缓存值（如果我们有缓存值的话）, 否则, 逻辑将转移到调用 <code>fetch-quotes</code> 私有方法的 <code>do</code> 块上, 并在完成时再次轮询缓存, 获得新的引用。所有的事情完成后, 引用将是我们从事件处理程序返回的 <code>Promise</code> 的结果。</p>
<p><code>fetch-quotes</code> 方法启动我们的 <code>Mojo::UserAgent</code> 对象, 从网站上获取随机引用页面, 找到所有带 <code>class=&quot;qt&quot;</code> 的 HTML 元素 - 这些是带引号的段落。然后, 我们使用一个 hyper 方法调用将这些段落转换为文本, 并通过 <code>for</code> 循环将最终列表提供给我们的 <code>$cache Channel</code>。就这样, 我们将我们的机器人无阻塞地连接到 IRC 世界的宿主上了。说到这里, 你可能要过滤一下&hellip;</p>
<h2 id="注意你的言行">注意你的言行！</h2>
<p>如果我们的机器人向频道喷出大量的输出, 我们的机器人很快就会被禁止。一个明显的解决方案是在我们的插件中加入逻辑, 如果输出量过大, 就会使用 pastebin。然而, 在我们编写的每一个插件中添加这样的东西是非常不现实的。幸运的是, <code>IRC::Client</code> 已经支持过滤器了！</p>
<p>对于任何发出 <code>NOTICE</code> 或 <code>PRIVMSG</code> IRC 命令的方法, <code>IRC::Client</code> 都会通过 <code>:filters</code> 属性将输出通过类传递给它 。这意味着我们可以设置一个过滤器, 无论它来自哪个插件, 都会自动粘贴大容量的输出。</p>
<p>我们将重新使用我们的 bash.org 引用机器人, 只是这次它会将大量引用粘贴到 <a href="pastebin::Shadowcat">Shadowcat pastebin</a> 中。让我们来看看一些代码吧！</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;
use Pastebin::Shadowcat;
use Mojo::UserAgent:from&lt;Perl5&gt;;

class Bash {
    constant $BASH_URL = 'http://bash.org/?random1';
    constant $cache    = Channel.new;
    has        $!ua    = Mojo::UserAgent.new;

    multi method irc-to-me ($ where /bash/) {
        start $cache.poll or do { self!fetch-quotes; $cache.poll };
    }

    method !fetch-quotes {
        $cache.send: $_
            for $!ua.get($BASH_URL).res.dom.find('.qt').each».all_text;
    }
}

.run with IRC::Client.new:
    :nick&lt;MahBot&gt;
    :host&lt;irc.freenode.net&gt;
    :channels&lt;#zofbot&gt;
    :debug
    :plugins(Bash.new)
    :filters(
        -&gt; $text where .lines &gt; 1 || .chars &gt; 300 {
            Pastebin::Shadowcat.new.paste: $text.lines.join: &quot;\n&quot;;
        }
    )
</code></pre><pre><code>&lt;Zoffix&gt; MahBot, bash
&lt;MahBot&gt; Zoffix, &lt;intuit&gt; hmm maybe sumtime next week i will go outside'
&lt;Zoffix&gt; MahBot, bash
&lt;MahBot&gt; Zoffix, http://fpaste.scsys.co.uk/528741
</code></pre><p>完成所有过滤工作的代码很小, 很容易出错 - 就是上面程序中的最后5行。 <code>:filters</code> 属性接收一个 <a href="https://docs.raku.org/type/Callable">Callables</a> 列表, 这里我们传递了一个尖号块。在它的签名中, 我们将文本限制为超过 1 行或超过 300 个字符, 因此只有满足这些条件时, 我们的过滤器才会运行。在这个块中, 我们只需使用 <a href="https://modules.raku.org/repo/Pastebin::Shadowcat">Pastebin::Shadowcat</a> 模块将输出扔到 pastebin 中。它的 <code>.paste</code> 方法返回新创建的粘贴的 URL, 我们的过滤器将用它来替换原始内容。非常棒！</p>
<h2 id="像黄油一样扩散">像黄油一样扩散</h2>
<p>在过去, 当我使用其他 IRC 客户端工具时, 每当有人要求我把机器人放到其他服务器上时, 过程很简单：把代码复制到另一个目录下, 修改配置, 就可以了。这几乎是有道理的, 新服务器意味着一个&quot;新&rdquo; 的机器人：不同的频道、不同的昵称等等。</p>
<p>在 Raku 的 IRC::Client 中, 我尝试重新想象了一下：服务器只是消息的另一个标识符, 还有一个频道或昵称。这意味着把你的机器人连接到多个服务器, 就如同通过 <code>:server</code> 属性添加新的服务器配置一样简单：</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;

class BFF {
    method irc-to-me ($ where /'♥'/) { 'I ♥ YOU!' }
}

.run with IRC::Client.new:
    :debug
    :plugins(BFF)
    :nick&lt;MahBot&gt;
    :channels&lt;#zofbot&gt;
    :servers(
        freenode =&gt; %(
            :host&lt;irc.freenode.net&gt;,
        ),
        local =&gt; %(
            :nick&lt;P6Bot&gt;,
            :channels&lt;#zofbot #raku&gt;,
            :host&lt;localhost&gt;,
        )
    )
</code></pre><pre><code>[on Freenode server]
&lt;ZoffixW&gt; MahBot, I ♥ you
&lt;MahBot&gt; ZoffixW, I ♥ YOU!

[on local server]
&lt;ZoffixW&gt; P6Bot, I ♥ you
&lt;P6Bot&gt; ZoffixW, I ♥ YOU!
</code></pre><p>首先, 我们的插件仍然没有意识到它正在在多个服务器上运行。它的回复被重定向到正确的服务器, <code>IRC::Client</code> 仍然以线程安全的方式执行它的方法处理程序。</p>
<p>在 <code>IRC::Client</code> 的构造函数中, 我们添加了接收 <code>Hash</code> 的 <code>:servers</code> 属性。这个 <code>Hash</code> 的键是服务器的标签, 值是服务器特定的配置, 可覆盖全局设置。所以, <code>freenode</code> 服务器从我们提供给 <code>IRC::Client</code> 的 <code>:nick</code> 和 <code>:channels</code> 属性获取它的 <code>:nick</code> 和 <code>:channels</code> 属性, 而 <code>local</code> 服务器使用它自己的值覆盖这些属性。</p>
<p>现在, 调试输出中会打印出服务器标签, 以指示该事件适用于哪个服务器：</p>
<p><img src="https://perl6.party/assets/pics/irc-bot/debug-output3.png" alt="img"></p>
<p>就这样, 但只是简单地告诉机器人连接到另一台服务器, 我们就把它变成了多服务器, 而没有对我们的插件做任何改动。但是, 当我们真的要和特定的服务器对话时, 我们该怎么做呢？</p>
<h2 id="发送它的方式">发送它的方式</h2>
<p>当机器人被 <code>.run</code> 时, 客户端对象会将 <code>:servers</code> 属性的值变为 <code>IRC::Client::Server</code> 对象。这些字符串化为它们所代表的服务器的标签, 我们可以从消息对象的 <code>.server</code> 属性或客户端对象的 <code>.servers</code> hash 属性中获取。客户端对象的方法（如 <code>.send</code> 或 <code>.join</code>）都接收一个可选的 <code>server</code> 属性来控制消息将被发送到哪个服务器, 默认值为 <code>*</code>, 也就是发送到每个服务器。</p>
<p>这里有一个连接到两台服务器并加入几个频道的机器人。每当它看到一条频道消息时, 它就会把它转发到其他所有的频道, 并在由 <code>local</code> 标签指定的服务器上向用户 <code>Zoffix</code> 发送一条私信。</p>
<pre><code class="language-raku" data-lang="raku">use IRC::Client;

class Messenger does IRC::Client::Plugin {
    method irc-privmsg-channel ($e) {
        for $.irc.servers.values -&gt; $server {
            for $server.channels -&gt; $channel {
                next if $server eq $e.server and $channel eq $e.channel;

                $.irc.send: :$server, :where($channel), :text(
                    &quot;$e.nick() over at $e.server.host()/$e.channel() says $e.text()&quot;
                );
            }
        }

        $.irc.send: :where&lt;Zoffix&gt;
                    :text('I spread the messages!')
                    :server&lt;local&gt;;
    }
}

.run with IRC::Client.new:
    :debug
    :plugins[Messenger.new]
    :nick&lt;MahBot&gt;
    :channels&lt;#zofbot&gt;
    :servers{
        freenode =&gt; %(
            :host&lt;irc.freenode.net&gt;,
        ),
        local =&gt; %(
            :nick&lt;P6Bot&gt;,
            :channels&lt;#zofbot #raku&gt;,
            :host&lt;localhost&gt;,
        )
    }
</code></pre><pre><code>[on Freenode server/#zofbot]
&lt;ZoffixW&gt; Yey!
[on local server/#zofbot]
&lt;P6Bot&gt; ZoffixW over at irc.freenode.net/#zofbot says Yey!
[on local server/#raku]
&lt;P6Bot&gt; ZoffixW over at irc.freenode.net/#zofbot says Yey!
[on local server/ZoffixW private message queue]
&lt;P6Bot&gt; I spread the messages!
</code></pre><p>我们订阅了 <code>irc-privmsg-channel</code> 事件, 当它被触发时, 我们会遍历所有的服务器。对于每台服务器, 我们循环遍历所有连接的频道, 并使用 <code>$.irc.send</code> 方法向该频道和服务器发送消息, 除非服务器和频道与消息的来源相同。</p>
<p>消息本身会调用消息对象上的 <code>.nick</code>, <code>.channel</code> 和 <code>.server.host</code> 方法来识别消息的发送者和来源。</p>
<h2 id="结论">结论</h2>
<p>Raku 提供了强大的并发原语, 调度方法和自省功能, 使你可以构建出令人惊叹的非阻塞、基于事件的接口。<code>IRC::Client</code> 就是其中之一, 它可以让你使用 IRC 网络。它就在这里。它 已经准备好了。使用它吧！</p>
<p>原文地址: <a href="https://perl6.party/post/IRC-Client-Perl-6-Multi-Server-IRC-Module">https://perl6.party/post/IRC-Client-Perl-6-Multi-Server-IRC-Module</a></p>


        
          <div class="blog-tags">
            
              <a href="https://ohmysummer.github.io//tags/raku/">Raku</a>&nbsp;
            
              <a href="https://ohmysummer.github.io//tags/irc/">IRC</a>&nbsp;
            
          </div>
        

        

        
          
            
          

          
                  <h4 class="see-also"></h4>
                  <ul>
                
                
                    <li><a href="/post/2019-07-31-parse-with-raku-regexes-and-grammars/">Parse with Raku Regexes and Grammars</a></li>
                
                    <li><a href="/post/2019-07-16-encode-decode/">Encode-Decode</a></li>
                
                    <li><a href="/post/2019-06-29-odd-even-sort-in-raku/">Raku 中的 奇偶排序</a></li>
                
                    <li><a href="/post/2019-06-27-pancake-sort-in-raku/">Raku 中的煎饼排序</a></li>
                
                    <li><a href="/post/2019-06-28-gnome-sort-in-raku/">Raku 中的 Gnome sort</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://ohmysummer.github.io/post/2018-04-16-cro-http-client/" data-toggle="tooltip" data-placement="top" title="Cro::HTTP::Client">&larr; </a>
            </li>
          
          
            <li class="next">
              <a href="https://ohmysummer.github.io/post/2018-05-05-datetime/" data-toggle="tooltip" data-placement="top" title="DateTime"> &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ohmysummer" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://ohmysummer.github.io/">焉知非鱼</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2019
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://ohmysummer.github.io/">Raku Programming</a>
            with <span style="color: red;">❤</span>
          
        </p>
        
        <p class="credits theme-by text-muted">
          
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://ohmysummer.github.io/js/main.js"></script>
<script src="https://ohmysummer.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://ohmysummer.github.io/js/load-photoswipe.js"></script>



<script>
  (function() {
    var cx = '009072066163920799339:qwme9vkotxk';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>







    
  </body>
</html>

