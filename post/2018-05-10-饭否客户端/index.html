<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="ohmysummer">
    <meta name="description" content="ohmysummer&#39;s personal website">
    <meta name="keywords" content="Perl6,Rakudo">

    <base href="http://ohmysummer.github.io/">
    <title>
  饭否客户端 · 焉知非鱼
</title>

    <link rel="canonical" href="http://ohmysummer.github.io/post/2018-05-10-%E9%A5%AD%E5%90%A6%E5%AE%A2%E6%88%B7%E7%AB%AF/">

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Merriweather:300,700|Source+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.cd087ace86754b082dec94545567f8361cba42e84f8e15edbc4a9f6e52bd1f6a.css" integrity="sha256-zQh6zoZ1Swgt7JRUVWf4Nhy6QuhPjhXtvEqfblK9H2o=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://ohmysummer.github.io/css/style.css">
    

    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.49" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://ohmysummer.github.io/">
      焉知非鱼
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/post">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/categories">归档</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/page/about/">关于</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/tags">标签</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>饭否客户端</h1>
    </header>

    <p>Inspired by fanfou-py</p>

<pre><code class="language-perl6">use Digest::HMAC;
use Digest;
use Digest::SHA;
use MIME::Base64;
use URI::Encode;
use URI;
use Cro::HTTP::Client;

#  URL 编码
sub oauth_escape($s){
    return uri_encode_component($s.Str);
}

# 返回当前时间戳
sub oauth_timestamp() {
    return time;
}

# 单次值, 返回一个8位的随机字符串, 防止重复请求
sub oauth_nonce($size=8) {
    return ((1..9).pick for 1..$size).join(&quot;&quot;);
}

# 返回按一定顺序拼接好的字符串
sub oauth_query(%args) {
    return (sprintf &quot;%s=%s&quot;, $_, oauth_escape(~%args{$_}) for %args.keys.sort).join('&amp;');
}

# URL 正规化
sub oauth_normalized_url($url){
    my URI $u .= new($url);
    return sprintf('%s://%s%s', $u.scheme, $u.host, $u.path);
}

class Auth {
    has %.oauth_consumer    is rw = {};
    has %.oauth_token       is rw = {};
    has $.callback          is rw = 'http://localhost:8080/callback';
    has $.auth_host         is rw = 'http://m.fanfou.com';
    has $.form_urlencoded   is rw = 'application/x-www-form-urlencoded';
    has $.base_api_url      is rw = 'http://api.fanfou.com%s.json';
    has $.access_token_url  is rw = 'http://fanfou.com/oauth/access_token';
    has $.request_token_url is rw = 'http://fanfou.com/oauth/request_token';
    has $.authorize_url     is rw = $!auth_host ~ '/oauth/authorize?oauth_token=%s&amp;oauth_callback=%s';

    # 加密算法
    method HMAC_SHA1($key_string, $base_string) {
        return MIME::Base64.encode(hmac($key_string, $base_string, &amp;sha1));
    }

    # 签名值 https://github.com/FanfouAPI/FanFouAPIDoc/wiki/Oauthsignature
    method oauth_signature($url, $method, %base_args) {
        my $normalized_url = oauth_normalized_url($url);
        my $query_items    = oauth_query(%base_args);
        my @base_elems     = ($method.uc, $normalized_url, $query_items);
        my $base_string    = (oauth_escape($_) for @base_elems).join(&quot;&amp;&quot;);
        my @keys_elems     = (%.oauth_consumer{'secret'}, %.oauth_token{'secret'} // '');
        my $keys_string    = (oauth_escape($_) for @keys_elems).join(&quot;&amp;&quot;);
        return self.HMAC_SHA1($keys_string, $base_string);
    }

    method oauth_header(%base_args, $realm='') {
        my $auth_header = 'OAuth realm=&quot;%s&quot;'.sprintf($realm);
        for %base_args.keys.sort -&gt; $key {
            if $key.starts-with('oauth_') or $key.starts-with('x_auth_') {
                $auth_header ~= ', %s=&quot;%s&quot;'.sprintf($key, oauth_escape(%base_args{$key}));
            }
        }
        return {'Authorization' =&gt; $auth_header};
    }

    method oauth_request($url is copy, $method='GET', %args={}, %headers={}) {
        my %base_args =  'oauth_consumer_key'     =&gt; %!oauth_consumer{'key'},
                         'oauth_signature_method' =&gt; 'HMAC-SHA1',
                         'oauth_timestamp'        =&gt; oauth_timestamp(),
                         'oauth_nonce'            =&gt; oauth_nonce(),
                         'oauth_version'          =&gt; '1.0';

        %args = %args.clone;
        %headers = %headers.clone;
        %headers{'User-Agent'} = %headers{'User-Agent'} // 'Cro';

        if $url.starts-with('/') {
           if $url.contains(':') {
                 my ($path,$) = $url.split(':');
                 if %args{'id'} {
                     $url = $path ~ oauth_escape(%args{'id'});
                 } else {
                     $url = $path.chop;
                 }
           }
           $url = $!base_api_url.sprintf($url);
        }

        if $method eq 'POST' {
            %headers{'content-type'} = %headers{'content-type'} // self.form_urlencoded;
            (%headers{'content-type'} eq self.form_urlencoded) and (%base_args ,= %args);
        } else {
            %base_args ,= %args;
            $url = $url ~ '?' ~ oauth_query(%args);
        }

        self.oauth_token and %base_args ,= {'oauth_token' =&gt; self.oauth_token{'key'}};
        %base_args{'oauth_signature'} = self.oauth_signature($url, $method, %base_args);
        %headers ,= self.oauth_header(%base_args);

        my $resp;
        my $data = &quot;&quot;;
        if (%headers{'content-type'} // '') eq self.form_urlencoded {
            $data = oauth_query(%args);
        } elsif (%headers{'content-type'} // '').contains('form-data') { # multipart/form-data
            $data = %args{'form-data'};
        } else {
            $data = &quot;&quot;;
        }

        my $client = Cro::HTTP::Client.new( headers =&gt; |%headers );

        if $data {
            $resp = await $client.post: $url,  body =&gt; |%args ;
        } else {
            $resp = await $client.get: $url;
        }
        return $resp;
    }
}

class OAuth is Auth {
    method request($url, $method='GET', %args={}, %headers={}) {
        return self.oauth_request($url, $method, %args, %headers);
    }

    method request_token() {
        my $resp = self.oauth_request(self.request_token_url, 'GET');
        my %oauth_token = (await $resp.body-text()).Str.split('&amp;')».split('=').flat.hash;
        self.authorize_url = self.authorize_url.sprintf(%oauth_token{'oauth_token'}, self.callback);
        self.oauth_token = 'key' =&gt; %oauth_token{'oauth_token'}, 'secret' =&gt; %oauth_token{'oauth_token_secret'};
        return self.oauth_token;
    }

    method access_token(%oauth_token={},$oauth_verifier=Nil) {
        self.oauth_token = %oauth_token or self.oauth_token;
        my %args = do if $oauth_verifier { 'oauth_verifier' =&gt; $oauth_verifier } else { {} };
        my $resp = self.oauth_request(self.access_token_url, 'GET', %args);
        %oauth_token = (await $resp.body-text()).Str.split('&amp;')».split('=').flat.hash;
        self.oauth_token = 'key' =&gt; %oauth_token{'oauth_token'}, 'secret' =&gt; %oauth_token{'oauth_token_secret'};
        return self.oauth_token;
    }
}

class XAuth is Auth {
    has $.username is rw;
    has $.password is rw;
    has %.oauth_token is rw = self.xauth();

    method request($url, $method='GET', %args={}, %headers={}) {
        return self.oauth_request($url, $method, %args, %headers);
    }

    method xauth() {
        my %args =  'x_auth_username' =&gt; $!username,
                    'x_auth_password' =&gt; $!password,
                    'x_auth_mode'     =&gt; 'client_auth';

        my $resp = self.oauth_request(self.access_token_url, 'GET', %args);
        my %oauth_token = (await $resp.body-text()).Str.split('&amp;')».split('=').flat.hash;
        return {'key' =&gt; %oauth_token{'oauth_token'}, 'secret' =&gt; %oauth_token{'oauth_token_secret'}};
    }

    method access_token() {
        return self.oauth_token;
    }
}
</code></pre>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
      <p>ohmysummer ❤ Perl 6</p>
    
    
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
