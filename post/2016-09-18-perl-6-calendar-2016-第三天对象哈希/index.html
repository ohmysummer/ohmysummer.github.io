<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="ohmysummer">
    <meta name="description" content="ohmysummer&#39;s personal website">
    <meta name="keywords" content="Perl6,Rakudo">

    <base href="http://ohmysummer.github.io/">
    <title>
  对象哈希 · 焉知非鱼
</title>

    <link rel="canonical" href="http://ohmysummer.github.io/post/2016-09-18-perl-6-calendar-2016-%E7%AC%AC%E4%B8%89%E5%A4%A9%E5%AF%B9%E8%B1%A1%E5%93%88%E5%B8%8C/">

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Merriweather:300,700|Source+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.cd087ace86754b082dec94545567f8361cba42e84f8e15edbc4a9f6e52bd1f6a.css" integrity="sha256-zQh6zoZ1Swgt7JRUVWf4Nhy6QuhPjhXtvEqfblK9H2o=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://ohmysummer.github.io/css/style.css">
    

    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.49" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://ohmysummer.github.io/">
      焉知非鱼
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/post">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/categories">归档</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/page/about/">关于</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/tags">标签</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>对象哈希</h1>
    </header>

    <p><a href="https://perl6advent.wordpress.com/2016/12/03/day-3-object-hashes/">第三天　－　对象哈希</a></p>

<p>Perl 6 添加对象散列, 其键并不仅仅是字符串。这些键是值和类型的结合。这意味着对象可以被字符串化为同样的东西但是它们可以是不同的键。</p>

<p>普通的哈希构造：</p>

<pre><code class="language-perl6">use v6;

my Int    $int     = 4;
my Str    $str     = &quot;4&quot;;
my IntStr $int_str = &lt;4&gt;;  # Allomorph

my %hash;
%hash{$int}     = 'Plain old number';
%hash{$str}     = 'String of digits';
%hash{$int_str} = 'Dualvar';

say &quot;There are &quot;, %hash.elems, &quot; elements in the hash&quot;;

# this calls the .gist method, sorta like a dumper routine
%hash.say;
</code></pre>

<p>结果显示该哈希中只有一个元素并且这个元素是我最后添加的那个：</p>

<pre><code>There are 1 elements in the hash
{4 =&gt; Dualvar}
</code></pre>

<p>但是我也可以通过告诉哈希我想要它接受的对象来声明一个对象哈希（Object hash）。我可以使用　<code>Any</code> 对象来允许哈希接受任何东西：</p>

<pre><code class="language-perl6">my %hash{Any}; # accept any sort of object
</code></pre>

<p>下面的程序几乎和上面的一样，但是表现的很不同：</p>

<pre><code class="language-perl6">use v6;

my Int    $int     = 4;
my Str    $str     = &quot;4&quot;;
my IntStr $int_str = &lt;4&gt;;  # Allomorph

my %hash{Any};
%hash{$int}     = 'Plain old number';
%hash{$str}     = 'String of digits';
%hash{$int_str} = 'Dualvar';

say &quot;There are &quot;, %hash.elems, &quot; elements in the hash&quot;;

# this calls the .gist method, sorta like a dumper routine
%hash.say;
</code></pre>

<p>现在我能在该哈希中看到 3 个元素了。这个哈希以 <code>.gist</code> 形式打印出来后看起来有点奇怪，因为它有 4 个键都是 4:</p>

<pre><code class="language-perl6">There are 3 elements in the hash
{4 =&gt; Dualvar, 4 =&gt; Plain old number, 4 =&gt; String of digits}
</code></pre>

<p>使用 <code>.perl</code> 方法能看到背后的真相：</p>

<pre><code class="language-perl6">%hash.perl.say;
</code></pre>

<p>现在我能看到该哈希中有 3 种不同的对象：</p>

<pre><code class="language-perl6">There are 3 elements in the hash
(my Any %{Any} = IntStr.new(4, &quot;4&quot;) =&gt; &quot;Dualvar&quot;, 4 =&gt; &quot;Plain old number&quot;, &quot;4&quot; =&gt; &quot;String of digits&quot;)
</code></pre>

<p>用上对象哈希后，测试存在性就有点不同了。它使用 <code>.WHICH</code> 方法，使用对象相等操作符 <code>===</code> 来比较键。</p>

<pre><code class="language-perl6">use v6;

my Int    $int     = 4;
my IntStr $int_str = &lt;4&gt;;  # Allomorph

my %hash{Any};
%hash{$int}     = 'Plain old number';
%hash{$int_str} = 'Dualvar';

my $other_int = 4;

# what are these things?
say &quot;int: &quot; ~ $int.WHICH;
say &quot;other: &quot; ~ $other_int.WHICH;

# are they the same?
say $int === $other_int ?? 'Same object' !! 'Different object';

# is it in the hash?
say %hash{$other_int}:exists ?? 'Other int exists in hash' !! 'Other int not there';

say %hash{&quot;4&quot;}:exists ?? '&quot;4&quot; exists in hash' !! '&quot;4&quot; not there';
</code></pre>

<p>我可以看到 <code>$int</code> 和 <code>$other_int</code> 看起来像同一个对象。然而，键 &ldquo;4&rdquo; 不在该哈希中即使它拥有同样的字符串 &ldquo;4&rdquo;:</p>

<pre><code>int: Int|4
other: Int|4
Same object
Other int exists in hash
&quot;4&quot; not there
</code></pre>

<p>如果它和我的期望不一样这看起来就可能有点奇怪。</p>

<p>我们来看尖括号版本的引号单词操作符，<code>&lt;...&gt;</code>。这种形式的引号单词创建了 <em>allomorphs</em>(字素变体)。当它看见像数字那样的东西时，它创建继承自数字和字符串两边的诸如 <code>IntStr</code> 的东西。这意味着，尽管它作为一个对象哈希，但是它拥有一个很特殊的形式。在下面这个哈希对象中，我使用 <code>&lt;&gt;</code> 引号在键 4 的周围创建了一个元素。然后我测试字符串 &ldquo;4&rdquo; 是否在该哈希中：</p>

<pre><code class="language-perl6">use v6;

my %hash{Any};

%hash = 1;

say %hash{&quot;4&quot;}:exists ?? 'Exists in hash' !! 'Not there';
</code></pre>

<p>我看到它并没有在该哈希中：</p>

<pre><code>Not there
</code></pre>

<p>这个语素变体版本是一个　IntStr, 其中 &ldquo;4&rdquo; 是一个　Str。它们不是同一个对象，所以后者不是该哈希中的键。</p>

<p>如果这正是你所期待的，这不是一个大问题。但是，考虑一个更有用的只允许某种类型的对象的对象哈希。也许我想让它们都是 <code>Date</code> 类型的对象。下面这种方式不能工作：</p>

<pre><code class="language-perl6">my %hash{Date};
%hash{Date.new(now)} =  ( event =&gt; 'Something cool', rating =&gt; '6 stars' );

my $too_cool_for_your_api = '12-03-2016';
say %hash{ $too_cool_for_your_api };
</code></pre>

<p>当我试图绕过约束的时候，我得到一个异常：</p>

<pre><code>Type check failed in binding to key; expected Date but got Str (&quot;12-03-2016&quot;)
</code></pre>

<p>Perl 6 让我强迫其他程序员按照我需要的方式构造哈希键。</p>

<p>最后 Zoffix Znet 补充了一句：</p>

<p>你还可以约束值的类型。申明变量的时候把类型放在变量名前面就好了：</p>

<pre><code>my Date %hash{Int}; # use Int keys and accept only Date values

%hash{42} = 72; # Type check failed in binding to assignval; expected Date but got Int (72)
</code></pre>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
      <p>ohmysummer ❤ Perl 6</p>
    
    
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
