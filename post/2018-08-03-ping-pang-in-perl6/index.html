<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="ohmysummer">
    <meta name="description" content="ohmysummer&#39;s personal website">
    <meta name="keywords" content="Perl6,Rakudo">

    <base href="http://ohmysummer.github.io/">
    <title>
  Ping Pang in Perl6 · 焉知非鱼
</title>

    <link rel="canonical" href="http://ohmysummer.github.io/post/2018-08-03-ping-pang-in-perl6/">

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Merriweather:300,700|Source+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.cd087ace86754b082dec94545567f8361cba42e84f8e15edbc4a9f6e52bd1f6a.css" integrity="sha256-zQh6zoZ1Swgt7JRUVWf4Nhy6QuhPjhXtvEqfblK9H2o=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://ohmysummer.github.io/css/style.css">
    

    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.49" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://ohmysummer.github.io/">
      焉知非鱼
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/post">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/categories">归档</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/page/about/">关于</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/tags">标签</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>Ping Pang in Perl6</h1>
    </header>

    

<h1 id="ping-pang-in-perl-6">Ping Pang in Perl 6</h1>

<p>使用 channels 在线程之间传递消息是一种管理并发的简单方法。</p>

<p>一位朋友最近向我展示了一个很酷的程序，用 elixir 来演示消息传递 - 两个线程通过来回传递递增的数字来计数。快速搜索出现了一些<a href="https://github.com/oelizondo/pingpong/blob/master/pingpong.exs">例子</a>。</p>

<p>我决定在 Perl 6 中实现这个。这就是我想出来的→</p>

<pre><code class="language-perl6">my ($ping, $pong) = Channel.new xx 2;
 
sub ping {
   while $ping.receive -&gt; $n {
       say &quot;ping $n (thread #{$*THREAD.id})&quot;;
       $pong.send: $n + 1;
   }
}
 
sub pong {
   while $pong.receive -&gt; $n {
       last if $n &gt;= 5;
       say &quot;pong $n (thread #{$*THREAD.id})&quot;;
       $ping.send: $n + 1;
   }
}
 
$ping.send: 1;
await Promise.anyof(
 (start ping),
 (start pong)
);
</code></pre>

<p><code>$ping</code> 和 <code>$pong</code> 都是 channel。子程序 ping 和 pong 从它们相应的 channel 接收并发送到另一个。</p>

<p>如果你运行它，你会看到从 1 到 5 的数字。</p>

<pre><code>ping 1 (thread #3)
pong 2 (thread #4)
ping 3 (thread #3)
pong 4 (thread #4)
ping 5 (thread #3)
</code></pre>

<p>接下来我想封装一些常见的行为。这是一个发送和接收的乒乓球“玩家” - 所以让我们创建一个 <strong>Player</strong> 类。</p>

<p>我想 “ping” 和 “pong” 是每个玩家的球拍发出的声音，因为他们击球，所以我添加了一个 <code>$.sound</code> 属性。并且 <code>$.opponent</code> 属性代表每个玩家的对手。</p>

<p><code>$.channel</code> 是处理（即方法委派）发送和接收方法的另一个属性。</p>

<pre><code class="language-perl6">class Player {
    has $.sound;
    has $.opponent is rw;
    has $.channel handles &lt;send receive&gt; = Channel.new;
    has $.promise;
    method play {
        $!promise =
         start {
            while self.receive -&gt; $n {
                last if $n == 6;
                say &quot;$.sound $n (thread #{$*THREAD.id})&quot;;
                $.opponent.send: $n + 1;
            }
        }
    }
}
 
my ($ping,$pong) = &lt;ping pong&gt;.map: { Player.new(:$^sound) }
($ping, $pong)&gt;&gt;.opponent = ($pong, $ping);
($ping, $pong)&gt;&gt;.play;
$ping.send: 1;
await $pong.promise;
</code></pre>

<p>运行这个给我们类似于最后一个：</p>

<pre><code>ping 1 (thread #3)
pong 2 (thread #4)
ping 3 (thread #3)
pong 4 (thread #4)
ping 5 (thread #3)
</code></pre>

<p>现在让我们更像乒乓球：</p>

<ul>
<li>有四分之一的机会错过球。</li>
<li>第一个到第一个胜利，你必须赢两个。</li>
<li>每五点，切换谁服务。</li>
</ul>

<pre><code class="language-perl6">class Player {
    has $.sound handles 'Str';
    has $.opponent is rw;
    has $.channel handles &lt;send receive&gt; = Channel.new;
    has $.promise;
 
    method missed {
        $.promise.status == Kept;
    }
    method play {
        $!promise = start {
            while self.receive -&gt; $n {
                last if (^4).pick==1;
                print &quot;{$.sound} $n &quot;;
                self.opponent.send: $n + 1;
            }
        }
    }
}
 
my @sounds = &lt;ping pong&gt;;
my @players = @sounds.map: { Player.new(:$^sound) }
@players».opponent «=» @players.rotate;
my $serving = @players[0];
my %score = @players Z=&gt; 0 xx *;
 
@players».play;
repeat {
  $serving.send(1);
  await Promise.anyof(@players».promise);
  with @players.first({ .missed }) -&gt; $missed {
      print &quot;Miss by $missed.&quot;;
      %score{$missed.opponent}++;
      $missed.play;
  }
  say &quot; Score: &quot; ~ %score{@sounds}.join(' to ');
  if %score.values.sum %% 5 {
      $serving .= opponent;
      say &quot;--Now serving: $serving--&quot;;
  }
} until %score.values.any &gt;= 11 and (abs [-] %score.values) &gt;= 2;
 
say &quot;\nWinner: &quot; ~ %score.invert.Hash{ %score.values.max };
say &quot;Final Score: &quot; ~ %score{@sounds}.join(' to ');
</code></pre>

<pre><code>ping 1 pong 2 ping 3 pong 4 Miss by ping. Score: 0 to 1
ping 1 pong 2 ping 3 pong 4 ping 5 Miss by pong. Score: 1 to 1
ping 1 Miss by pong. Score: 2 to 1
ping 1 pong 2 Miss by ping. Score: 2 to 2
ping 1 pong 2 ping 3 pong 4 ping 5 pong 6 ping 7 pong 8 ping 9 Miss by pong. Score: 3 to 2
--Now serving: pong--
pong 1 ping 2 pong 3 ping 4 Miss by pong. Score: 4 to 2
pong 1 ping 2 pong 3 ping 4 pong 5 Miss by ping. Score: 4 to 3
pong 1 Miss by ping. Score: 4 to 4
pong 1 Miss by ping. Score: 4 to 5
pong 1 ping 2 pong 3 ping 4 pong 5 Miss by ping. Score: 4 to 6
--Now serving: ping--
ping 1 pong 2 Miss by ping. Score: 4 to 7
ping 1 pong 2 Miss by ping. Score: 4 to 8
ping 1 pong 2 ping 3 pong 4 ping 5 Miss by pong. Score: 5 to 8
ping 1 Miss by pong. Score: 6 to 8
ping 1 pong 2 ping 3 Miss by pong. Score: 7 to 8
--Now serving: pong--
Miss by pong. Score: 8 to 8
Miss by pong. Score: 9 to 8
pong 1 ping 2 pong 3 Miss by ping. Score: 9 to 9
pong 1 ping 2 pong 3 ping 4 pong 5 ping 6 pong 7 ping 8 Miss by pong. Score: 10 to 9
pong 1 ping 2 Miss by pong. Score: 11 to 9
--Now serving: ping--

Winner: ping
Final Score: 11 to 9
</code></pre>

<p>一些评论和注意事项：</p>

<ul>
<li><strong>$.sound</strong> 处理字符串化。</li>
<li>如果 <em>promise</em> 是 <strong>Kept</strong> 的，循环退出，所以玩家错过了。</li>
<li><strong>&gt;&gt;</strong> 与 » 相同 - 这就像 <strong>map</strong>。</li>
<li><strong>在@sounds</strong> 中添加另一个条目会设置一个消息传递循环。</li>
</ul>

<h2 id="结论和进一步的想法">结论和进一步的想法</h2>

<ul>
<li>Channel 是在线程之间传递消息的好方法。</li>
<li>Channels 和 Promises 可以是对象的属性。</li>
<li>这对于消息传递的封装很方便。</li>
</ul>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
      <p>ohmysummer ❤ Perl 6</p>
    
    
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
