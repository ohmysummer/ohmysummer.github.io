<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="ohmysummer">
    <meta name="description" content="ohmysummer&#39;s personal website">
    <meta name="keywords" content="Perl6,Rakudo">

    <base href="http://ohmysummer.github.io/">
    <title>
  Roles · 焉知非鱼
</title>

    <link rel="canonical" href="http://ohmysummer.github.io/post/2016-01-21-roles/">

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Merriweather:300,700|Source+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.cd087ace86754b082dec94545567f8361cba42e84f8e15edbc4a9f6e52bd1f6a.css" integrity="sha256-zQh6zoZ1Swgt7JRUVWf4Nhy6QuhPjhXtvEqfblK9H2o=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://ohmysummer.github.io/css/style.css">
    

    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.49" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://ohmysummer.github.io/">
      焉知非鱼
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/post">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/categories">归档</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/page/about/">关于</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/tags">标签</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>Roles</h1>
    </header>

    

<p>Protocol 在 Swift 中是一组方法和属性的集合, 可用于代码复用。 Perl 6 中有与之类似的结构, 叫做 <code>Role</code>, 下面转换一个 Swift 的 Protocol 为 Perl 6 的 Role, 把部门人员的相关信息打印为一个表格:</p>

<h2 id="protocol-in-swift">Protocol in Swift</h2>

<p>　</p>

<pre><code class="language-perl">import UIKit

func padding(amount: Int) -&gt; String {
    var paddingString = &quot;&quot;
    for _ in 0..&lt;amount {
        paddingString += &quot; &quot;
    }
    return paddingString
}

// 协议

protocol TabularDataSource {
    var numberOfRows: Int    { get }
    var numberOfColumns: Int { get }

    func labelForRow(row: Int) -&gt; String        // 行标签
    func labelForColumn(column: Int) -&gt; String  // 列标签

    func itemForRow(row: Int, column: Int) -&gt; Int // 表格中的单元格
}



struct Person {
    let name: String
    let age: Int
    let yearsOfExperience: Int
}

// 让 **Department** 遵守 **TabularDataSource**协议
struct Department: TabularDataSource {
    let name: String
    var people = [Person]()

    init(name: String) {
        self.name = name
    }

    mutating func addPerson(person: Person) {
        people.append(person)
    }

    // 实现协议中声明的属性和方法
    var numberOfRows: Int {
        return people.count
    }

    var numberOfColumns: Int {
        return 2
    }

    func labelForRow(row: Int) -&gt; String {
        return people[row].name
    }

    func labelForColumn(column: Int) -&gt; String {
        switch column {
            case 0: return &quot;Age&quot;
            case 1: return &quot;Years of Experence&quot;
            default: fatalError(&quot;Invalid column!&quot;)
        }
    }

    func itemForRow(row: Int, column: Int) -&gt; Int {
         let person = people[row] // 指定的行
         switch column {
             case 0: return person.age
             case 1: return person.yearsOfExperience
             default:fatalError(&quot;Invalid column!&quot;)
        }
    }
}

var deparment = Department(name: &quot;Engineering&quot;)
deparment.addPerson(Person(name: &quot;Joe&quot;, age: 30, yearsOfExperience: 6))
deparment.addPerson(Person(name: &quot;Karen&quot;, age: 40, yearsOfExperience: 18))
deparment.addPerson(Person(name: &quot;Fred&quot;, age: 50, yearsOfExperience: 20))

// 传入一个数据源
func printTable(dataSource: TabularDataSource) {
    let rowLabels = (0 ..&lt; dataSource.numberOfRows).map { dataSource.labelForRow($0) }
    let columnLabels = (0 ..&lt; dataSource.numberOfColumns).map { dataSource.labelForColumn($0) }

    // 创建一个数组存储每个行标签的宽度
    let rowLabelWidths = rowLabels.map { $0.characters.count }

    // 限定行标签的最大长度
    guard let maxRowLabelWidth = rowLabelWidths.maxElement() else {
        return
    }

    // 创建第一行, 包含列标题
    var firstRow = padding(maxRowLabelWidth) + &quot; |&quot;

    // 跟踪每列的宽度
    var columnWidths = [Int]()

    for columnLabel in columnLabels {
        let columnHeader = &quot; \(columnLabel) |&quot;
        firstRow += columnHeader
        columnWidths.append(columnHeader.characters.count)
    }
    print(firstRow)

    for i in 0 ..&lt; dataSource.numberOfRows {
        let paddingAmount = maxRowLabelWidth - rowLabelWidths[i]
        var out = rowLabels[i] + padding(paddingAmount) + &quot; |&quot;

        for j in 0 ..&lt; dataSource.numberOfColumns {
            let item = dataSource.itemForRow(i, column: j)
            let itemString = &quot; \(item) |&quot;
            let paddingAmount = columnWidths[j] - itemString.characters.count
            out += padding(paddingAmount) + itemString
        }
        print(out)
    }
}

printTable(deparment)

</code></pre>

<p>其中的计算属性在 Perl 6 中可以使用重写属性的方法来完成。</p>

<h3 id="role-in-perl-6">Role in Perl 6</h3>

<pre><code class="language-perl">use v6;

sub padding(Int $amount) {
    my $paddingString = &quot;&quot;;
    $paddingString ~= &quot; &quot; for  0 ..^ $amount;
    return $paddingString;
}

# 声明一个接口, 只定义了方法和属性, 没有做实现
role TabularDataSource {
    has $.numberOfRows is rw;
    has $.numberOfColumns is rw;

    method labelForRow(Int $row)             { ... }
    method labelForColumn(Int $column)       { ... }
    method itemForRow(Int $row, Int $column) { ... }
}

class Person {
    has Str $.name;
    has Int $.age;
    has Int $.yearsOfExperience;
}

class Department does TabularDataSource {
    has $.name;
    has @.people;

    method new(Str $name) {
        self.bless(name =&gt; $name);
    }
    # 实现接口中的方法

    # 重写方法 has $.numberOfRows 其实是 has $!numberOfRows 加上 method numberOfRows() { ... } 方法。
    method numberOfRows() {
        return @!people.elems;
    }

    method numberOfColumns() {
        return 2;
    }

    method addPerson(Person $person) is rw {
        @!people.append($person);
    }
    # 如果类遵守了某个 role 但是未实现其中的方法, 则会报错如下:
    # Method 'labelForRow' must be implemented by Department because it is required by a role
    method labelForRow(Int $row) {
        return @!people[$row].name;
    }

    method labelForColumn(Int $column) {
        given $column {
            when 0  { return &quot;Age&quot; }
            when 1  { return &quot;Years of Experence&quot; }
            default { die(&quot;Invalid column!&quot;)}
        }
    }

    method itemForRow(Int $row, Int $column) {
        my $person = @!people[$row];
        given $column {
            when 0  { return $person.age               }
            when 1  { return $person.yearsOfExperience }
            default { die(&quot;Invalid column&quot;)            }
        }
    }
}

my $department = Department.new(&quot;Engineering&quot;);
$department.addPerson(Person.new(name =&gt; &quot;Joe&quot;,   age =&gt; 30, yearsOfExperience =&gt; 6));
$department.addPerson(Person.new(name =&gt; &quot;Karen&quot;, age =&gt; 40, yearsOfExperience =&gt; 18));
$department.addPerson(Person.new(name =&gt; &quot;Fred&quot;,  age =&gt; 50, yearsOfExperience =&gt; 20));

sub printTable(TabularDataSource $dataSource) {
   my @rowLabels = (0 ..^ $dataSource.numberOfRows ).map: { $dataSource.labelForRow($_)};
   my @columnLabels = (0 ..^ $dataSource.numberOfColumns).map: {$dataSource.labelForColumn($_)};

   my @rowLabelWidths = @rowLabels.map: {$_.chars};
   my $maxRowLabelWidth = @rowLabelWidths.max // return;

   my $firstRow = padding($maxRowLabelWidth) ~ &quot; |&quot;;
   my @columnWidths;

   for @columnLabels -&gt; $columnLabel {
       my $columnHeader = &quot; $columnLabel |&quot;;
       $firstRow ~= $columnHeader;
       @columnWidths.append($columnHeader.chars);
   }
   say($firstRow);

   for 0 ..^ $dataSource.numberOfRows -&gt; $i {
        my $paddingAmount = $maxRowLabelWidth - @rowLabelWidths[$i];
        my $out = @rowLabels[$i] ~ padding($paddingAmount) ~ &quot; |&quot;;

        for 0 ..^ $dataSource.numberOfColumns -&gt; $j {
            my $item = $dataSource.itemForRow($i, $j);
            my $itemString = &quot; $item |&quot;;
            my $paddingAmount = @columnWidths[$j] - $itemString.chars;
            $out ~= padding($paddingAmount) ~ $itemString;
        }
        say($out);
   }

}

printTable($department);

</code></pre>

<p>role 中的 <code>{ ... }</code> 是 yadayada 操作符, 起占位作用, 表示方法会在别处实现。类中的方法同样也可以这样声明。</p>

<p>最后输出:</p>

<pre><code class="language-perl">      | Age | Years of Experence |
Joe   |  30 |                  6 |
Karen |  40 |                 18 |
Fred  |  50 |                 20 |
</code></pre>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
      <p>ohmysummer ❤ Perl 6</p>
    
    
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
