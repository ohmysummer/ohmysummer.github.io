<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="ohmysummer">
    <meta name="description" content="ohmysummer&#39;s personal website">
    <meta name="keywords" content="Perl6,Rakudo">

    <base href="http://ohmysummer.github.io/">
    <title>
  Going over the Bridge, part 2. Let’s get rid of it · 焉知非鱼
</title>

    <link rel="canonical" href="http://ohmysummer.github.io/post/2018-02-12-going-over-the-bridge-part-2/">

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Merriweather:300,700|Source+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.cd087ace86754b082dec94545567f8361cba42e84f8e15edbc4a9f6e52bd1f6a.css" integrity="sha256-zQh6zoZ1Swgt7JRUVWf4Nhy6QuhPjhXtvEqfblK9H2o=" crossorigin="anonymous" media="screen" />
    

    

    

    
      <link rel="stylesheet" href="http://ohmysummer.github.io/css/style.css">
    

    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://ohmysummer.github.io/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.49" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="http://ohmysummer.github.io/">
      焉知非鱼
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/post">博客</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/categories">归档</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/page/about/">关于</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/tags">标签</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container page">
  <article>
    <header>
      <h1>Going over the Bridge, part 2. Let’s get rid of it</h1>
    </header>

    

<p>今天，我们继续在 Rakudo Perl 6 中使用 <code>Bridge</code> 方法。昨天，我们在几个预定义的数据类型中看到了方法的定义。现在是时候看看如何使用该方法。</p>

<p><img src="https://inperl6.files.wordpress.com/2018/02/bridge1.jpg" alt="img" /></p>

<h2 id="里面有什么">里面有什么?</h2>

<p>该方法的主要用途在 <code>Real</code> 角色中，该角色包含以下一组方法：</p>

<pre><code class="language-perl6">method sqrt() { self.Bridge.sqrt }
method rand() { self.Bridge.rand }
method sin() { self.Bridge.sin }
method asin() { self.Bridge.asin }
method cos() { self.Bridge.cos }
method acos() { self.Bridge.acos }
method tan() { self.Bridge.tan }
method atan() { self.Bridge.atan }
. . .
method sec() { self.Bridge.sec }
method asec() { self.Bridge.asec }
method cosec() { self.Bridge.cosec }
method acosec() { self.Bridge.acosec }
method cotan() { self.Bridge.cotan }
method acotan() { self.Bridge.acotan }
method sinh() { self.Bridge.sinh }
method asinh() { self.Bridge.asinh }
method cosh() { self.Bridge.cosh }
method acosh() { self.Bridge.acosh }
method tanh() { self.Bridge.tanh }
method atanh() { self.Bridge.atanh }
method sech() { self.Bridge.sech }
method asech() { self.Bridge.asech }
method cosech() { self.Bridge.cosech }
method acosech() { self.Bridge.acosech }
method cotanh() { self.Bridge.cotanh }
method acotanh() { self.Bridge.acotanh }
method floor() { self.Bridge.floor }
method ceiling() { self.Bridge.ceiling }
. . .
multi method log(Real:D: ) { self.Bridge.log }
multi method exp(Real:D: ) { self.Bridge.exp }
</code></pre>

<p>有几个例程具有不同的模式，其中该方法被调用两次：一次用于获得所需的功能;其次是强制价值：</p>

<pre><code class="language-perl6">multi method atan2(Real $x = 1e0) { self.Bridge.atan2($x.Bridge) }
multi method atan2(Cool $x = 1e0) { self.Bridge.atan2($x.Numeric.Bridge) }
multi method atan2(Real $x = 1e0) { self.Bridge.atan2($x.Bridge) }
multi method atan2(Cool $x = 1e0) { self.Bridge.atan2($x.Numeric.Bridge) }
multi method log(Real:D: Real $base) { self.Bridge.log($base.Bridge) }
. . .
multi sub atan2(Real \a, Real \b = 1e0) { a.Bridge.atan2(b.Bridge) }
</code></pre>

<p>正如你所看到的，<code>atan2</code> 函数被定义为方法和子例程。为了更多地混淆你，它有两个版本：</p>

<pre><code class="language-perl6">proto sub atan2($, $?) {*}
multi sub atan2(Real \a, Real \b = 1e0) { a.Bridge.atan2(b.Bridge) }
# should really be (Cool, Cool), and then (Cool, Real) and (Real, Cool)
# candidates, but since Int both conforms to Cool and Real, we'd get lots
# of ambiguous dispatches. So just go with (Any, Any) for now.
multi sub atan2( \a, \b = 1e0) { a.Numeric.atan2(b.Numeric) }
</code></pre>

<p>最后，一些类型转换的方法：</p>

<pre><code class="language-perl6">method Bridge(Real:D:) { self.Num }
method Int(Real:D:) { self.Bridge.Int }
method Num(Real:D:) { self.Bridge.Num }
multi method Str(Real:D:) { self.Bridge.Str }
method Rat(Real:D: Real $epsilon = 1.0e-6) { self.Bridge.Rat($epsilon) }
</code></pre>

<p>注意 <code>Real</code> 角色的 <code>Bridge</code> 方法返回一个 <code>Num</code> 值。</p>

<p>一些中缀方法也在使用该方法：</p>

<pre><code class="language-perl6">multi sub infix:&lt;+&gt;(Real \a, Real \b) { a.Bridge + b.Bridge }
multi sub infix:&lt;-&gt;(Real \a, Real \b) { a.Bridge - b.Bridge }
multi sub infix:&lt;*&gt;(Real \a, Real \b) { a.Bridge * b.Bridge }
multi sub infix:&lt;/&gt;(Real \a, Real \b) { a.Bridge / b.Bridge }
multi sub infix:&lt;%&gt;(Real \a, Real \b) { a.Bridge % b.Bridge }
multi sub infix:&lt;**&gt;(Real \a, Real \b) { a.Bridge ** b.Bridge }
multi sub infix:«&lt;=&gt;»(Real \a, Real \b) { a.Bridge &lt;=&gt; b.Bridge }
multi sub infix:&lt;==&gt;(Real \a, Real \b) { a.Bridge == b.Bridge }
multi sub infix:«&lt;»(Real \a, Real \b) { a.Bridge &lt; b.Bridge }
multi sub infix:«&lt;=»(Real \a, Real \b) { a.Bridge &lt;= b.Bridge }
multi sub infix:«≤» (Real \a, Real \b) { a.Bridge ≤ b.Bridge }
multi sub infix:«&gt;»(Real \a, Real \b) { a.Bridge &gt; b.Bridge }
multi sub infix:«&gt;=»(Real \a, Real \b) { a.Bridge &gt;= b.Bridge }
multi sub infix:«≥» (Real \a, Real \b) { a.Bridge ≥ b.Bridge }
multi sub prefix:&lt;-&gt;(Real:D \a) { -a.Bridge }
</code></pre>

<h2 id="追踪调用">追踪调用</h2>

<p>要查看 <code>Bridge</code> 方法何时被调用，让我们做一些简单的实验。我添加了几个 <code>nqp::say</code> 调用并运行 REPL 控制台来调用不同类型变量的 <code>sin</code> 方法。</p>

<p>使用 <code>Num</code> 数据类型时，会调用一个直接方法：</p>

<pre><code class="language-perl6">&gt; my Num $n = 1e1; 
10
&gt; $n.sin
Num.sin
</code></pre>

<p>这个方法调用底层的 NQP 函数：</p>

<pre><code class="language-perl6">proto method sin(|) {*}
multi method sin(Num:D: ) {
    nqp::p6box_n(nqp::sin_n(nqp::unbox_n(self)));
}
</code></pre>

<p>使用其他数据类型，您可以通过真实角色出行：</p>

<pre><code class="language-perl6">&gt; my Int $i = 1;
1
&gt; $i.sin
Real.sin
Num.sin

&gt; my Rat $r = 1/2;
0.5
&gt; $r.sin
Real.sin
Num.sin
</code></pre>

<p>如果它们是从内置类型继承的，则可以使用与自己的类型相同的路径：</p>

<pre><code class="language-perl6">&gt; class MyInt is Int {}
&gt; my MyInt $mi = MyInt.new
0
&gt; $mi.sin
Real.sin
Num.sin
</code></pre>

<h2 id="摆脱它">摆脱它</h2>

<p>我修改了所有使用 Rakudo 克隆方法的地方。大多数情况下，他们被直接调用 <code>Num</code> 方法替代。在一些地方，它会导致像 <code>$x.Num.Num</code> 这样的双重调用，当然这些调用也会减少。</p>

<p>使用更新后的代码，所有来自 <code>Roast</code> 的测试都已通过。作为副作用，在某些情况下，速度增加了大约 3％：</p>

<pre><code class="language-perl6">./perl6 -e'for 1..10_000_000 {Int.new(1).sin}'
</code></pre>

<p>这是一个相当广泛的变化，而且还有一件事：当您在新创建的 <code>Real</code> 对象上调用该方法时，会导致无限循环。看起来数字数据类型的错误层次结构是主要原因，但我认为我们至少可以安全地移除 <code>Bridge</code> 方法。</p>

  </article>
</section>


      </div>

      <footer class="footer">
  <section class="container">
    
      <p>ohmysummer ❤ Perl 6</p>
    
    
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
